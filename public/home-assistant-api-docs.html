<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Assistant API æ–‡æ¡£ - Credential Service</title>
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .api-documentation {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .api-section {
            margin-bottom: 2rem;
        }

        .api-section h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .api-section h3 {
            color: var(--gray-700);
            margin-bottom: 1rem;
            margin-top: 1.5rem;
        }

        .api-endpoint {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .endpoint-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--gray-100);
            border-bottom: 1px solid var(--gray-200);
        }

        .method {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: bold;
            font-size: 0.8rem;
            min-width: 60px;
            text-align: center;
        }

        .method.get {
            background: var(--success-color);
            color: white;
        }

        .method.post {
            background: var(--warning-color);
            color: white;
        }

        .method.delete {
            background: var(--danger-color);
            color: white;
        }

        .method.put {
            background: var(--info-color);
            color: white;
        }

        .url {
            font-family: 'Courier New', monospace;
            background: var(--gray-200);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            flex: 1;
        }

        .endpoint-description {
            padding: 1rem;
            color: var(--gray-600);
            font-style: italic;
        }

        .endpoint-example {
            padding: 1rem;
            background: var(--gray-900);
            color: var(--gray-100);
        }

        .endpoint-example pre {
            margin: 0;
            overflow-x: auto;
        }

        .endpoint-example code {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .api-test-results {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 1rem;
            min-height: 100px;
        }

        .test-result {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.25rem;
            border-left: 4px solid;
        }

        .test-result.success {
            background: #f0f9ff;
            border-left-color: var(--success-color);
            color: var(--success-color);
        }

        .test-result.error {
            background: #fef2f2;
            border-left-color: var(--danger-color);
            color: var(--danger-color);
        }

        .test-result.info {
            background: #f0f9ff;
            border-left-color: var(--info-color);
            color: var(--info-color);
        }

        .test-result pre {
            background: var(--gray-100);
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
            overflow-x: auto;
            font-size: 0.8rem;
        }

        .test-result-container {
            margin-top: 1rem;
            background: var(--gray-50);
            border-radius: 0.5rem;
            border: 1px solid var(--gray-200);
            min-height: 50px;
        }

        .filter-section {
            margin: 1rem 0;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 0.5rem;
            border: 1px solid var(--gray-200);
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .filter-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            resize: vertical;
            min-height: 60px;
        }

        .filter-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .test-result-header {
            padding: 0.75rem 1rem;
            background: var(--gray-100);
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
        }

        .test-result-header:hover {
            background: var(--gray-200);
        }

        .test-result-content {
            padding: 1rem;
            display: none;
        }

        .test-result-content.expanded {
            display: block;
        }

        .test-result-toggle {
            font-size: 1.2rem;
            transition: transform 0.2s ease;
        }

        .test-result-toggle.expanded {
            transform: rotate(90deg);
        }

        .endpoint-input {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 0.5rem;
            border: 1px solid #e9ecef;
        }

        .endpoint-input label {
            font-weight: 600;
            color: var(--gray-700);
            margin-right: 0.5rem;
        }

        .endpoint-input input, .endpoint-input select {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .endpoint-input input:focus, .endpoint-input select:focus {
            outline: 0;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .endpoint-input button {
            margin-right: 10px;
            margin-top: 10px;
        }
        
        .device-list {
            margin-top: 10px;
        }
        
        .device-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
        }
        
        .device-item div {
            margin: 2px 0;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .toc {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .toc h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .toc ul {
            list-style: none;
        }

        .toc li {
            margin-bottom: 0.5rem;
        }

        .toc a {
            color: var(--gray-600);
            text-decoration: none;
            transition: color 0.3s;
        }

        .toc a:hover {
            color: var(--primary-color);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
            text-decoration: none;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            transition: background 0.3s;
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .endpoint-header {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
        }

        .matched-device {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        .matched-device div {
            margin: 0.25rem 0;
        }

        .matched-device strong {
            color: var(--primary-color);
        }

        /* JSONè¾“å…¥æ¡†æ ·å¼ */
        .endpoint-input textarea {
            width: 100%;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            background-color: #f8f9fa;
            transition: border-color 0.3s ease;
        }

        .endpoint-input textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .endpoint-input textarea:hover {
            border-color: #999;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
            border-color: #117a8b;
        }

        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
            border-color: #d39e00;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--gray-50);
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid var(--gray-200);
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--gray-600);
        }

        .stat-value {
            font-weight: 600;
            color: var(--primary-color);
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 0.8em;
            border-radius: 3px;
            background-color: var(--gray-200);
            color: var(--gray-700);
        }

        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .filter-controls {
            background-color: var(--gray-50);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--gray-200);
            margin-bottom: 10px;
        }

        .parameter-section h4 {
            color: var(--gray-700);
            margin-bottom: 10px;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <a href="/" class="back-link">
                â† è¿”å›ä¸»ç•Œé¢
            </a>
            <h1>ğŸ  Home Assistant API æ–‡æ¡£</h1>
            <p>å®Œæ•´çš„Home Assistant APIæ¥å£è¯´æ˜å’Œæµ‹è¯•å·¥å…·</p>
        </div>

        <!-- APIæ–‡æ¡£ -->
        <div class="api-documentation">
            <!-- ç›®å½• -->
            <div class="toc">
                <h3>ğŸ“‹ ç›®å½•</h3>
                <ul>
                    <li><a href="#overview">æ¦‚è¿°</a></li>
                    <li><a href="#authentication">è®¤è¯</a></li>
                    <li><a href="#basic-info">åŸºç¡€ä¿¡æ¯</a></li>
                    <li><a href="#enhanced-states">å¢å¼ºçŠ¶æ€æ•°æ®</a></li>
                    <li><a href="#entity-registry">å®ä½“æ³¨å†Œè¡¨</a></li>
                    <li><a href="#devices">è®¾å¤‡åˆ—è¡¨</a></li>
                    <li><a href="#rooms">æˆ¿é—´åˆ—è¡¨</a></li>
                    <li><a href="#floors">æ¥¼å±‚åˆ—è¡¨</a></li>
                    <li><a href="#services">æœåŠ¡è°ƒç”¨</a></li>
                    <li><a href="#device-matching">æ™ºèƒ½è®¾å¤‡åŒ¹é…</a></li>
                    <li><a href="#control-device-matching">æ§åˆ¶è®¾å¤‡åŒ¹é…</a></li>
                    <li><a href="#batch-control">æ‰¹é‡è®¾å¤‡æ§åˆ¶</a></li>
                </ul>
            </div>

            <!-- æ¦‚è¿° -->
            <div class="api-section" id="overview">
                <h2>ğŸ“– æ¦‚è¿°</h2>
                <p>Home Assistant APIå…è®¸æ‚¨é€šè¿‡RESTfulæ¥å£ä¸Home Assistantå®ä¾‹è¿›è¡Œäº¤äº’ã€‚æœ¬æœåŠ¡æä¾›äº†å®Œæ•´çš„APIå°è£…ï¼Œæ”¯æŒè·å–å®ä½“çŠ¶æ€ã€è°ƒç”¨æœåŠ¡ã€ç®¡ç†é…ç½®ç­‰åŠŸèƒ½ã€‚</p>
                
                <h3>ğŸ”§ å‰ç½®æ¡ä»¶</h3>
                <ul>
                    <li>Home Assistantå®ä¾‹æ­£åœ¨è¿è¡Œ</li>
                    <li>å·²åˆ›å»ºé•¿æœŸè®¿é—®ä»¤ç‰Œï¼ˆLong-lived Access Tokenï¼‰</li>
                    <li>åœ¨Credential Serviceä¸­é…ç½®äº†Home Assistantå‡­æ®</li>
                </ul>
            </div>

            <!-- è®¤è¯ -->
            <div class="api-section" id="authentication">
                <h2>ğŸ” è®¤è¯</h2>
                <p>æ‰€æœ‰APIè¯·æ±‚éƒ½éœ€è¦åœ¨Credential Serviceä¸­é…ç½®Home Assistantå‡­æ®ï¼š</p>
                <ul>
                    <li><strong>access_token</strong>: Home Assistanté•¿æœŸè®¿é—®ä»¤ç‰Œ</li>
                    <li><strong>base_url</strong>: Home Assistantå®ä¾‹çš„URLï¼ˆåŒ…å«åè®®å’Œç«¯å£ï¼‰</li>
                </ul>
                
                <div class="api-endpoint">
                    <div class="endpoint-header">
                        <span class="method post">POST</span>
                        <span class="url">/api/home_assistant/home_assistant/test-connection</span>
                        <button class="btn btn-sm btn-primary" onclick="testApi('POST', '/api/home_assistant/home_assistant/test-connection', null, 'test-connection-test')">æµ‹è¯•</button>
                    </div>
                    <div class="endpoint-description">æµ‹è¯•Home Assistantè¿æ¥å’Œè®¤è¯</div>
                    <div class="endpoint-example">
                        <pre><code>curl -X POST http://localhost:3000/api/home_assistant/home_assistant/test-connection</code></pre>
                    </div>
                    <div id="test-connection-test" class="test-result-container"></div>
                </div>
            </div>

            <!-- åŸºç¡€ä¿¡æ¯ -->
            <div class="api-section" id="basic-info">
                <h2>ğŸ“Š åŸºç¡€ä¿¡æ¯</h2>
                
                <div class="api-endpoint">
                    <div class="endpoint-header">
                        <span class="method get">GET</span>
                        <span class="url">/api/home_assistant/home_assistant/config</span>
                        <button class="btn btn-sm btn-primary" onclick="testApi('GET', '/api/home_assistant/home_assistant/config', null, 'config-test')">æµ‹è¯•</button>
                    </div>
                    <div class="endpoint-description">è·å–Home Assistanté…ç½®ä¿¡æ¯</div>
                    <div class="endpoint-example">
                        <pre><code>curl -X GET http://localhost:3000/api/home_assistant/home_assistant/config</code></pre>
                    </div>
                    <div id="config-test" class="test-result-container"></div>
                </div>

                <div class="api-endpoint">
                    <div class="endpoint-header">
                        <span class="method get">GET</span>
                        <span class="url">/api/home_assistant/home_assistant/access-token</span>
                        <button class="btn btn-sm btn-primary" onclick="testApi('GET', '/api/home_assistant/home_assistant/access-token', null, 'access-token-test')">æµ‹è¯•</button>
                    </div>
                    <div class="endpoint-description">è·å–å½“å‰é…ç½®çš„Access Tokenä¿¡æ¯</div>
                    <div class="endpoint-example">
                        <pre><code>curl -X GET http://localhost:3000/api/home_assistant/home_assistant/access-token</code></pre>
                    </div>
                    <div id="access-token-test" class="test-result-container"></div>
                </div>

                <div class="api-endpoint">
                    <div class="endpoint-header">
                        <span class="method get">GET</span>
                        <span class="url">/api/home_assistant/home_assistant/states</span>
                        <button class="btn btn-sm btn-primary" onclick="testApi('GET', '/api/home_assistant/home_assistant/states', null, 'states-test')">æµ‹è¯•</button>
                    </div>
                    <div class="endpoint-description">è·å–æ‰€æœ‰å®ä½“çŠ¶æ€</div>
                    <div class="endpoint-example">
                        <pre><code>curl -X GET http://localhost:3000/api/home_assistant/home_assistant/states</code></pre>
                    </div>
                    <div id="states-test" class="test-result-container"></div>
                </div>

            </div>

            <!-- å¢å¼ºçŠ¶æ€æ•°æ® -->
            <div class="api-section" id="enhanced-states">
                <h2>ğŸš€ å¢å¼ºçŠ¶æ€æ•°æ®</h2>
                <p>è·å–é›†æˆäº†è®¾å¤‡ä¿¡æ¯ã€æˆ¿é—´ä¿¡æ¯å’Œæ¥¼å±‚ä¿¡æ¯çš„å®Œæ•´å®ä½“çŠ¶æ€æ•°æ®ã€‚è¯¥APIå°†statesã€entity registryã€deviceså’Œroomså››ä¸ªæ•°æ®æºçš„ä¿¡æ¯åˆå¹¶ï¼Œæä¾›æœ€å…¨é¢çš„å®ä½“çŠ¶æ€è§†å›¾ã€‚</p>
                
                <div class="api-endpoint">
                    <div class="endpoint-header">
                        <span class="method get">GET</span>
                        <span class="url">/api/home_assistant/home_assistant/enhanced-states</span>
                        <button class="btn btn-sm btn-primary" onclick="testApi('GET', '/api/home_assistant/home_assistant/enhanced-states', null, 'enhanced-states-test')">æµ‹è¯•</button>
                    </div>
                    <div class="endpoint-description">
                        è·å–å¢å¼ºçš„å®ä½“çŠ¶æ€ä¿¡æ¯
                        <br>
                        <small class="text-muted">ğŸ“¡ é›†æˆå®ä½“æ³¨å†Œè¡¨ã€è®¾å¤‡ä¿¡æ¯å’Œæˆ¿é—´ä¿¡æ¯çš„å®Œæ•´çŠ¶æ€æ•°æ®</small>
                    </div>
                    <div class="endpoint-example">
                        <pre><code>curl -X GET http://localhost:3000/api/home_assistant/home_assistant/enhanced-states</code></pre>
                    </div>
                    
                    <h3>ğŸ” ç­›é€‰å‚æ•°</h3>
                    <div class="filter-section">
                        <div class="filter-group">
                            <label for="area-names-filter">åŒºåŸŸåç§°ç­›é€‰ (area_names):</label>
                            <textarea id="area-names-filter" placeholder='["Living Room", "Kitchen", "Bedroom"]' rows="2"></textarea>
                            <small class="text-muted">è¾“å…¥JSONæ•°ç»„æ ¼å¼çš„åŒºåŸŸåç§°ï¼Œæ”¯æŒæ¨¡ç³ŠåŒ¹é…</small>
                        </div>
                        
                        <div class="filter-group">
                            <label for="device-types-filter">è®¾å¤‡ç±»å‹ç­›é€‰ (device_types):</label>
                            <textarea id="device-types-filter" placeholder='["light", "sensor", "switch"]' rows="2"></textarea>
                            <small class="text-muted">è¾“å…¥JSONæ•°ç»„æ ¼å¼çš„è®¾å¤‡ç±»å‹ï¼Œæ”¯æŒæ¨¡ç³ŠåŒ¹é…</small>
                        </div>
                        
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="testEnhancedStatesWithFilters()">åº”ç”¨ç­›é€‰æµ‹è¯•</button>
                            <button class="btn btn-secondary" onclick="clearFilters()">æ¸…ç©ºç­›é€‰</button>
                        </div>
                    </div>
                    
                    <div class="api-info">
                        <h3>ğŸ”— æ•°æ®æºé›†æˆ</h3>
                        <ul>
                            <li><strong>States API</strong>: åŸºç¡€å®ä½“çŠ¶æ€å’Œå±æ€§</li>
                            <li><strong>Entity Registry</strong> (WebSocket: config/entity_registry/list): è®¾å¤‡IDå’ŒåŒºåŸŸIDå…³è”</li>
                            <li><strong>Devices API</strong>: è®¾å¤‡åç§°ã€åˆ¶é€ å•†ã€å‹å·ç­‰ä¿¡æ¯</li>
                            <li><strong>Rooms API</strong>: æˆ¿é—´åç§°ã€æ¥¼å±‚IDå’Œæ¥¼å±‚åç§°</li>
                        </ul>

                        <h3>ğŸ“‹ å¢å¼ºä¿¡æ¯å­—æ®µ</h3>
                        <ul>
                            <li><strong>device_id</strong>: è®¾å¤‡ID (æ¥è‡ªentity registry)</li>
                            <li><strong>device_name</strong>: è®¾å¤‡åç§° (æ¥è‡ªdevices API)</li>
                            <li><strong>device_manufacturer</strong>: è®¾å¤‡åˆ¶é€ å•†</li>
                            <li><strong>device_model</strong>: è®¾å¤‡å‹å·</li>
                            <li><strong>device_type</strong>: è®¾å¤‡ç±»å‹ (ä¼˜å…ˆdevice_classï¼Œå…¶æ¬¡entity_idå‰ç¼€)</li>
                            <li><strong>area_id</strong>: åŒºåŸŸID (æ¥è‡ªentity registry)</li>
                            <li><strong>area_name</strong>: åŒºåŸŸåç§° (æ¥è‡ªrooms API)</li>
                            <li><strong>floor_id</strong>: æ¥¼å±‚ID (æ¥è‡ªrooms API)</li>
                            <li><strong>floor_name</strong>: æ¥¼å±‚åç§° (æ¥è‡ªrooms API)</li>
                        </ul>
                        
                        <h3>ğŸ“Š å“åº”æ ¼å¼ç¤ºä¾‹</h3>
                        <pre><code>{
  "success": true,
  "data": {
    "states": [
      {
        "entity_id": "light.living_room_light",
        "state": "on",
        "attributes": {...},
        "last_changed": "2025-09-11T10:30:00.000Z",
        "last_updated": "2025-09-11T10:30:00.000Z",
        "device_id": "abcd1234efgh5678",
        "device_name": "Living Room Light",
        "device_manufacturer": "Philips",
        "device_model": "Hue White",
        "area_id": "living_room",
        "area_name": "Living Room",
        "floor_id": "ground_floor",
        "floor_name": "Ground Floor"
      }
    ],
    "statistics": {
      "total_states": 269,
      "with_device_info": 256,
      "with_room_info": 0,
      "with_floor_info": 0,
      "unique_devices": 96,
      "unique_rooms": 0,
      "unique_floors": 0
    },
    "data_sources": {
      "states": "2025-09-11T02:20:27.404Z",
      "entity_registry": "2025-09-11T02:20:27.778Z",
      "devices": "2025-09-11T02:20:27.697Z",
      "rooms": "2025-09-11T02:20:27.590Z"
    },
    "retrieved_at": "2025-09-11T02:20:27.779Z"
  }
}</code></pre>
                    </div>
                    
                    <h3>ğŸ’¡ ä½¿ç”¨åœºæ™¯</h3>
                    <div class="api-info">
                        <ul>
                            <li><strong>æ™ºèƒ½å®¶å±…åˆ†æ</strong>: æŒ‰æˆ¿é—´ã€æ¥¼å±‚æˆ–è®¾å¤‡åˆ¶é€ å•†åˆ†æè®¾å¤‡çŠ¶æ€</li>
                            <li><strong>è®¾å¤‡ç®¡ç†</strong>: å¿«é€ŸæŸ¥æ‰¾ç‰¹å®šåˆ¶é€ å•†æˆ–å‹å·çš„è®¾å¤‡</li>
                            <li><strong>ç©ºé—´ç®¡ç†</strong>: æŒ‰æ¥¼å±‚æˆ–æˆ¿é—´ç»„ç»‡è®¾å¤‡çŠ¶æ€</li>
                            <li><strong>ç¬¬ä¸‰æ–¹é›†æˆ</strong>: ä¸ºå…¶ä»–ç³»ç»Ÿæä¾›å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</li>
                            <li><strong>æ•°æ®åˆ†æ</strong>: è¿›è¡Œè®¾å¤‡ä½¿ç”¨æ¨¡å¼å’Œç©ºé—´åˆ†å¸ƒåˆ†æ</li>
                        </ul>
                    </div>
                    
                    <div id="enhanced-states-test" class="test-result-container"></div>
                </div>
            </div>

            <!-- å®ä½“æ³¨å†Œè¡¨ -->
            <div class="api-section" id="entity-registry">
                <h2>ğŸ“‹ å®ä½“æ³¨å†Œè¡¨</h2>
                <p>è·å–Home Assistantä¸­çš„å®ä½“æ³¨å†Œè¡¨ä¿¡æ¯ï¼ŒåŒ…å«æ‰€æœ‰å·²æ³¨å†Œå®ä½“çš„è¯¦ç»†å…ƒæ•°æ®ã€‚é€šè¿‡WebSocket API (<code>config/entity_registry/list</code>) è·å–æœ€å®Œæ•´çš„å®ä½“ä¿¡æ¯ã€‚</p>
                
                <div class="api-endpoint">
                    <div class="endpoint-header">
                        <span class="method get">GET</span>
                        <span class="url">/api/home_assistant/home_assistant/entity-registry</span>
                        <button class="btn btn-sm btn-primary" onclick="testEntityRegistryApi('entity-registry-test')">æµ‹è¯•</button>
                    </div>
                    <div class="endpoint-description">
                        è·å–å®ä½“æ³¨å†Œè¡¨åˆ—è¡¨ (WebSocket: config/entity_registry/list)
                        <br>
                        <small class="text-muted">ğŸ“¡ ä¼˜å…ˆä½¿ç”¨WebSocket APIï¼Œå¤±è´¥æ—¶è‡ªåŠ¨fallbackåˆ°REST API</small>
                    </div>
                    <div class="endpoint-example">
                        <pre><code>curl -X GET http://localhost:3000/api/home_assistant/home_assistant/entity-registry</code></pre>
                    </div>
                    
                    <div class="parameter-section">
                        <h4>ğŸ” ç­›é€‰å‚æ•°</h4>
                        <div class="filter-controls">
                            <div style="margin-bottom: 10px;">
                                <label for="entity-domain-filter">å®ä½“åŸŸ (Entity Domain):</label>
                                <select id="entity-domain-filter" style="width: 150px; margin: 0 10px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="light">light (ç¯å…‰)</option>
                                    <option value="switch">switch (å¼€å…³)</option>
                                    <option value="sensor">sensor (ä¼ æ„Ÿå™¨)</option>
                                    <option value="binary_sensor">binary_sensor (äºŒè¿›åˆ¶ä¼ æ„Ÿå™¨)</option>
                                    <option value="climate">climate (ç©ºè°ƒ)</option>
                                    <option value="cover">cover (çª—å¸˜)</option>
                                    <option value="fan">fan (é£æ‰‡)</option>
                                    <option value="lock">lock (é”)</option>
                                    <option value="camera">camera (æ‘„åƒå¤´)</option>
                                    <option value="media_player">media_player (åª’ä½“æ’­æ”¾å™¨)</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label for="entity-platform-filter">å¹³å° (Platform):</label>
                                <input type="text" id="entity-platform-filter" placeholder="ä¾‹å¦‚: mqtt, zigbee2mqtt, esphome" style="width: 200px; margin: 0 10px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label for="entity-device-filter">è®¾å¤‡IDè¿‡æ»¤:</label>
                                <input type="text" id="entity-device-filter" placeholder="è¾“å…¥è®¾å¤‡ID" style="width: 250px; margin: 0 10px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label for="entity-limit">æ˜¾ç¤ºæ•°é‡é™åˆ¶:</label>
                                <input type="number" id="entity-limit" value="20" min="1" max="500" style="width: 80px; margin: 0 10px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                            </div>
                        </div>
                    </div>
                    
                    <div id="entity-registry-test" class="test-result-container"></div>
                </div>
            </div>

            <!-- è®¾å¤‡åˆ—è¡¨ -->
            <div class="api-section" id="devices">
                <h2>ğŸ“± è®¾å¤‡åˆ—è¡¨</h2>
                <p>è·å–Home Assistantä¸­æ³¨å†Œçš„æ‰€æœ‰è®¾å¤‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬è®¾å¤‡IDã€åç§°ã€åˆ¶é€ å•†ã€å‹å·ç­‰è¯¦ç»†ä¿¡æ¯ã€‚</p>
                
                <div class="api-endpoint">
                    <div class="endpoint-header">
                        <span class="method get">GET</span>
                        <span class="url">/api/home_assistant/home_assistant/devices</span>
                        <button class="btn btn-sm btn-primary" onclick="testApi('GET', '/api/home_assistant/home_assistant/devices', null, 'devices-test')">æµ‹è¯•</button>
                    </div>
                    <div class="endpoint-description">è·å–æ‰€æœ‰è®¾å¤‡åˆ—è¡¨</div>
                    <div class="endpoint-example">
                        <pre><code>curl -X GET http://localhost:3000/api/home_assistant/home_assistant/devices</code></pre>
                    </div>
                    <div id="devices-test" class="test-result-container"></div>
                </div>

                <h3>ğŸ“‹ è®¾å¤‡ä¿¡æ¯å­—æ®µ</h3>
                <div class="endpoint-example">
                    <pre><code>{
  "success": true,
  "data": {
    "devices": [
      {
        "id": "device_id",
        "name": "è®¾å¤‡åç§°",
        "manufacturer": "åˆ¶é€ å•†",
        "model": "å‹å·",
        "sw_version": "è½¯ä»¶ç‰ˆæœ¬",
        "area_id": "æˆ¿é—´ID",
        "name_by_user": "ç”¨æˆ·è‡ªå®šä¹‰åç§°",
        "disabled_by": null,
        "entry_type": "service",
        "identifiers": [["domain", "unique_id"]],
        "connections": [["mac", "00:11:22:33:44:55"]],
        "suggested_area": "å»ºè®®æˆ¿é—´",
        "config_entries": ["config_entry_id"]
      }
    ],
    "count": 1,
    "retrieved_at": "2025-01-08T10:30:00.000Z"
  }
}</code></pre>
                </div>

                <h3>ğŸ”§ ç›´æ¥è°ƒç”¨Home Assistant API</h3>
                <p>æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨Home Assistantçš„åŸå§‹APIï¼š</p>
                <div class="endpoint-example">
                    <pre><code># è·å–è®¾å¤‡æ³¨å†Œè¡¨
curl -X GET \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  http://your-home-assistant-url:8123/api/config/device_registry/list

# è·å–æ‰€æœ‰å®ä½“çŠ¶æ€
curl -X GET \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  http://your-home-assistant-url:8123/api/states</code></pre>
                </div>

                <h3>ğŸ Pythonç¤ºä¾‹</h3>
                <div class="endpoint-example">
                    <pre><code>import requests
import json

# é…ç½®ä¿¡æ¯
HA_URL = "http://your-home-assistant-url:8123"
TOKEN = "YOUR_ACCESS_TOKEN"

headers = {
    "Authorization": f"Bearer {TOKEN}",
    "Content-Type": "application/json",
}

# æŸ¥è¯¢è®¾å¤‡æ³¨å†Œè¡¨
def get_device_registry():
    response = requests.get(f"{HA_URL}/api/config/device_registry/list", headers=headers)
    if response.status_code == 200:
        return response.json()
    else:
        print(f"é”™è¯¯: {response.status_code}")
        return None

# æŸ¥è¯¢æ‰€æœ‰å®ä½“
def get_all_entities():
    response = requests.get(f"{HA_URL}/api/states", headers=headers)
    if response.status_code == 200:
        return response.json()
    else:
        print(f"é”™è¯¯: {response.status_code}")
        return None

# æ‰§è¡ŒæŸ¥è¯¢
devices = get_device_registry()
entities = get_all_entities()

if devices:
    print(f"æ‰¾åˆ° {len(devices)} ä¸ªè®¾å¤‡")
    for device in devices[:5]:
        print(f"- {device['name']}: {device['manufacturer']}")

if entities:
    print(f"æ‰¾åˆ° {len(entities)} ä¸ªå®ä½“")
    for entity in entities[:5]:
        print(f"- {entity['entity_id']}: {entity['state']}")</code></pre>
                </div>
            </div>

            <!-- æˆ¿é—´åˆ—è¡¨ -->
            <div class="api-section" id="rooms">
                <h2>ğŸ  æˆ¿é—´åˆ—è¡¨</h2>
                <p>è·å–Home Assistantä¸­é…ç½®çš„æ‰€æœ‰æˆ¿é—´/åŒºåŸŸä¿¡æ¯ï¼Œç”¨äºç»„ç»‡å’Œç®¡ç†è®¾å¤‡ã€‚</p>
                
                <div class="api-endpoint">
                    <div class="endpoint-header">
                        <span class="method get">GET</span>
                        <span class="url">/api/home_assistant/home_assistant/rooms</span>
                        <button class="btn btn-sm btn-primary" onclick="testApi('GET', '/api/home_assistant/home_assistant/rooms', null, 'rooms-test')">æµ‹è¯•</button>
                    </div>
                    <div class="endpoint-description">è·å–æ‰€æœ‰æˆ¿é—´åˆ—è¡¨</div>
                    <div class="endpoint-example">
                        <pre><code>curl -X GET http://localhost:3000/api/home_assistant/home_assistant/rooms</code></pre>
                    </div>
                    <div id="rooms-test" class="test-result-container"></div>
                </div>

                <h3>ğŸ“‹ æˆ¿é—´ä¿¡æ¯å­—æ®µ</h3>
                <div class="endpoint-example">
                    <pre><code>{
  "success": true,
  "data": {
    "rooms": [
      {
        "area_id": "room_id",
        "name": "æˆ¿é—´åç§°",
        "normalized_name": "normalized_room_name",
        "aliases": ["åˆ«å1", "åˆ«å2"],
        "picture": "/api/area_picture/room_id"
      }
    ],
    "count": 1,
    "retrieved_at": "2025-01-08T10:30:00.000Z"
  }
}</code></pre>
                </div>
            </div>


            <!-- æ¥¼å±‚åˆ—è¡¨ -->
            <div class="api-section" id="floors">
                <h2>ğŸ¢ æ¥¼å±‚åˆ—è¡¨</h2>
                <p>è·å–Home Assistantä¸­é…ç½®çš„æ‰€æœ‰æ¥¼å±‚ä¿¡æ¯ï¼Œç”¨äºç»„ç»‡å’Œç®¡ç†æˆ¿é—´ã€‚</p>
                
                <div class="api-endpoint">
                    <div class="endpoint-header">
                        <span class="method get">GET</span>
                        <span class="url">/api/home_assistant/home_assistant/floors</span>
                        <button class="btn btn-sm btn-primary" onclick="testApi('GET', '/api/home_assistant/home_assistant/floors', null, 'floors-test')">æµ‹è¯•</button>
                    </div>
                    <div class="endpoint-description">è·å–æ‰€æœ‰æ¥¼å±‚åˆ—è¡¨</div>
                    <div class="endpoint-example">
                        <pre><code>curl -X GET http://localhost:3000/api/home_assistant/home_assistant/floors</code></pre>
                    </div>
                    <div id="floors-test" class="test-result-container"></div>
                </div>

                <h3>ğŸ“‹ æ¥¼å±‚ä¿¡æ¯å­—æ®µ</h3>
                <div class="endpoint-example">
                    <pre><code>{
  "success": true,
  "data": {
    "floors": [
      {
        "floor_id": "home",
        "name": "Home",
        "level": null,
        "icon": null,
        "aliases": [],
        "created_at": 1751427259.679931,
        "modified_at": 1751427259.679966
      }
    ],
    "count": 1,
    "retrieved_at": "2025-01-08T10:30:00.000Z"
  }
}</code></pre>
                </div>

                <h3>ğŸ”§ ç›´æ¥è°ƒç”¨Home Assistant API</h3>
                <p>æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨Home Assistantçš„åŸå§‹APIï¼š</p>
                <div class="endpoint-example">
                    <pre><code># è·å–æ¥¼å±‚æ³¨å†Œè¡¨
curl -X GET \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  http://your-home-assistant-url:8123/api/config/floor_registry/list</code></pre>
                </div>

                <h3>ğŸ Pythonç¤ºä¾‹</h3>
                <div class="endpoint-example">
                    <pre><code>import requests
import json

# é…ç½®ä¿¡æ¯
HA_URL = "http://your-home-assistant-url:8123"
TOKEN = "YOUR_ACCESS_TOKEN"

headers = {
    "Authorization": f"Bearer {TOKEN}",
    "Content-Type": "application/json",
}

# æŸ¥è¯¢æ¥¼å±‚æ³¨å†Œè¡¨
def get_floor_registry():
    response = requests.get(f"{HA_URL}/api/config/floor_registry/list", headers=headers)
    if response.status_code == 200:
        return response.json()
    else:
        print(f"é”™è¯¯: {response.status_code}")
        return None

# æ‰§è¡ŒæŸ¥è¯¢
floors = get_floor_registry()

if floors:
    print(f"æ‰¾åˆ° {len(floors)} ä¸ªæ¥¼å±‚")
    for floor in floors:
        print(f"- {floor['name']} (ID: {floor['floor_id']})")</code></pre>
                </div>
            </div>

            <!-- æœåŠ¡è°ƒç”¨ -->
            <div class="api-section" id="services">
                <h2>âš™ï¸ æœåŠ¡è°ƒç”¨</h2>
                
                <div class="api-endpoint">
                    <div class="endpoint-header">
                        <span class="method post">POST</span>
                        <span class="url">/api/home_assistant/home_assistant/call-service</span>
                        <button class="btn btn-sm btn-primary" onclick="testCallServiceApi('call-service-test')">æµ‹è¯•</button>
                    </div>
                    <div class="endpoint-description">è°ƒç”¨Home AssistantæœåŠ¡</div>
                    <div class="endpoint-input">
                        <div style="margin-bottom: 10px;">
                            <label for="call-service-domain-input">Domain:</label>
                            <input type="text" id="call-service-domain-input" value="light" placeholder="ä¾‹å¦‚: light, switch, fan" style="width: 100px; margin: 0 10px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="call-service-service-input">Service:</label>
                            <input type="text" id="call-service-service-input" value="turn_on" placeholder="ä¾‹å¦‚: turn_on, turn_off, toggle" style="width: 100px; margin: 0 10px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="call-service-entity-input">Entity ID:</label>
                            <input type="text" id="call-service-entity-input" value="light.living_room" placeholder="ä¾‹å¦‚: light.living_room" style="width: 200px; margin: 0 10px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="call-service-data-input">Service Data (JSON):</label>
                            <input type="text" id="call-service-data-input" value='{}' placeholder='ä¾‹å¦‚: {"brightness": 255}' style="width: 300px; margin: 0 10px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                        </div>
                    </div>
                    <div class="endpoint-example">
                        <pre><code id="call-service-curl-example">curl -X POST http://localhost:3000/api/home_assistant/home_assistant/call-service \\
  -H "Content-Type: application/json" \\
  -d '{"domain": "light", "service": "turn_on", "entity_id": "light.living_room"}'</code></pre>
                    </div>
                    <div id="call-service-test" class="test-result-container"></div>
                </div>

                <h3>ğŸ”§ å¸¸ç”¨æœåŠ¡ç¤ºä¾‹</h3>
                
                <h4>ç¯å…‰æ§åˆ¶</h4>
                <div class="endpoint-example">
                    <pre><code># æ‰“å¼€ç¯å…‰
curl -X POST http://localhost:3000/api/home_assistant/home_assistant/call-service \
  -H "Content-Type: application/json" \
  -d '{"domain": "light", "service": "turn_on", "entity_id": "light.living_room"}'

# å…³é—­ç¯å…‰
curl -X POST http://localhost:3000/api/home_assistant/home_assistant/call-service \
  -H "Content-Type: application/json" \
  -d '{"domain": "light", "service": "turn_off", "entity_id": "light.living_room"}'

# è®¾ç½®äº®åº¦
curl -X POST http://localhost:3000/api/home_assistant/home_assistant/call-service \
  -H "Content-Type: application/json" \
  -d '{"domain": "light", "service": "turn_on", "entity_id": "light.living_room", "data": {"brightness": 128}}'</code></pre>
                </div>

                <h4>å¼€å…³æ§åˆ¶</h4>
                <div class="endpoint-example">
                    <pre><code># æ‰“å¼€å¼€å…³
curl -X POST http://localhost:3000/api/home_assistant/home_assistant/call-service \
  -H "Content-Type: application/json" \
  -d '{"domain": "switch", "service": "turn_on", "entity_id": "switch.coffee_maker"}'

# å…³é—­å¼€å…³
curl -X POST http://localhost:3000/api/home_assistant/home_assistant/call-service \
  -H "Content-Type: application/json" \
  -d '{"domain": "switch", "service": "turn_off", "entity_id": "switch.coffee_maker"}'</code></pre>
                </div>

                <h4>åœºæ™¯æ§åˆ¶</h4>
                <div class="endpoint-example">
                    <pre><code># æ¿€æ´»åœºæ™¯
curl -X POST http://localhost:3000/api/home_assistant/home_assistant/call-service \
  -H "Content-Type: application/json" \
  -d '{"domain": "scene", "service": "turn_on", "entity_id": "scene.movie_night"}'</code></pre>
                </div>
            </div>

            <!-- æ™ºèƒ½è®¾å¤‡åŒ¹é… -->
            <div class="api-section" id="device-matching">
                <h2>ğŸ¤– æ™ºèƒ½è®¾å¤‡åŒ¹é…</h2>
                <p>æ ¹æ®OpenAIè¿”å›çš„ç»“æ„åŒ–æ•°æ®æ™ºèƒ½åŒ¹é…Home Assistantè®¾å¤‡ï¼Œæ”¯æŒç©ºé—´åç§°/ç±»å‹åŒ¹é…å’Œè®¾å¤‡åç§°/ç±»å‹åŒ¹é…ã€‚</p>
                
                <div class="api-endpoint">
                    <div class="endpoint-header">
                        <span class="method post">POST</span>
                        <span class="url">/api/home_assistant/home_assistant/match-devices</span>
                        <button class="btn btn-primary" onclick="testMatchDevicesAPI('quick-test')">æµ‹è¯•</button>
                    </div>
                    <div class="endpoint-description">æ ¹æ®æ„å›¾æ•°æ®æ™ºèƒ½åŒ¹é…Home Assistantè®¾å¤‡</div>
                    <div id="quick-test" class="test-result-container"></div>
                    <div class="endpoint-example">
                        <pre><code>curl -X POST http://localhost:3000/api/home_assistant/home_assistant/match-devices \
  -H "Content-Type: application/json" \
  -d '{
    "intent_data": {
      "intent": "Control Device",
      "confidence": 0.95,
      "user_input": "æŠŠå§å®¤çš„ç¯å’Œç©ºè°ƒå…³äº† æŠŠå¨æˆ¿çš„ç©ºè°ƒè°ƒåˆ°20åº¦",
      "devices": [
        {
          "space_name": "å§å®¤",
          "space_type": "Bedroom",
          "device_name": "ç¯",
          "device_type": "Light",
          "action": "å…³"
        },
        {
          "space_name": "å§å®¤",
          "space_type": "Bedroom", 
          "device_name": "ç©ºè°ƒ",
          "device_type": "Air Conditioner",
          "action": "å…³"
        },
        {
          "space_name": "å¨æˆ¿",
          "space_type": "Kitchen",
          "device_name": "ç©ºè°ƒ", 
          "device_type": "Air Conditioner",
          "action": "è°ƒåˆ°20åº¦"
        }
      ]
    }
  }'</code></pre>
                    </div>
                    <div class="endpoint-params">
                        <strong>å‚æ•°:</strong>
                        <ul>
                            <li><code>intent_data</code> (å¿…éœ€): æ„å›¾æ•°æ®å¯¹è±¡</li>
                            <li><code>intent_data.devices</code> (å¿…éœ€): è®¾å¤‡æ•°ç»„</li>
                            <li><code>devices[].space_name</code> (å¿…éœ€): ç©ºé—´åç§°</li>
                            <li><code>devices[].space_type</code> (å¿…éœ€): ç©ºé—´ç±»å‹</li>
                            <li><code>devices[].device_name</code> (å¿…éœ€): è®¾å¤‡åç§°</li>
                            <li><code>devices[].device_type</code> (å¿…éœ€): è®¾å¤‡ç±»å‹</li>
                            <li><code>devices[].action</code> (å¿…éœ€): æ“ä½œåŠ¨ä½œ</li>
                        </ul>
                    </div>

                    <h3>ğŸ”§ æ™ºèƒ½è®¾å¤‡åŒ¹é…å‚æ•°è¾“å…¥</h3>
                    <div class="endpoint-input">
                        <label for="intent-input">æ„å›¾æ•°æ® (JSON):</label>
                        <textarea id="intent-input" rows="15" style="width: 100%; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">{
  "intent": "Control Device",
  "confidence": 0.95,
  "user_input": "æŠŠå§å®¤çš„ç¯å’Œç©ºè°ƒå…³äº† æŠŠå¨æˆ¿çš„ç©ºè°ƒè°ƒåˆ°20åº¦",
  "devices": [
    {
      "space_name": "å§å®¤",
      "space_type": "Bedroom",
      "device_name": "ç¯",
      "device_type": "Light",
      "action": "å…³"
    },
    {
      "space_name": "å§å®¤",
      "space_type": "Bedroom",
      "device_name": "ç©ºè°ƒ",
      "device_type": "Air Conditioner",
      "action": "å…³"
    },
    {
      "space_name": "å¨æˆ¿",
      "space_type": "Kitchen",
      "device_name": "ç©ºè°ƒ",
      "device_type": "Air Conditioner",
      "action": "è°ƒåˆ°20åº¦"
    }
  ]
}</textarea>
                    </div>
                    <div class="endpoint-input">
                        <button class="btn btn-primary" onclick="testMatchDevicesAPI()">ğŸ¤– å¼€å§‹åŒ¹é…è®¾å¤‡</button>
                        <button class="btn btn-secondary" onclick="clearMatchDevicesInputs()">ğŸ—‘ï¸ æ¸…ç©ºè¾“å…¥</button>
                        <button class="btn btn-info" onclick="formatJSON('intent-input')">ğŸ“ æ ¼å¼åŒ–JSON</button>
                        <button class="btn btn-warning" onclick="validateJSON('intent-input')">âœ… éªŒè¯JSON</button>
                    </div>
                    <div id="match-devices-test" class="test-result-container"></div>
                </div>

                <div class="api-info">
                    <h3>ğŸ“‹ åŒ¹é…è§„åˆ™</h3>
                    <ul>
                        <li><strong>ç©ºé—´åŒ¹é…</strong>: ä¼˜å…ˆç²¾ç¡®åŒ¹é…ç©ºé—´åç§°ï¼Œå¤±è´¥åˆ™åŒ¹é…ç©ºé—´ç±»å‹</li>
                        <li><strong>è®¾å¤‡åŒ¹é…</strong>: ä¼˜å…ˆç²¾ç¡®åŒ¹é…è®¾å¤‡åç§°ï¼Œå¤±è´¥åˆ™åŒ¹é…è®¾å¤‡ç±»å‹</li>
                        <li><strong>åŠŸèƒ½æ¨æ–­</strong>: æ ¹æ®è®¾å¤‡ç±»å‹å’Œæ“ä½œåŠ¨ä½œæ¨æ–­å¯ç”¨åŠŸèƒ½</li>
                        <li><strong>ç½®ä¿¡åº¦è®¡ç®—</strong>: åŸºäºåŒ¹é…ç²¾åº¦è®¡ç®—åŒ¹é…ç½®ä¿¡åº¦</li>
                    </ul>

                    <h3>ğŸ“Š è¿”å›æ ¼å¼</h3>
                    <pre><code>{
  "success": true,
  "data": {
    "matched_devices": [
      {
        "entity_id": "light.bedroom_light",
        "entity_name": "å§å®¤ç¯",
        "entity_functions": ["turn_on", "turn_off"],
        "device_name": "å§å®¤ç¯",
        "device_type": "Light",
        "space_name": "å§å®¤",
        "space_type": "å§å®¤",
        "action": "å…³",
        "confidence": 0.9
      }
    ],
    "total_matched": 3,
    "intent_devices": 3,
    "match_rate": "100%",
    "matched_at": "2025-09-10T06:33:07.000Z"
  }
}</code></pre>
                </div>
            </div>

            <!-- æ§åˆ¶è®¾å¤‡åŒ¹é… -->
            <div class="api-section" id="control-device-matching">
                <h2>ğŸ¯ æ§åˆ¶è®¾å¤‡åŒ¹é…</h2>
                <p>åŸºäºæ„å›¾æ•°æ®æ™ºèƒ½åŒ¹é…éœ€è¦æ§åˆ¶çš„è®¾å¤‡å®ä½“ï¼Œæ”¯æŒç²¾ç¡®çš„æˆ¿é—´ã€è®¾å¤‡ç±»å‹ã€è®¾å¤‡åç§°åŒ¹é…ï¼Œå¹¶ä¿ç•™å¢å¼ºçŠ¶æ€æ•°æ®çš„æ‰€æœ‰å­—æ®µã€‚</p>
                
                <div class="api-endpoint">
                    <div class="endpoint-header">
                        <span class="method post">POST</span>
                        <span class="url">/api/home_assistant/home_assistant/match-control-devices</span>
                        <button class="btn btn-sm btn-primary" onclick="testControlDeviceMatchingAPI()">æµ‹è¯•</button>
                    </div>
                    <div class="endpoint-description">
                        åŸºäºæ„å›¾æ•°æ®åŒ¹é…æ§åˆ¶è®¾å¤‡
                        <br>
                        <small class="text-muted">ğŸ¯ æ™ºèƒ½åŒ¹é…æˆ¿é—´ã€è®¾å¤‡ç±»å‹ã€è®¾å¤‡åç§°ï¼Œè¿”å›å¢å¼ºçŠ¶æ€æ•°æ®</small>
                    </div>
                    <div class="endpoint-example">
                        <pre><code>curl -X POST http://localhost:3000/api/home_assistant/home_assistant/match-control-devices \
  -H "Content-Type: application/json" \
  -d '{
    "intent": "Control Device",
    "confidence": 0.95,
    "user_input": "å§å®¤çš„ç¯å’Œç©ºè°ƒå…³æ‰ ä¹¦æˆ¿çš„ç©ºè°ƒæ¸©åº¦è°ƒåˆ°20åº¦",
    "matched_rooms": ["Master Bedroom", "Study Room"],
    "device_types": ["light", "climate"],
    "devices": [
      {
        "room_name": "Master Bedroom",
        "device_type": "light",
        "device_name": "ç¯",
        "action": "å…³æ‰"
      },
      {
        "room_name": "Master Bedroom",
        "device_type": "climate",
        "device_name": "ç©ºè°ƒ",
        "action": "å…³æ‰"
      }
    ]
  }'</code></pre>
                    </div>
                    
                    <h3>ğŸ“‹ è¯·æ±‚å‚æ•°</h3>
                    <div class="api-info">
                        <ul>
                            <li><code>intent</code> (å¿…éœ€): æ„å›¾ç±»å‹ï¼Œå¦‚ "Control Device"</li>
                            <li><code>confidence</code> (å¯é€‰): ç½®ä¿¡åº¦ï¼Œ0-1ä¹‹é—´çš„æ•°å€¼</li>
                            <li><code>user_input</code> (å¯é€‰): ç”¨æˆ·åŸå§‹è¾“å…¥</li>
                            <li><code>matched_rooms</code> (å¯é€‰): åŒ¹é…çš„æˆ¿é—´åˆ—è¡¨</li>
                            <li><code>device_types</code> (å¯é€‰): è®¾å¤‡ç±»å‹åˆ—è¡¨</li>
                            <li><code>devices</code> (å¿…éœ€): è®¾å¤‡æ•°ç»„ï¼Œæ¯ä¸ªè®¾å¤‡åŒ…å«ï¼š
                                <ul>
                                    <li><code>room_name</code> (å¿…éœ€): æˆ¿é—´åç§°</li>
                                    <li><code>device_type</code> (å¿…éœ€): è®¾å¤‡ç±»å‹</li>
                                    <li><code>device_name</code> (å¯é€‰): è®¾å¤‡åç§°</li>
                                    <li><code>action</code> (å¿…éœ€): æ“ä½œåŠ¨ä½œ</li>
                                </ul>
                            </li>
                        </ul>
                    </div>

                    <h3>ğŸ”§ æ§åˆ¶è®¾å¤‡åŒ¹é…å‚æ•°è¾“å…¥</h3>
                    <div class="endpoint-input">
                        <label for="control-intent-input">æ„å›¾æ•°æ® (JSON):</label>
                        <textarea id="control-intent-input" rows="20" style="width: 100%; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">{
  "intent": "Control Device",
  "confidence": 0.95,
  "user_input": "å§å®¤çš„ç¯å’Œç©ºè°ƒå…³æ‰ ä¹¦æˆ¿çš„ç©ºè°ƒæ¸©åº¦è°ƒåˆ°20åº¦",
  "matched_rooms": ["Master Bedroom", "Study Room"],
  "device_types": ["light", "climate"],
  "devices": [
    {
      "room_name": "Master Bedroom",
      "device_type": "light",
      "device_name": "ç¯",
      "action": "å…³æ‰"
    },
    {
      "room_name": "Master Bedroom",
      "device_type": "climate",
      "device_name": "ç©ºè°ƒ",
      "action": "å…³æ‰"
    },
    {
      "room_name": "Study Room",
      "device_type": "climate",
      "device_name": "ç©ºè°ƒ",
      "action": "è°ƒåˆ°20åº¦"
    }
  ]
}</textarea>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary" onclick="testControlDeviceMatchingAPI()">æµ‹è¯•æ§åˆ¶è®¾å¤‡åŒ¹é…</button>
                            <button class="btn btn-secondary" onclick="clearControlDeviceMatchingInputs()">æ¸…ç©ºè¾“å…¥</button>
                        </div>
                    </div>

                    <h3>ğŸ“Š å“åº”æ ¼å¼</h3>
                    <div class="api-info">
                        <pre><code>{
  "success": true,
  "data": {
    "matched_devices": [
      {
        "entity_id": "light.master_bedroom_light",
        "state": "on",
        "device_id": "abc123",
        "device_name": "Master Bedroom Light",
        "device_manufacturer": "Philips",
        "device_model": "Hue White",
        "device_type": "light",
        "area_id": "master_bedroom",
        "area_name": "Master Bedroom",
        "floor_id": "second_floor",
        "floor_name": "Second Floor",
        "action": "å…³æ‰",
        "intent_room": "Master Bedroom",
        "intent_device_type": "light",
        "intent_device_name": "ç¯",
        "match_confidence": 0.95
      }
    ],
    "statistics": {
      "total_intent_devices": 3,
      "matched_entities": 2,
      "unique_rooms": 2,
      "unique_device_types": 2,
      "actions": ["å…³æ‰", "è°ƒåˆ°20åº¦"],
      "confidence_scores": {
        "high": 2,
        "medium": 0,
        "low": 0
      }
    },
    "intent_data": { ... },
    "retrieved_at": "2025-09-11T10:30:00.000Z"
  }
}</code></pre>
                    </div>

                    <h3>ğŸ¯ åŒ¹é…è§„åˆ™</h3>
                    <div class="api-info">
                        <ol>
                            <li><strong>ç©ºé—´åŒ¹é…</strong>: é¦–å…ˆæ ¹æ®æˆ¿é—´åç§°åŒ¹é…å®ä½“</li>
                            <li><strong>è®¾å¤‡åç§°åŒ¹é…</strong>: ä¼˜å…ˆæŒ‰è®¾å¤‡åç§°ç²¾ç¡®åŒ¹é…</li>
                            <li><strong>è®¾å¤‡ç±»å‹åŒ¹é…</strong>: å¦‚æœè®¾å¤‡åç§°åŒ¹é…å¤±è´¥ï¼Œåˆ™æŒ‰è®¾å¤‡ç±»å‹åŒ¹é…</li>
                            <li><strong>ç½®ä¿¡åº¦è®¡ç®—</strong>: åŸºäºæˆ¿é—´åŒ¹é…(40%)ã€è®¾å¤‡ç±»å‹åŒ¹é…(30%)ã€è®¾å¤‡åç§°åŒ¹é…(30%)</li>
                        </ol>
                    </div>

                    <h3>ğŸ’¡ ä½¿ç”¨åœºæ™¯</h3>
                    <div class="api-info">
                        <ul>
                            <li><strong>æ™ºèƒ½è¯­éŸ³æ§åˆ¶</strong>: å°†è‡ªç„¶è¯­è¨€è½¬æ¢ä¸ºå…·ä½“çš„è®¾å¤‡æ§åˆ¶å‘½ä»¤</li>
                            <li><strong>æ‰¹é‡è®¾å¤‡æ“ä½œ</strong>: åŒæ—¶æ§åˆ¶å¤šä¸ªæˆ¿é—´çš„å¤šä¸ªè®¾å¤‡</li>
                            <li><strong>è®¾å¤‡çŠ¶æ€æŸ¥è¯¢</strong>: è·å–éœ€è¦æ§åˆ¶çš„è®¾å¤‡å½“å‰çŠ¶æ€</li>
                            <li><strong>è‡ªåŠ¨åŒ–æµç¨‹</strong>: åŸºäºç”¨æˆ·æ„å›¾è‡ªåŠ¨æ‰§è¡Œè®¾å¤‡æ§åˆ¶</li>
                        </ul>
                    </div>
                    
                    <div id="control-device-matching-test" class="test-result-container"></div>
                </div>
            </div>

            <!-- æ‰¹é‡è®¾å¤‡æ§åˆ¶ -->
            <div class="api-section" id="batch-control">
                <h2>ğŸ›ï¸ æ‰¹é‡è®¾å¤‡æ§åˆ¶</h2>
                <p>æ ¹æ®OpenAIè¿”å›çš„æ§åˆ¶å‘½ä»¤æ‰¹é‡æ‰§è¡ŒHome Assistantè®¾å¤‡æ§åˆ¶ï¼Œæ”¯æŒå¤šç§è®¾å¤‡ç±»å‹å’Œæ“ä½œã€‚</p>
                
                <div class="api-endpoint">
                    <div class="endpoint-header">
                        <span class="method post">POST</span>
                        <span class="url">/api/home_assistant/home_assistant/batch-control</span>
                        <button class="btn btn-primary" onclick="testBatchControlAPI('quick-batch-test')">æµ‹è¯•</button>
                    </div>
                    <div class="endpoint-description">æ‰¹é‡æ‰§è¡Œè®¾å¤‡æ§åˆ¶å‘½ä»¤å¹¶è¿”å›æ‰§è¡ŒçŠ¶æ€</div>
                    <div id="quick-batch-test" class="test-result-container"></div>
                    <div class="endpoint-example">
                        <pre><code>curl -X POST http://localhost:3000/api/home_assistant/home_assistant/batch-control \
  -H "Content-Type: application/json" \
  -d '{
    "control_commands": [
      {
        "entity_id": "light.bedroom_light",
        "entity_functions": ["turn_on", "turn_off"],
        "action": "å…³",
        "parameters": {}
      },
      {
        "entity_id": "climate.bedroom_ac",
        "entity_functions": ["turn_on", "turn_off", "set_temperature"],
        "action": "å…³",
        "parameters": {}
      },
      {
        "entity_id": "climate.kitchen_ac",
        "entity_functions": ["turn_on", "turn_off", "set_temperature"],
        "action": "è°ƒåˆ°20åº¦",
        "parameters": {"temperature": 20}
      }
    ]
  }'</code></pre>
                    </div>
                    <div class="endpoint-params">
                        <strong>å‚æ•°:</strong>
                        <ul>
                            <li><code>control_commands</code> (å¿…éœ€): æ§åˆ¶å‘½ä»¤æ•°ç»„</li>
                            <li><code>control_commands[].entity_id</code> (å¿…éœ€): å®ä½“ID</li>
                            <li><code>control_commands[].entity_functions</code> (å¿…éœ€): å®ä½“åŠŸèƒ½æ•°ç»„</li>
                            <li><code>control_commands[].action</code> (å¿…éœ€): æ“ä½œåŠ¨ä½œ</li>
                            <li><code>control_commands[].parameters</code> (å¯é€‰): é¢å¤–å‚æ•°</li>
                        </ul>
                    </div>

                    <h3>ğŸ”§ æ‰¹é‡æ§åˆ¶å‚æ•°è¾“å…¥</h3>
                    <div class="endpoint-input">
                        <label for="control-commands-input">æ§åˆ¶å‘½ä»¤ (JSON):</label>
                        <textarea id="control-commands-input" rows="15" style="width: 100%; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">[
  {
    "entity_id": "light.bedroom_light",
    "entity_functions": ["turn_on", "turn_off"],
    "action": "å…³",
    "parameters": {}
  },
  {
    "entity_id": "climate.bedroom_ac",
    "entity_functions": ["turn_on", "turn_off", "set_temperature"],
    "action": "å…³",
    "parameters": {}
  },
  {
    "entity_id": "climate.kitchen_ac",
    "entity_functions": ["turn_on", "turn_off", "set_temperature"],
    "action": "è°ƒåˆ°20åº¦",
    "parameters": {"temperature": 20}
  }
]</textarea>
                    </div>
                    <div class="endpoint-input">
                        <button class="btn btn-primary" onclick="testBatchControlAPI()">ğŸ›ï¸ æ‰§è¡Œæ‰¹é‡æ§åˆ¶</button>
                        <button class="btn btn-secondary" onclick="clearBatchControlInputs()">ğŸ—‘ï¸ æ¸…ç©ºè¾“å…¥</button>
                        <button class="btn btn-info" onclick="formatJSON('control-commands-input')">ğŸ“ æ ¼å¼åŒ–JSON</button>
                        <button class="btn btn-warning" onclick="validateJSON('control-commands-input')">âœ… éªŒè¯JSON</button>
                    </div>
                    <div id="batch-control-test" class="test-result-container"></div>
                </div>

                <div class="api-info">
                    <h3>ğŸ“‹ æ”¯æŒçš„æ“ä½œç±»å‹</h3>
                    <ul>
                        <li><strong>å¼€å…³æ§åˆ¶</strong>: å¼€/å…³ (turn_on/turn_off)</li>
                        <li><strong>æ¸©åº¦æ§åˆ¶</strong>: è°ƒåˆ°Xåº¦ (set_temperature)</li>
                        <li><strong>äº®åº¦æ§åˆ¶</strong>: äº®åº¦X% (set_brightness)</li>
                        <li><strong>é¢œè‰²æ§åˆ¶</strong>: è®¾ç½®é¢œè‰² (set_color)</li>
                        <li><strong>é€Ÿåº¦æ§åˆ¶</strong>: ä½/ä¸­/é«˜/æœ€é«˜ (set_speed)</li>
                        <li><strong>çª—å¸˜æ§åˆ¶</strong>: å¼€/å…³çª—å¸˜ (open_cover/close_cover)</li>
                        <li><strong>é”æ§åˆ¶</strong>: å¼€é”/é”é—¨ (unlock/lock)</li>
                    </ul>

                    <h3>ğŸ“Š è¿”å›æ ¼å¼</h3>
                    <pre><code>{
  "success": true,
  "data": {
    "total_commands": 3,
    "successful_commands": 3,
    "failed_commands": 0,
    "success_rate": "100%",
    "results": [
      {
        "index": 0,
        "entity_id": "light.bedroom_light",
        "success": true,
        "result": {
          "service_called": "light.turn_off",
          "service_data": {"entity_id": "light.bedroom_light"},
          "result": {...}
        }
      }
    ],
    "entity_states": [
      {
        "entity_id": "light.bedroom_light",
        "state": "off",
        "attributes": {...},
        "last_changed": "2025-09-10T06:33:07.000Z",
        "last_updated": "2025-09-10T06:33:07.000Z"
      }
    ],
    "executed_at": "2025-09-10T06:33:07.000Z"
  }
}</code></pre>
                </div>
            </div>


        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let apiKey = '';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä»localStorageè·å–APIå¯†é’¥
            apiKey = localStorage.getItem('credentialServiceApiKey') || '';
        });

        // æµ‹è¯•APIç«¯ç‚¹
        async function testApi(method, url, data = null, containerId = null) {
            const resultsContainer = containerId ? document.getElementById(containerId) : document.getElementById('apiTestResults');
            const timestamp = new Date().toLocaleTimeString();
            
            // æ˜¾ç¤ºæµ‹è¯•å¼€å§‹ä¿¡æ¯
            const testId = `test-${Date.now()}`;
            resultsContainer.innerHTML = `
                <div class="test-result-container" id="${testId}">
                    <div class="test-result-header" onclick="toggleTestResult('${testId}')">
                        <span>ğŸ§ª æµ‹è¯• ${method} ${url}</span>
                        <span class="test-result-toggle">â–¶</span>
                    </div>
                    <div class="test-result-content">
                        <div class="test-result info">
                            <div>æ—¶é—´: ${timestamp}</div>
                            <div>çŠ¶æ€: æ­£åœ¨æµ‹è¯•...</div>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                // æ·»åŠ APIå¯†é’¥ï¼ˆå¦‚æœæœ‰ï¼‰
                if (apiKey) {
                    options.headers['X-API-Key'] = apiKey;
                }
                
                // æ·»åŠ è¯·æ±‚ä½“ï¼ˆå¦‚æœæ˜¯POST/PUTè¯·æ±‚ï¼‰
                if (data && (method === 'POST' || method === 'PUT')) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(url, options);
                const responseData = await response.text();
                
                let parsedData;
                try {
                    parsedData = JSON.parse(responseData);
                } catch (e) {
                    parsedData = responseData;
                }
                
                const resultClass = response.ok ? 'success' : 'error';
                const statusText = response.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
                const responseTime = Date.now() - parseInt(testId.split('-')[1]);
                
                const testResultElement = document.getElementById(testId);
                const headerElement = testResultElement.querySelector('.test-result-header span:first-child');
                const contentElement = testResultElement.querySelector('.test-result-content');
                
                headerElement.innerHTML = `ğŸ§ª æµ‹è¯• ${method} ${url} - ${statusText}`;
                contentElement.innerHTML = `
                    <div class="test-result ${resultClass}">
                        <div>æ—¶é—´: ${timestamp}</div>
                        <div>çŠ¶æ€: ${statusText} (HTTP ${response.status})</div>
                        <div>å“åº”æ—¶é—´: ${responseTime}ms</div>
                        <pre>${JSON.stringify(parsedData, null, 2)}</pre>
                    </div>
                `;
                
            } catch (error) {
                const testResultElement = document.getElementById(testId);
                const headerElement = testResultElement.querySelector('.test-result-header span:first-child');
                const contentElement = testResultElement.querySelector('.test-result-content');
                
                headerElement.innerHTML = `ğŸ§ª æµ‹è¯• ${method} ${url} - âŒ ç½‘ç»œé”™è¯¯`;
                contentElement.innerHTML = `
                    <div class="test-result error">
                        <div>æ—¶é—´: ${timestamp}</div>
                        <div>çŠ¶æ€: âŒ ç½‘ç»œé”™è¯¯</div>
                        <div>é”™è¯¯: ${error.message}</div>
                    </div>
                `;
            }
        }

        // æµ‹è¯•æ™ºèƒ½è®¾å¤‡åŒ¹é…API
        async function testMatchDevicesAPI(containerId = 'match-devices-test') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            
            let intentInput = document.getElementById('intent-input').value.trim();
            
            // å¦‚æœæ˜¯å¿«é€Ÿæµ‹è¯•ä¸”æ²¡æœ‰è¾“å…¥æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æµ‹è¯•æ•°æ®
            if (!intentInput && containerId === 'quick-test') {
                intentInput = JSON.stringify({
                    intent: "Control Device",
                    confidence: 0.95,
                    user_input: "æŠŠå§å®¤çš„ç¯å’Œç©ºè°ƒå…³äº† æŠŠå¨æˆ¿çš„ç©ºè°ƒè°ƒåˆ°20åº¦",
                    devices: [
                        {
                            space_name: "å§å®¤",
                            space_type: "Bedroom",
                            device_name: "ç¯",
                            device_type: "Light",
                            action: "å…³"
                        },
                        {
                            space_name: "å§å®¤",
                            space_type: "Bedroom",
                            device_name: "ç©ºè°ƒ",
                            device_type: "Air Conditioner",
                            action: "å…³"
                        },
                        {
                            space_name: "å¨æˆ¿",
                            space_type: "Kitchen",
                            device_name: "ç©ºè°ƒ",
                            device_type: "Air Conditioner",
                            action: "è°ƒåˆ°20åº¦"
                        }
                    ]
                });
            }
            
            if (!intentInput) {
                container.innerHTML = `
                    <div class="test-result error">
                        <div><strong>âŒ é”™è¯¯</strong></div>
                        <div>è¯·è¾“å…¥æ„å›¾æ•°æ®</div>
                    </div>
                `;
                return;
            }
            
            let intentData;
            try {
                intentData = JSON.parse(intentInput);
            } catch (error) {
                container.innerHTML = `
                    <div class="test-result error">
                        <div><strong>âŒ é”™è¯¯</strong></div>
                        <div>JSONæ ¼å¼é”™è¯¯: ${error.message}</div>
                    </div>
                `;
                return;
            }
            
            const testId = `match-devices-test-${Date.now()}`;
            container.innerHTML = `
                <div class="test-result-container" id="${testId}">
                    <div class="test-result-header" onclick="toggleTestResult('${testId}')">
                        <span>ğŸ¤– æµ‹è¯•æ™ºèƒ½è®¾å¤‡åŒ¹é…API</span>
                        <span class="test-result-toggle">â–¶</span>
                    </div>
                    <div class="test-result-content">
                        <div class="test-result info">
                            <div>æ—¶é—´: ${timestamp}</div>
                            <div>çŠ¶æ€: æ­£åœ¨åŒ¹é…è®¾å¤‡...</div>
                            <div>æ„å›¾: ${intentData.intent || 'Unknown'}</div>
                            <div>è®¾å¤‡æ•°é‡: ${intentData.devices ? intentData.devices.length : 0}</div>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch('/api/home_assistant/home_assistant/match-devices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ intent_data: intentData })
                });
                
                const data = await response.json();
                const resultClass = response.ok ? 'success' : 'error';
                const statusText = response.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
                
                let resultsHtml = `
                    <div class="test-result ${resultClass}">
                        <div><strong>æ™ºèƒ½è®¾å¤‡åŒ¹é…APIæµ‹è¯•ç»“æœ</strong></div>
                        <div>çŠ¶æ€: ${statusText}</div>
                `;
                
                if (data.success && data.data) {
                    resultsHtml += `
                        <div>åŒ¹é…è®¾å¤‡æ•°é‡: ${data.data.total_matched || 0}</div>
                        <div>åŒ¹é…ç‡: ${data.data.match_rate || '0%'}</div>
                    `;
                    
                    if (data.data.matched_devices && data.data.matched_devices.length > 0) {
                        resultsHtml += `
                            <div><strong>åŒ¹é…çš„è®¾å¤‡:</strong></div>
                        `;
                        
                        data.data.matched_devices.forEach((device, index) => {
                            resultsHtml += `
                                <div class="matched-device">
                                    <div><strong>è®¾å¤‡ ${index + 1}:</strong></div>
                                    <div>å®ä½“ID: ${device.entity_id}</div>
                                    <div>å®ä½“åç§°: ${device.entity_name}</div>
                                    <div>è®¾å¤‡åç§°: ${device.device_name}</div>
                                    <div>è®¾å¤‡ç±»å‹: ${device.device_type}</div>
                                    <div>ç©ºé—´åç§°: ${device.space_name}</div>
                                    <div>æ“ä½œåŠ¨ä½œ: ${device.action}</div>
                                    <div>å¯ç”¨åŠŸèƒ½: ${device.entity_functions ? device.entity_functions.join(', ') : 'N/A'}</div>
                                    <div>ç½®ä¿¡åº¦: ${(device.confidence * 100).toFixed(1)}%</div>
                                </div>
                            `;
                        });
                    }
                } else if (data.error) {
                    resultsHtml += `
                        <div><strong>é”™è¯¯ä¿¡æ¯:</strong></div>
                        <div class="error-message">${data.error}</div>
                    `;
                }
                
                resultsHtml += `
                        <div><strong>å®Œæ•´å“åº”:</strong></div>
                        <pre class="json-response">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
                document.querySelector(`#${testId} .test-result-content`).innerHTML = resultsHtml;
            } catch (error) {
                document.querySelector(`#${testId} .test-result-content`).innerHTML = `
                    <div class="test-result error">
                        <div><strong>âŒ ç½‘ç»œé”™è¯¯</strong></div>
                        <div>${error.message}</div>
                    </div>
                `;
            }
        }

        // æ¸…ç©ºæ™ºèƒ½è®¾å¤‡åŒ¹é…è¾“å…¥
        function clearMatchDevicesInputs() {
            document.getElementById('intent-input').value = '';
        }

        // æ ¼å¼åŒ–JSON
        function formatJSON(textareaId) {
            const textarea = document.getElementById(textareaId);
            try {
                const jsonData = JSON.parse(textarea.value);
                textarea.value = JSON.stringify(jsonData, null, 2);
                showMessage('JSONæ ¼å¼åŒ–æˆåŠŸï¼', 'success');
            } catch (error) {
                showMessage('JSONæ ¼å¼é”™è¯¯ï¼š' + error.message, 'error');
            }
        }

        // éªŒè¯JSON
        function validateJSON(textareaId) {
            const textarea = document.getElementById(textareaId);
            try {
                JSON.parse(textarea.value);
                showMessage('JSONæ ¼å¼æ­£ç¡®ï¼', 'success');
            } catch (error) {
                showMessage('JSONæ ¼å¼é”™è¯¯ï¼š' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                border-radius: 4px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                max-width: 300px;
                word-wrap: break-word;
                ${type === 'success' ? 'background-color: #28a745;' : 'background-color: #dc3545;'}
            `;
            
            document.body.appendChild(messageDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        // æµ‹è¯•æ‰¹é‡æ§åˆ¶API
        async function testBatchControlAPI(containerId = 'batch-control-test') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            
            let commandsInput = document.getElementById('control-commands-input').value.trim();
            
            // å¦‚æœæ˜¯å¿«é€Ÿæµ‹è¯•ä¸”æ²¡æœ‰è¾“å…¥æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æµ‹è¯•æ•°æ®
            if (!commandsInput && containerId === 'quick-batch-test') {
                commandsInput = JSON.stringify([
                    {
                        entity_id: "light.bedroom_light",
                        entity_functions: ["turn_on", "turn_off"],
                        action: "å…³",
                        parameters: {}
                    },
                    {
                        entity_id: "climate.bedroom_ac",
                        entity_functions: ["turn_on", "turn_off", "set_temperature"],
                        action: "å…³",
                        parameters: {}
                    },
                    {
                        entity_id: "climate.kitchen_ac",
                        entity_functions: ["turn_on", "turn_off", "set_temperature"],
                        action: "è°ƒåˆ°20åº¦",
                        parameters: { temperature: 20 }
                    }
                ]);
            }
            
            if (!commandsInput) {
                container.innerHTML = `
                    <div class="test-result error">
                        <div><strong>âŒ é”™è¯¯</strong></div>
                        <div>è¯·è¾“å…¥æ§åˆ¶å‘½ä»¤</div>
                    </div>
                `;
                return;
            }
            
            let controlCommands;
            try {
                controlCommands = JSON.parse(commandsInput);
            } catch (error) {
                container.innerHTML = `
                    <div class="test-result error">
                        <div><strong>âŒ é”™è¯¯</strong></div>
                        <div>JSONæ ¼å¼é”™è¯¯: ${error.message}</div>
                    </div>
                `;
                return;
            }
            
            const testId = `batch-control-test-${Date.now()}`;
            container.innerHTML = `
                <div class="test-result-container" id="${testId}">
                    <div class="test-result-header" onclick="toggleTestResult('${testId}')">
                        <span>ğŸ›ï¸ æµ‹è¯•æ‰¹é‡æ§åˆ¶API</span>
                        <span class="test-result-toggle">â–¶</span>
                    </div>
                    <div class="test-result-content">
                        <div class="test-result info">
                            <div>æ—¶é—´: ${timestamp}</div>
                            <div>çŠ¶æ€: æ­£åœ¨æ‰§è¡Œæ‰¹é‡æ§åˆ¶...</div>
                            <div>å‘½ä»¤æ•°é‡: ${controlCommands.length}</div>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch('/api/home_assistant/home_assistant/batch-control', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ control_commands: controlCommands })
                });
                
                const data = await response.json();
                const resultClass = response.ok ? 'success' : 'error';
                const statusText = response.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
                
                let resultsHtml = `
                    <div class="test-result ${resultClass}">
                        <div><strong>æ‰¹é‡æ§åˆ¶APIæµ‹è¯•ç»“æœ</strong></div>
                        <div>çŠ¶æ€: ${statusText}</div>
                `;
                
                if (data.success && data.data) {
                    resultsHtml += `
                        <div>æ€»å‘½ä»¤æ•°: ${data.data.total_commands || 0}</div>
                        <div>æˆåŠŸå‘½ä»¤æ•°: ${data.data.successful_commands || 0}</div>
                        <div>å¤±è´¥å‘½ä»¤æ•°: ${data.data.failed_commands || 0}</div>
                        <div>æˆåŠŸç‡: ${data.data.success_rate || '0%'}</div>
                    `;
                    
                    if (data.data.results && data.data.results.length > 0) {
                        resultsHtml += `
                            <div><strong>æ‰§è¡Œç»“æœ:</strong></div>
                        `;
                        
                        data.data.results.forEach((result, index) => {
                            const statusIcon = result.success ? 'âœ…' : 'âŒ';
                            resultsHtml += `
                                <div class="matched-device">
                                    <div><strong>å‘½ä»¤ ${index + 1}: ${statusIcon}</strong></div>
                                    <div>å®ä½“ID: ${result.entity_id}</div>
                                    <div>çŠ¶æ€: ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}</div>
                            `;
                            
                            if (result.success && result.result) {
                                resultsHtml += `
                                    <div>è°ƒç”¨æœåŠ¡: ${result.result.service_called}</div>
                                    <div>æœåŠ¡æ•°æ®: ${JSON.stringify(result.result.service_data)}</div>
                                `;
                            } else if (result.error) {
                                resultsHtml += `
                                    <div>é”™è¯¯ä¿¡æ¯: ${result.error}</div>
                                `;
                            }
                            
                            resultsHtml += `</div>`;
                        });
                    }
                    
                    if (data.data.entity_states && data.data.entity_states.length > 0) {
                        resultsHtml += `
                            <div><strong>å®ä½“çŠ¶æ€:</strong></div>
                        `;
                        
                        data.data.entity_states.forEach((state, index) => {
                            resultsHtml += `
                                <div class="matched-device">
                                    <div><strong>å®ä½“ ${index + 1}:</strong></div>
                                    <div>å®ä½“ID: ${state.entity_id}</div>
                                    <div>çŠ¶æ€: ${state.state || 'N/A'}</div>
                                    <div>æœ€åæ›´æ–°: ${state.last_updated || 'N/A'}</div>
                                </div>
                            `;
                        });
                    }
                } else if (data.error) {
                    resultsHtml += `
                        <div><strong>é”™è¯¯ä¿¡æ¯:</strong></div>
                        <div class="error-message">${data.error}</div>
                    `;
                }
                
                resultsHtml += `
                        <div><strong>å®Œæ•´å“åº”:</strong></div>
                        <pre class="json-response">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
                document.querySelector(`#${testId} .test-result-content`).innerHTML = resultsHtml;
            } catch (error) {
                document.querySelector(`#${testId} .test-result-content`).innerHTML = `
                    <div class="test-result error">
                        <div><strong>âŒ ç½‘ç»œé”™è¯¯</strong></div>
                        <div>${error.message}</div>
                    </div>
                `;
            }
        }

        // æ¸…ç©ºæ‰¹é‡æ§åˆ¶è¾“å…¥
        function clearBatchControlInputs() {
            document.getElementById('control-commands-input').value = '';
        }

        // æµ‹è¯•å®ä½“åŒ¹é…API
        async function testEntityMatchingAPI(containerId = 'entity-matching-test') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            
            let intentInput = document.getElementById('entity-intent-input').value.trim();
            
            // å¦‚æœæ˜¯å¿«é€Ÿæµ‹è¯•ä¸”æ²¡æœ‰è¾“å…¥æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æµ‹è¯•æ•°æ®
            if (!intentInput && containerId === 'quick-entity-test') {
                intentInput = JSON.stringify({
                    intent: "Control Device",
                    confidence: 0.95,
                    user_input: "æŠŠå®¢æˆ¿çš„ç¯å’Œç©ºè°ƒéƒ½å…³äº† æŠŠå®¢å…çš„ç©ºè°ƒå’Œç¯éƒ½æ‰“å¼€",
                    matched_rooms: ["Guest Bedroom", "Living Room"],
                    device_types: ["light", "climate"],
                    devices: [
                        {
                            room_name: "Guest Bedroom",
                            device_type: "light",
                            device_name: "ç¯",
                            action: "å…³äº†"
                        },
                        {
                            room_name: "Guest Bedroom",
                            device_type: "climate",
                            device_name: "ç©ºè°ƒ",
                            action: "å…³äº†"
                        },
                        {
                            room_name: "Living Room",
                            device_type: "climate",
                            device_name: "ç©ºè°ƒ",
                            action: "æ‰“å¼€"
                        },
                        {
                            room_name: "Living Room",
                            device_type: "light",
                            device_name: "ç¯",
                            action: "æ‰“å¼€"
                        }
                    ]
                });
            }
            
            if (!intentInput) {
                container.innerHTML = `
                    <div class="test-result error">
                        <div><strong>âŒ é”™è¯¯</strong></div>
                        <div>è¯·è¾“å…¥æ„å›¾æ•°æ®</div>
                    </div>
                `;
                return;
            }
            
            let intentData;
            try {
                intentData = JSON.parse(intentInput);
            } catch (error) {
                container.innerHTML = `
                    <div class="test-result error">
                        <div><strong>âŒ JSONæ ¼å¼é”™è¯¯</strong></div>
                        <div>${error.message}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="test-result loading">
                    <div><strong>ğŸ”„ æ­£åœ¨åŒ¹é…å®ä½“...</strong></div>
                    <div>æ—¶é—´: ${timestamp}</div>
                </div>
            `;

            try {
                const response = await fetch('/api/home_assistant/home_assistant/match-entities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(intentData)
                });

                const data = await response.json();
                const responseTime = Date.now() - new Date(timestamp).getTime();

                if (data.success) {
                    let resultsHtml = `
                        <div class="test-result success">
                            <div class="test-result-header">
                                <div><strong>âœ… å®ä½“åŒ¹é…æˆåŠŸ</strong></div>
                                <div>æ—¶é—´: ${timestamp}</div>
                                <div>çŠ¶æ€: âœ… æˆåŠŸ (HTTP ${response.status})</div>
                                <div>å“åº”æ—¶é—´: ${responseTime}ms</div>
                            </div>
                            <div class="test-result-content">
                                <div><strong>ğŸ“Š åŒ¹é…ç»“æœ:</strong></div>
                                <div>æ€»å®ä½“æ•°: ${data.data.total_entities}</div>
                                <div>åŒ¹é…æˆ¿é—´: ${data.data.matched_rooms.join(', ')}</div>
                                <div>è®¾å¤‡ç±»å‹: ${data.data.device_types.join(', ')}</div>
                    `;

                    // æ˜¾ç¤ºæ¯ä¸ªè®¾å¤‡çš„åŒ¹é…ç»“æœ
                    data.data.devices.forEach((device, index) => {
                        resultsHtml += `
                            <div class="matched-device">
                                <div><strong>è®¾å¤‡ ${index + 1}: ${device.room_name} - ${device.device_name}</strong></div>
                                <div>è®¾å¤‡ç±»å‹: ${device.device_type}</div>
                                <div>æ“ä½œ: ${device.action}</div>
                                <div>åŒ¹é…å®ä½“æ•°: ${device.matched_count}</div>
                        `;
                        
                        if (device.entities && device.entities.length > 0) {
                            resultsHtml += `<div><strong>å®ä½“åˆ—è¡¨:</strong></div>`;
                            device.entities.forEach((entity, entityIndex) => {
                                resultsHtml += `
                                    <div style="margin-left: 20px; margin-top: 5px;">
                                        <div><strong>å®ä½“ ${entityIndex + 1}:</strong></div>
                                        <div>ID: ${entity.entity_id}</div>
                                        <div>åç§°: ${entity.name}</div>
                                        <div>åŸŸ: ${entity.domain}</div>
                                        <div>è®¾å¤‡ç±»: ${entity.device_class || 'N/A'}</div>
                                        <div>çŠ¶æ€: ${entity.state}</div>
                                        <div>åŠŸèƒ½: ${entity.capabilities.join(', ')}</div>
                                    </div>
                                `;
                            });
                        } else {
                            resultsHtml += `<div style="color: #dc3545;">âŒ æœªæ‰¾åˆ°åŒ¹é…çš„å®ä½“</div>`;
                        }
                        
                        resultsHtml += `</div>`;
                    });

                    resultsHtml += `
                                <div><strong>ğŸ“‹ å®Œæ•´å“åº”:</strong></div>
                                <pre><code>${JSON.stringify(data, null, 2)}</code></pre>
                            </div>
                        </div>
                    `;

                    container.innerHTML = resultsHtml;
                } else {
                    container.innerHTML = `
                        <div class="test-result error">
                            <div><strong>âŒ å®ä½“åŒ¹é…å¤±è´¥</strong></div>
                            <div>æ—¶é—´: ${timestamp}</div>
                            <div>çŠ¶æ€: âŒ å¤±è´¥ (HTTP ${response.status})</div>
                            <div>å“åº”æ—¶é—´: ${responseTime}ms</div>
                            <div>é”™è¯¯: ${data.error}</div>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="test-result error">
                        <div><strong>âŒ è¯·æ±‚å¤±è´¥</strong></div>
                        <div>æ—¶é—´: ${timestamp}</div>
                        <div>é”™è¯¯: ${error.message}</div>
                    </div>
                `;
            }
        }

        // æ¸…ç©ºå®ä½“åŒ¹é…è¾“å…¥
        function clearEntityMatchingInputs() {
            document.getElementById('entity-intent-input').value = '';
        }

        // åˆ‡æ¢æµ‹è¯•ç»“æœæ˜¾ç¤º
        function toggleTestResult(testId) {
            const testResultElement = document.getElementById(testId);
            const contentElement = testResultElement.querySelector('.test-result-content');
            const toggleElement = testResultElement.querySelector('.test-result-toggle');
            
            if (contentElement.classList.contains('expanded')) {
                contentElement.classList.remove('expanded');
                toggleElement.classList.remove('expanded');
            } else {
                contentElement.classList.add('expanded');
                toggleElement.classList.add('expanded');
            }
        }

        // æ¸…ç©ºæœç´¢è¾“å…¥
        function clearSearchInputs() {
            document.getElementById('search-floor-id').value = '';
            document.getElementById('search-area-id').value = '';
            document.getElementById('search-device-type').value = '';
            document.getElementById('search-manufacturer').value = '';
            document.getElementById('search-model').value = '';
            document.getElementById('search-enabled-only').value = '';
        }

        // ä½¿ç”¨è¾“å…¥å‚æ•°æµ‹è¯•è®¾å¤‡æœç´¢API
        async function testDeviceSearchWithInputs() {
            const container = document.getElementById('device-search-test');
            const timestamp = new Date().toLocaleTimeString();
            
            // æ”¶é›†è¾“å…¥å‚æ•°
            const filters = {};
            const floorId = document.getElementById('search-floor-id').value.trim();
            const areaId = document.getElementById('search-area-id').value.trim();
            const deviceType = document.getElementById('search-device-type').value.trim();
            const manufacturer = document.getElementById('search-manufacturer').value.trim();
            const model = document.getElementById('search-model').value.trim();
            const enabledOnly = document.getElementById('search-enabled-only').value;
            
            if (floorId) filters.floor_id = floorId;
            if (areaId) filters.area_id = areaId;
            if (deviceType) filters.device_type = deviceType;
            if (manufacturer) filters.manufacturer = manufacturer;
            if (model) filters.model = model;
            if (enabledOnly !== '') filters.enabled_only = enabledOnly === 'true';
            
            // æ˜¾ç¤ºæµ‹è¯•å¼€å§‹ä¿¡æ¯
            const testId = `device-search-input-test-${Date.now()}`;
            container.innerHTML = `
                <div class="test-result-container" id="${testId}">
                    <div class="test-result-header" onclick="toggleTestResult('${testId}')">
                        <span>ğŸ” æµ‹è¯•è®¾å¤‡æœç´¢ (è‡ªå®šä¹‰å‚æ•°)</span>
                        <span class="test-result-toggle">â–¶</span>
                    </div>
                    <div class="test-result-content">
                        <div class="test-result info">
                            <div>æ—¶é—´: ${timestamp}</div>
                            <div>çŠ¶æ€: æ­£åœ¨æµ‹è¯•...</div>
                            <div>æœç´¢å‚æ•°: ${JSON.stringify(filters)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch('/api/home_assistant/home_assistant/devices/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(filters)
                });
                
                const data = await response.json();
                const resultClass = response.ok ? 'success' : 'error';
                const statusText = response.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
                
                let resultsHtml = `
                    <div class="test-result ${resultClass}">
                        <div><strong>è®¾å¤‡æœç´¢ç»“æœ</strong></div>
                        <div>çŠ¶æ€: ${statusText}</div>
                        <div>æœç´¢å‚æ•°: ${JSON.stringify(filters)}</div>
                        <div>æ‰¾åˆ°è®¾å¤‡: ${data.success ? data.data.count : 0} ä¸ª</div>
                        <div>å“åº”æ—¶é—´: ${response.headers.get('X-Response-Time') || 'N/A'}</div>
                `;
                
                if (data.success && data.data.devices && data.data.devices.length > 0) {
                    resultsHtml += `
                        <div><strong>è®¾å¤‡åˆ—è¡¨:</strong></div>
                        <div class="device-list">
                    `;
                    data.data.devices.forEach(device => {
                        resultsHtml += `
                            <div class="device-item">
                                <div><strong>${device.name}</strong></div>
                                <div>ç±»å‹: ${device.device_type}</div>
                                <div>åˆ¶é€ å•†: ${device.manufacturer}</div>
                                <div>å‹å·: ${device.model}</div>
                                <div>æˆ¿é—´: ${device.area_id || 'æœªåˆ†é…'}</div>
                            </div>
                        `;
                    });
                    resultsHtml += `</div>`;
                }
                
                resultsHtml += `
                        <details>
                            <summary>æŸ¥çœ‹å®Œæ•´å“åº”</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    </div>
                `;
                
                // æ›´æ–°ç»“æœ
                const contentElement = document.getElementById(testId).querySelector('.test-result-content');
                contentElement.innerHTML = resultsHtml;
                
            } catch (error) {
                const contentElement = document.getElementById(testId).querySelector('.test-result-content');
                contentElement.innerHTML = `
                    <div class="test-result error">
                        <div>âŒ æµ‹è¯•å¤±è´¥</div>
                        <div>é”™è¯¯: ${error.message}</div>
                    </div>
                `;
            }
        }

        // æµ‹è¯•è®¾å¤‡æœç´¢API
        async function testDeviceSearch() {
            const container = document.getElementById('device-search-test');
            const timestamp = new Date().toLocaleTimeString();
            
            // æ˜¾ç¤ºæµ‹è¯•å¼€å§‹ä¿¡æ¯
            const testId = `device-search-test-${Date.now()}`;
            container.innerHTML = `
                <div class="test-result-container" id="${testId}">
                    <div class="test-result-header" onclick="toggleTestResult('${testId}')">
                        <span>ğŸ” æµ‹è¯•è®¾å¤‡æœç´¢</span>
                        <span class="test-result-toggle">â–¶</span>
                    </div>
                    <div class="test-result-content">
                        <div class="test-result info">
                            <div>æ—¶é—´: ${timestamp}</div>
                            <div>çŠ¶æ€: æ­£åœ¨æµ‹è¯•...</div>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                // æµ‹è¯•ä¸åŒçš„æœç´¢æ¡ä»¶
                const testCases = [
                    { name: "æŒ‰æˆ¿é—´æœç´¢", filters: { area_id: "bedroom" } },
                    { name: "æŒ‰è®¾å¤‡ç±»å‹æœç´¢", filters: { device_type: "homekit" } },
                    { name: "æŒ‰åˆ¶é€ å•†æœç´¢", filters: { manufacturer: "LinknLink" } },
                    { name: "ç»„åˆæœç´¢", filters: { area_id: "bedroom", enabled_only: true } }
                ];
                
                let resultsHtml = '';
                
                for (const testCase of testCases) {
                    const response = await fetch('/api/home_assistant/home_assistant/devices/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(testCase.filters)
                    });
                    
                    const data = await response.json();
                    const resultClass = response.ok ? 'success' : 'error';
                    const statusText = response.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
                    
                    resultsHtml += `
                        <div class="test-result ${resultClass}">
                            <div><strong>${testCase.name}</strong></div>
                            <div>çŠ¶æ€: ${statusText}</div>
                            <div>æœç´¢æ¡ä»¶: ${JSON.stringify(testCase.filters)}</div>
                            <div>æ‰¾åˆ°è®¾å¤‡: ${data.success ? data.data.count : 0} ä¸ª</div>
                            <div>å“åº”æ—¶é—´: ${response.headers.get('X-Response-Time') || 'N/A'}</div>
                            <details>
                                <summary>æŸ¥çœ‹è¯¦ç»†å“åº”</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                }
                
                // æ›´æ–°ç»“æœ
                const contentElement = document.getElementById(testId).querySelector('.test-result-content');
                contentElement.innerHTML = resultsHtml;
                
            } catch (error) {
                const contentElement = document.getElementById(testId).querySelector('.test-result-content');
                contentElement.innerHTML = `
                    <div class="test-result error">
                        <div>âŒ æµ‹è¯•å¤±è´¥</div>
                        <div>é”™è¯¯: ${error.message}</div>
                    </div>
                `;
            }
        }

        // æµ‹è¯•å®ä½“ç›¸å…³API
        async function testEntityApi(method, containerId, endpoint = '') {
            const entityId = document.getElementById('entity-id-input').value;
            if (!entityId) {
                alert('è¯·è¾“å…¥Entity ID');
                return;
            }
            
            const url = `/api/home_assistant/home_assistant/entity/${entityId}${endpoint}`;
            await testApi(method, url, null, containerId);
            
            // æ›´æ–°curlç¤ºä¾‹
            const curlExample = document.getElementById('entity-curl-example');
            if (curlExample) {
                curlExample.textContent = `curl -X ${method} http://localhost:3000/api/home_assistant/home_assistant/entity/${entityId}${endpoint}`;
            }
        }

        // æµ‹è¯•è®¾ç½®çŠ¶æ€API
        async function testSetStateApi(containerId) {
            const entityId = document.getElementById('set-state-entity-input').value;
            const state = document.getElementById('set-state-state-input').value;
            const attributesStr = document.getElementById('set-state-attributes-input').value;
            
            if (!entityId || !state) {
                alert('è¯·è¾“å…¥Entity IDå’ŒState');
                return;
            }
            
            let attributes = {};
            if (attributesStr) {
                try {
                    attributes = JSON.parse(attributesStr);
                } catch (e) {
                    alert('Attributes JSONæ ¼å¼é”™è¯¯');
                    return;
                }
            }
            
            const data = { state, attributes };
            const url = `/api/home_assistant/home_assistant/entity/${entityId}/set_state`;
            await testApi('POST', url, data, containerId);
            
            // æ›´æ–°curlç¤ºä¾‹
            const curlExample = document.getElementById('set-state-curl-example');
            if (curlExample) {
                curlExample.textContent = `curl -X POST http://localhost:3000/api/home_assistant/home_assistant/entity/${entityId}/set_state \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(data)}'`;
            }
        }

        // æµ‹è¯•æœåŠ¡è°ƒç”¨API
        async function testCallServiceApi(containerId) {
            const domain = document.getElementById('call-service-domain-input').value;
            const service = document.getElementById('call-service-service-input').value;
            const entityId = document.getElementById('call-service-entity-input').value;
            const serviceDataStr = document.getElementById('call-service-data-input').value;
            
            if (!domain || !service) {
                alert('è¯·è¾“å…¥Domainå’ŒService');
                return;
            }
            
            let serviceData = {};
            if (serviceDataStr) {
                try {
                    serviceData = JSON.parse(serviceDataStr);
                } catch (e) {
                    alert('Service Data JSONæ ¼å¼é”™è¯¯');
                    return;
                }
            }
            
            const data = { domain, service, ...serviceData };
            if (entityId) {
                data.entity_id = entityId;
            }
            
            const url = '/api/home_assistant/home_assistant/call-service';
            await testApi('POST', url, data, containerId);
            
            // æ›´æ–°curlç¤ºä¾‹
            const curlExample = document.getElementById('call-service-curl-example');
            if (curlExample) {
                curlExample.textContent = `curl -X POST http://localhost:3000/api/home_assistant/home_assistant/call-service \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(data)}'`;
            }
        }

        // æµ‹è¯•å®ä½“æ³¨å†Œè¡¨API
        async function testEntityRegistryApi(containerId) {
            const timestamp = new Date().toLocaleString();
            document.getElementById(containerId).innerHTML = `
                <div class="test-result-header">
                    <span class="toggle-btn" onclick="toggleTestResult('${containerId}')">â–¼</span>
                    å®ä½“æ³¨å†Œè¡¨æµ‹è¯•ç»“æœ
                </div>
                <div class="test-result-content">
                    <div class="test-result info">
                        <div>æ—¶é—´: ${timestamp}</div>
                        <div>çŠ¶æ€: æ­£åœ¨æµ‹è¯•...</div>
                    </div>
                </div>
            `;
            
            try {
                // è·å–ç­›é€‰å‚æ•°
                const domainFilter = document.getElementById('entity-domain-filter').value;
                const platformFilter = document.getElementById('entity-platform-filter').value;
                const deviceFilter = document.getElementById('entity-device-filter').value;
                const limit = parseInt(document.getElementById('entity-limit').value) || 20;
                
                const response = await fetch('/api/home_assistant/home_assistant/entity-registry');
                const data = await response.json();
                
                const resultClass = response.ok ? 'success' : 'error';
                const statusText = response.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
                
                let entities = data.success ? (data.data.entities || []) : [];
                const totalEntities = entities.length;
                
                // åº”ç”¨ç­›é€‰
                if (domainFilter) {
                    entities = entities.filter(entity => entity.entity_id.startsWith(domainFilter + '.'));
                }
                
                if (platformFilter) {
                    entities = entities.filter(entity => 
                        entity.platform && entity.platform.toLowerCase().includes(platformFilter.toLowerCase())
                    );
                }
                
                if (deviceFilter) {
                    entities = entities.filter(entity => 
                        entity.device_id && entity.device_id.includes(deviceFilter)
                    );
                }
                
                // é™åˆ¶æ˜¾ç¤ºæ•°é‡
                const displayEntities = entities.slice(0, limit);
                const filteredCount = entities.length;
                
                // ç»Ÿè®¡å®ä½“ç±»å‹
                const entityStats = {};
                const platformStats = {};
                entities.forEach(entity => {
                    const domain = entity.entity_id.split('.')[0];
                    entityStats[domain] = (entityStats[domain] || 0) + 1;
                    
                    if (entity.platform) {
                        platformStats[entity.platform] = (platformStats[entity.platform] || 0) + 1;
                    }
                });
                
                // ç”Ÿæˆå®ä½“è¡¨æ ¼
                const entityTableRows = displayEntities.map(entity => `
                    <tr>
                        <td><code>${entity.entity_id}</code></td>
                        <td>${entity.name || entity.original_name || 'N/A'}</td>
                        <td><span class="badge">${entity.platform || 'N/A'}</span></td>
                        <td><code style="font-size: 0.8em;">${entity.device_id || 'N/A'}</code></td>
                        <td><code style="font-size: 0.8em;">${entity.area_id || 'N/A'}</code></td>
                        <td><span class="badge ${entity.disabled_by ? 'badge-warning' : 'badge-success'}">${entity.disabled_by ? 'ç¦ç”¨' : 'å¯ç”¨'}</span></td>
                    </tr>
                `).join('');
                
                // ç”Ÿæˆç»Ÿè®¡å›¾è¡¨
                const topDomains = Object.entries(entityStats)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 8)
                    .map(([domain, count]) => `
                        <div class="stat-item">
                            <span class="stat-label">${domain}</span>
                            <span class="stat-value">${count}</span>
                        </div>
                    `).join('');
                
                const topPlatforms = Object.entries(platformStats)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([platform, count]) => `
                        <div class="stat-item">
                            <span class="stat-label">${platform}</span>
                            <span class="stat-value">${count}</span>
                        </div>
                    `).join('');
                
                const contentElement = document.getElementById(containerId).querySelector('.test-result-content');
                contentElement.innerHTML = `
                    <div class="test-result ${resultClass}">
                        <div><strong>ğŸ—‚ï¸ å®ä½“æ³¨å†Œè¡¨è·å–ç»“æœ</strong></div>
                        <div>çŠ¶æ€: ${statusText}</div>
                        <div>ğŸ“Š æ€»å®ä½“æ•°: ${totalEntities}</div>
                        <div>ğŸ” ç­›é€‰å: ${filteredCount} ä¸ªå®ä½“</div>
                        <div>ğŸ“„ æ˜¾ç¤º: ${displayEntities.length} ä¸ªå®ä½“</div>
                        <div>ğŸ“¡ æ•°æ®æº: ${data.data?.retrieved_at ? 'WebSocket API' : 'REST API'}</div>
                        <div>â±ï¸ è·å–æ—¶é—´: ${data.data?.retrieved_at || 'N/A'}</div>
                    </div>
                    
                    <div class="test-result info">
                        <div><strong>ğŸ“Š å®ä½“ç±»å‹ç»Ÿè®¡</strong></div>
                        <div class="stats-grid">
                            ${topDomains}
                        </div>
                    </div>
                    
                    <div class="test-result info">
                        <div><strong>ğŸ”Œ å¹³å°ç»Ÿè®¡ (Top 5)</strong></div>
                        <div class="stats-grid">
                            ${topPlatforms}
                        </div>
                    </div>
                    
                    ${displayEntities.length > 0 ? `
                    <div class="test-result success">
                        <div><strong>ğŸ“‹ å®ä½“åˆ—è¡¨ (æ˜¾ç¤ºå‰ ${limit} ä¸ª)</strong></div>
                        <div style="overflow-x: auto; margin-top: 10px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                <thead>
                                    <tr style="background-color: var(--gray-100);">
                                        <th style="padding: 8px; text-align: left; border: 1px solid var(--gray-300);">å®ä½“ID</th>
                                        <th style="padding: 8px; text-align: left; border: 1px solid var(--gray-300);">åç§°</th>
                                        <th style="padding: 8px; text-align: left; border: 1px solid var(--gray-300);">å¹³å°</th>
                                        <th style="padding: 8px; text-align: left; border: 1px solid var(--gray-300);">è®¾å¤‡ID</th>
                                        <th style="padding: 8px; text-align: left; border: 1px solid var(--gray-300);">åŒºåŸŸID</th>
                                        <th style="padding: 8px; text-align: left; border: 1px solid var(--gray-300);">çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${entityTableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}
                    
                    <details style="margin-top: 10px;">
                        <summary>ğŸ” æŸ¥çœ‹åŸå§‹APIå“åº”</summary>
                        <pre style="background-color: var(--gray-100); padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 0.8em;">${JSON.stringify(data, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                const contentElement = document.getElementById(containerId).querySelector('.test-result-content');
                contentElement.innerHTML = `
                    <div class="test-result error">
                        <div>âŒ æµ‹è¯•å¤±è´¥</div>
                        <div>é”™è¯¯: ${error.message}</div>
                    </div>
                `;
            }
        }

        // å¹³æ»‘æ»šåŠ¨åˆ°é”šç‚¹
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // æµ‹è¯•å¢å¼ºçŠ¶æ€æ•°æ®APIï¼ˆå¸¦ç­›é€‰ï¼‰
        async function testEnhancedStatesWithFilters() {
            const areaNamesInput = document.getElementById('area-names-filter').value.trim();
            const deviceTypesInput = document.getElementById('device-types-filter').value.trim();
            
            let url = '/api/home_assistant/home_assistant/enhanced-states';
            const params = new URLSearchParams();
            
            if (areaNamesInput) {
                try {
                    const areaNames = JSON.parse(areaNamesInput);
                    if (Array.isArray(areaNames)) {
                        params.append('area_names', JSON.stringify(areaNames));
                    } else {
                        params.append('area_names', JSON.stringify([areaNames]));
                    }
                } catch (e) {
                    alert('åŒºåŸŸåç§°æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSONæ•°ç»„æ ¼å¼');
                    return;
                }
            }
            
            if (deviceTypesInput) {
                try {
                    const deviceTypes = JSON.parse(deviceTypesInput);
                    if (Array.isArray(deviceTypes)) {
                        params.append('device_types', JSON.stringify(deviceTypes));
                    } else {
                        params.append('device_types', JSON.stringify([deviceTypes]));
                    }
                } catch (e) {
                    alert('è®¾å¤‡ç±»å‹æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSONæ•°ç»„æ ¼å¼');
                    return;
                }
            }
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            await testApi('GET', url, null, 'enhanced-states-test');
        }

        // æ¸…ç©ºç­›é€‰æ¡ä»¶
        function clearFilters() {
            document.getElementById('area-names-filter').value = '';
            document.getElementById('device-types-filter').value = '';
        }

        // æµ‹è¯•æ§åˆ¶è®¾å¤‡åŒ¹é…API
        async function testControlDeviceMatchingAPI() {
            const container = document.getElementById('control-device-matching-test');
            const timestamp = new Date().toLocaleTimeString();
            
            let intentInput = document.getElementById('control-intent-input').value.trim();
            
            if (!intentInput) {
                alert('è¯·è¾“å…¥æ„å›¾æ•°æ®');
                return;
            }
            
            let intentData;
            try {
                intentData = JSON.parse(intentInput);
            } catch (e) {
                alert('JSONæ ¼å¼é”™è¯¯: ' + e.message);
                return;
            }
            
            const testId = `control-device-matching-test-${Date.now()}`;
            container.innerHTML = `
                <div class="test-result-container" id="${testId}">
                    <div class="test-result-header" onclick="toggleTestResult('${testId}')">
                        <span>ğŸ¯ æµ‹è¯•æ§åˆ¶è®¾å¤‡åŒ¹é…API</span>
                        <span class="test-result-toggle">â–¶</span>
                    </div>
                    <div class="test-result-content">
                        <div class="test-result info">
                            <div>æ—¶é—´: ${timestamp}</div>
                            <div>çŠ¶æ€: æ­£åœ¨æµ‹è¯•...</div>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch('/api/home_assistant/home_assistant/match-control-devices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(intentData)
                });
                
                const data = await response.json();
                const resultClass = response.ok ? 'success' : 'error';
                const statusText = response.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
                
                let resultsHtml = `
                    <div class="test-result ${resultClass}">
                        <div><strong>æ§åˆ¶è®¾å¤‡åŒ¹é…APIæµ‹è¯•ç»“æœ</strong></div>
                        <div>çŠ¶æ€: ${statusText}</div>
                `;
                
                if (data.success && data.data) {
                    const { matched_devices, statistics } = data.data;
                    resultsHtml += `
                        <div>åŒ¹é…è®¾å¤‡æ•°é‡: ${matched_devices.length}</div>
                        <div>æ„å›¾è®¾å¤‡æ•°é‡: ${statistics.total_intent_devices}</div>
                        <div>åŒ¹é…æˆ¿é—´æ•°: ${statistics.unique_rooms}</div>
                        <div>è®¾å¤‡ç±»å‹æ•°: ${statistics.unique_device_types}</div>
                        <div>æ“ä½œåŠ¨ä½œ: ${statistics.actions.join(', ')}</div>
                        <div>ç½®ä¿¡åº¦åˆ†å¸ƒ: é«˜(${statistics.confidence_scores.high}) ä¸­(${statistics.confidence_scores.medium}) ä½(${statistics.confidence_scores.low})</div>
                    `;
                    
                    if (matched_devices.length > 0) {
                        resultsHtml += `
                            <div style="margin-top: 15px;">
                                <strong>åŒ¹é…çš„è®¾å¤‡:</strong>
                                <div style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                        `;
                        
                        matched_devices.forEach((device, index) => {
                            resultsHtml += `
                                <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #007bff;">
                                    <div><strong>${index + 1}. ${device.entity_id}</strong></div>
                                    <div>è®¾å¤‡åç§°: ${device.device_name || 'N/A'}</div>
                                    <div>è®¾å¤‡ç±»å‹: ${device.device_type}</div>
                                    <div>æˆ¿é—´: ${device.area_name || 'N/A'}</div>
                                    <div>æ¥¼å±‚: ${device.floor_name || 'N/A'}</div>
                                    <div>å½“å‰çŠ¶æ€: ${device.state}</div>
                                    <div>æ“ä½œåŠ¨ä½œ: ${device.action}</div>
                                    <div>åŒ¹é…ç½®ä¿¡åº¦: ${(device.match_confidence * 100).toFixed(1)}%</div>
                                </div>
                            `;
                        });
                        
                        resultsHtml += `
                                </div>
                            </div>
                        `;
                    }
                } else {
                    resultsHtml += `<div>é”™è¯¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
                }
                
                resultsHtml += `
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>å®Œæ•´å“åº”:</strong>
                        <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px;">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
                document.querySelector(`#${testId} .test-result-content`).innerHTML = resultsHtml;
                
            } catch (error) {
                document.querySelector(`#${testId} .test-result-content`).innerHTML = `
                    <div class="test-result error">
                        <div><strong>æ§åˆ¶è®¾å¤‡åŒ¹é…APIæµ‹è¯•ç»“æœ</strong></div>
                        <div>çŠ¶æ€: âŒ ç½‘ç»œé”™è¯¯</div>
                        <div>é”™è¯¯: ${error.message}</div>
                    </div>
                `;
            }
        }

        // æ¸…ç©ºæ§åˆ¶è®¾å¤‡åŒ¹é…è¾“å…¥
        function clearControlDeviceMatchingInputs() {
            document.getElementById('control-intent-input').value = '';
        }
    </script>
</body>
</html>
