<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ Intention API æµ‹è¯•æ–‡æ¡£</title>
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --secondary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --light: #f5f5f5;
            --dark: #1f2937;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.6;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
            padding: 2rem;
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .panel {
            background: var(--white);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light);
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-success {
            background: var(--success);
            color: white;
        }

        .status-error {
            background: var(--danger);
            color: white;
        }

        .status-warning {
            background: var(--warning);
            color: white;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #2563eb;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--light);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea.form-control {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        select.form-control {
            cursor: pointer;
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid var(--info);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .success-box {
            background: #f0fdf4;
            border-left: 4px solid var(--success);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .warning-box {
            background: #fffbeb;
            border-left: 4px solid var(--warning);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .error-box {
            background: #fef2f2;
            border-left: 4px solid var(--danger);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .code-block {
            background: #1f2937;
            color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            margin: 1rem 0;
            line-height: 1.6;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .api-endpoint {
            background: var(--light);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .api-method {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-weight: bold;
            font-size: 0.875rem;
            margin-right: 0.5rem;
        }

        .method-get {
            background: #3b82f6;
            color: white;
        }

        .method-post {
            background: #10b981;
            color: white;
        }

        .method-put {
            background: #f59e0b;
            color: white;
        }

        .method-delete {
            background: #ef4444;
            color: white;
        }

        .api-path {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: var(--dark);
        }

        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--light);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #6b7280;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .provider-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .provider-card {
            background: var(--light);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }

        .provider-card.selected {
            border-color: var(--primary);
            background: #f5f3ff;
        }

        .provider-card.available {
            opacity: 1;
        }

        .provider-card.unavailable {
            opacity: 0.5;
        }

        .history-item {
            background: var(--light);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-time {
            font-size: 0.875rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ¯ Intention API</h1>
            <p>æ™ºèƒ½æ„å›¾è¯†åˆ«ä¸å¤„ç†å¹³å°</p>
            <div class="stats">
                <div class="stat-card">
                    <span class="stat-number" id="totalRequests">-</span>
                    <span class="stat-label">æ€»å¤„ç†æ¬¡æ•°</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="currentProvider">-</span>
                    <span class="stat-label">å½“å‰ AI æä¾›å•†</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="lastProcessed">-</span>
                    <span class="stat-label">æœ€åå¤„ç†æ—¶é—´</span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="panel">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('process')">ğŸš€ å¤„ç†æ„å›¾</button>
                <button class="tab" onclick="switchTab('classify')">ğŸ¯ æ„å›¾åˆ†ç±»</button>
                <button class="tab" onclick="switchTab('prompt')">ğŸ“ ç³»ç»Ÿæç¤ºè¯</button>
                <button class="tab" onclick="switchTab('provider')">ğŸ¤– AI æä¾›å•†</button>
                <button class="tab" onclick="switchTab('history')">ğŸ“œ å†å²è®°å½•</button>
                <button class="tab" onclick="switchTab('docs')">ğŸ“š API æ–‡æ¡£</button>
            </div>

            <!-- Process Tab -->
            <div id="tab-process" class="tab-content active">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸš€ å¤„ç†ç”¨æˆ·æ„å›¾</h2>
                </div>

                <div class="info-box">
                    <strong>â„¹ï¸ åŠŸèƒ½è¯´æ˜ï¼š</strong>
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li>æ¥æ”¶ç”¨æˆ·è‡ªç„¶è¯­è¨€æŒ‡ä»¤</li>
                        <li>è‡ªåŠ¨é€‰æ‹©å¯ç”¨çš„ AI æä¾›å•†</li>
                        <li>è§£ææ„å›¾å¹¶è½¬æ¢ä¸º Home Assistant æœåŠ¡è°ƒç”¨</li>
                        <li>è¿”å›ç»“æ„åŒ–çš„è®¾å¤‡æ§åˆ¶æŒ‡ä»¤</li>
                    </ul>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Left Panel - Input -->
                    <div style="background: #f9fafb; padding: 1.5rem; border-radius: 0.5rem; border: 2px solid #e5e7eb;">
                        <h3 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.25rem;">ğŸ“ è¾“å…¥æ„å›¾</h3>
                        
                        <div class="form-group">
                            <label class="form-label">æ„å›¾ç±»å‹</label>
                            <select id="intentType" class="form-control">
                                <option value="message">message</option>
                                <option value="command">command</option>
                                <option value="query">query</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ç”¨æˆ·è¾“å…¥å†…å®¹</label>
                            <textarea id="intentContent" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ‰“å¼€æ‰€æœ‰ç¯" style="min-height: 300px;">æ‰“å¼€æ‰€æœ‰ç¯</textarea>
                        </div>

                        <button class="btn btn-primary" onclick="processIntention()" style="width: 100%;">
                            â–¶ï¸ å¤„ç†æ„å›¾
                        </button>
                    </div>

                    <!-- Right Panel - Output -->
                    <div style="background: #f9fafb; padding: 1.5rem; border-radius: 0.5rem; border: 2px solid #e5e7eb;">
                        <h3 style="margin-bottom: 1rem; color: var(--success); font-size: 1.25rem;">âœ¨ AI è¾“å‡ºç»“æœ</h3>
                        
                        <div id="processResult" style="min-height: 400px;">
                            <div style="text-align: center; padding: 3rem 1rem; color: #6b7280;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ¤–</div>
                                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">ç­‰å¾…å¤„ç†...</p>
                                <p style="font-size: 0.875rem;">ç‚¹å‡»å·¦ä¾§"å¤„ç†æ„å›¾"æŒ‰é’®å¼€å§‹</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Classify Tab -->
            <div id="tab-classify" class="tab-content">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸ¯ æ„å›¾åˆ†ç±»</h2>
                    <span id="classifyPromptStatus" class="status-badge"></span>
                </div>

                <div class="info-box">
                    <strong>â„¹ï¸ åŠŸèƒ½è¯´æ˜ï¼š</strong>
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li>åªåšæ„å›¾åˆ†ç±»ï¼Œä¸æå–è®¾å¤‡ä¿¡æ¯</li>
                        <li>åˆ†ç±»ä¸º6ç§æ„å›¾ç±»å‹ï¼šæŸ¥è¯¢è®¾å¤‡çŠ¶æ€ã€æ§åˆ¶è®¾å¤‡ã€åœºæ™¯æ§åˆ¶ã€è®¾å®šåœºæ™¯ã€è®¾å®šè‡ªåŠ¨åŒ–ã€å…¶ä»–</li>
                        <li>å¿«é€Ÿè¿”å›æ„å›¾ç±»å‹å’Œç½®ä¿¡åº¦</li>
                        <li>å¯ç”¨äºæ„å›¾è·¯ç”±å’Œå†³ç­–</li>
                    </ul>
                </div>

                <!-- Prompt Management Section -->
                <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #bfdbfe; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <h3 style="color: var(--secondary); font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                            ğŸ“š åˆ†ç±»æç¤ºè¯ç®¡ç†
                        </h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-success" onclick="saveClassificationPrompt()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                ğŸ’¾ ä¿å­˜
                            </button>
                            <button class="btn btn-danger" onclick="resetClassificationPrompt()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                ğŸ”„ é‡ç½®
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <textarea id="classificationPromptText" class="form-control" placeholder="åŠ è½½ä¸­..." style="min-height: 300px; font-size: 0.875rem;"></textarea>
                    </div>
                    
                    <div id="classificationPromptResult" class="hidden" style="margin-top: 1rem;"></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Left Panel - Input -->
                    <div style="background: #f9fafb; padding: 1.5rem; border-radius: 0.5rem; border: 2px solid #e5e7eb;">
                        <h3 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.25rem;">ğŸ“ è¾“å…¥æ–‡æœ¬</h3>
                        
                        <div class="form-group">
                            <label class="form-label">ç”¨æˆ·è¾“å…¥å†…å®¹</label>
                            <textarea id="classifyInput" class="form-control" placeholder="ä¾‹å¦‚ï¼šå®¢å…æ¸©åº¦å’Œæ¹¿åº¦æ˜¯å¤šå°‘" style="min-height: 200px;">å®¢å…æ¸©åº¦å’Œæ¹¿åº¦æ˜¯å¤šå°‘</textarea>
                        </div>

                        <div class="warning-box" style="font-size: 0.875rem;">
                            <strong>ğŸ’¡ ç¤ºä¾‹ï¼š</strong>
                            <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                <li>"å®¢å…ç¯å¼€ç€å—" â†’ Query Device Status</li>
                                <li>"æ‰“å¼€å®¢å…ç¯" â†’ Control Device</li>
                                <li>"å¯åŠ¨è§‚å½±æ¨¡å¼" â†’ Control Scene</li>
                                <li>"åˆ›å»ºä¸€ä¸ªè§‚å½±åœºæ™¯" â†’ Set Scene</li>
                                <li>"æ™šä¸Š7ç‚¹è‡ªåŠ¨å¼€ç¯" â†’ Set Automation</li>
                            </ul>
                        </div>

                        <button class="btn btn-primary" onclick="classifyIntention()" style="width: 100%;">
                            ğŸ¯ åˆ†ç±»æ„å›¾
                        </button>
                    </div>

                    <!-- Right Panel - Output -->
                    <div style="background: #f9fafb; padding: 1.5rem; border-radius: 0.5rem; border: 2px solid #e5e7eb;">
                        <h3 style="margin-bottom: 1rem; color: var(--success); font-size: 1.25rem;">âœ¨ åˆ†ç±»ç»“æœ</h3>
                        
                        <div id="classifyResult" style="min-height: 400px;">
                            <div style="text-align: center; padding: 3rem 1rem; color: #6b7280;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ¯</div>
                                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">ç­‰å¾…åˆ†ç±»...</p>
                                <p style="font-size: 0.875rem;">ç‚¹å‡»å·¦ä¾§"åˆ†ç±»æ„å›¾"æŒ‰é’®å¼€å§‹</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prompt Tab -->
            <div id="tab-prompt" class="tab-content">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸ“ ç³»ç»Ÿæç¤ºè¯ç®¡ç†</h2>
                    <span id="promptStatus" class="status-badge"></span>
                </div>

                <div class="warning-box">
                    <strong>âš ï¸ æ³¨æ„ï¼š</strong> ä¿®æ”¹ç³»ç»Ÿæç¤ºè¯å°†å½±å“ AI å¯¹ç”¨æˆ·æ„å›¾çš„ç†è§£å’Œè§£æã€‚è¯·ç¡®ä¿æç¤ºè¯å‡†ç¡®æè¿°äº†éœ€æ±‚ã€‚
                </div>

                <div class="form-group">
                    <label class="form-label">ç³»ç»Ÿæç¤ºè¯</label>
                    <textarea id="systemPrompt" class="form-control" placeholder="åŠ è½½ä¸­..." style="min-height: 400px;"></textarea>
                </div>

                <div class="grid-2">
                    <button class="btn btn-success" onclick="savePrompt()">
                        ğŸ’¾ ä¿å­˜è‡ªå®šä¹‰æç¤ºè¯
                    </button>
                    <button class="btn btn-danger" onclick="resetPrompt()">
                        ğŸ”„ æ¢å¤é»˜è®¤æç¤ºè¯
                    </button>
                </div>

                <div id="promptResult" class="hidden" style="margin-top: 1.5rem;"></div>
            </div>

            <!-- Provider Tab -->
            <div id="tab-provider" class="tab-content">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸ¤– AI æä¾›å•†é…ç½®</h2>
                </div>

                <div class="info-box">
                    <strong>â„¹ï¸ æä¾›å•†é€‰æ‹©ï¼š</strong>
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li><strong>è‡ªåŠ¨é€‰æ‹©ï¼š</strong>ç³»ç»Ÿä¼šè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨çš„ AI æä¾›å•†</li>
                        <li><strong>æ‰‹åŠ¨é€‰æ‹©ï¼š</strong>å¯ä»¥æŒ‡å®šä½¿ç”¨æŸä¸ªç‰¹å®šçš„ AI æä¾›å•†</li>
                        <li><strong>å¯ç”¨æ€§ï¼š</strong>åªæœ‰é…ç½®äº†å‡­æ®çš„æä¾›å•†æ‰èƒ½ä½¿ç”¨</li>
                    </ul>
                </div>

                <div class="form-group">
                    <label class="form-label">é€‰æ‹© AI æä¾›å•†</label>
                    <div class="provider-list" id="providerList">
                        <div class="loading"></div> åŠ è½½ä¸­...
                    </div>
                </div>

                <div id="providerResult" class="hidden" style="margin-top: 1.5rem;"></div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="tab-content">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸ“œ å¤„ç†å†å²è®°å½•</h2>
                    <button class="btn btn-secondary" onclick="loadHistory()">
                        ğŸ”„ åˆ·æ–°
                    </button>
                </div>

                <div id="historyContainer">
                    <p style="text-align: center; color: #6b7280;">ç‚¹å‡»"åˆ·æ–°"åŠ è½½å†å²è®°å½•</p>
                </div>
            </div>

            <!-- Docs Tab -->
            <div id="tab-docs" class="tab-content">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸ“š API æ–‡æ¡£</h2>
                </div>

                <h3 style="margin-bottom: 1rem;">å¯ç”¨çš„ API ç«¯ç‚¹</h3>

                <div class="api-endpoint">
                    <div><span class="api-method method-post">POST</span><span class="api-path">/api/intention/intention/classify</span></div>
                    <p style="margin-top: 0.5rem; color: #6b7280;">æ„å›¾åˆ†ç±»ï¼ˆä»…åˆ†ç±»ï¼Œä¸æå–è®¾å¤‡ä¿¡æ¯ï¼‰</p>
                    <div class="code-block">POST /api/intention/intention/classify
Content-Type: application/json

// æ–°æ ¼å¼ (æ¨è)
{
  "type": "message",
  "content": "æˆ‘å›å®¶äº†",
  "metadata": {},
  "timestamp": "2025-10-27T14:43:54.644Z"
}

// æ—§æ ¼å¼ (ä»ç„¶æ”¯æŒï¼Œå‘åå…¼å®¹)
{
  "user_input": "å®¢å…æ¸©åº¦å’Œæ¹¿åº¦æ˜¯å¤šå°‘"
}

// Response
{
  "success": true,
  "data": {
    "user_input": "æˆ‘å›å®¶äº†",
    "intent": "Control Scene",
    "confidence": 0.9,
    "user_responds": "æ¬¢è¿å›å®¶ï¼Œæ­£åœ¨ä¸ºæ‚¨æ‰§è¡Œå›å®¶åœºæ™¯",
    "ai_provider": "gemini",
    "classified_at": "2025-10-27T15:28:02.000Z",
    "input_metadata": {
      "type": "message",
      "metadata": {},
      "timestamp": "2025-10-27T14:43:54.644Z"
    },
    "performance": {
      "total_duration_ms": 1250,
      "ai_call_duration_ms": 1180,
      "token_usage": {
        "prompt_tokens": 450,
        "completion_tokens": 85,
        "total_tokens": 535
      }
    }
  }
}</div>
                </div>

                <div class="api-endpoint">
                    <div><span class="api-method method-post">POST</span><span class="api-path">/api/intention/intention/process</span></div>
                    <p style="margin-top: 0.5rem; color: #6b7280;">å¤„ç†ç”¨æˆ·æ„å›¾</p>
                    <div class="code-block">POST /api/intention/intention/process
Content-Type: application/json

{
  "type": "message",
  "content": "æ‰“å¼€æ‰€æœ‰ç¯",
  "metadata": {},
  "timestamp": "2025-10-25T15:28:01.491Z"
}

// Response
{
  "success": true,
  "data": {
    "user_input": "æ‰“å¼€æ‰€æœ‰ç¯",
    "intent": "Control Device",
    "devices": [{
      "floor_name": "",
      "floor_name_en": "",
      "floor_type": "",
      "room_type": "",
      "room_name": "",
      "room_name_en": "",
      "device_type": "light",
      "device_name": "",
      "device_name_en": "",
      "service": "light.turn_on",
      "service_data": {}
    }],
    "confidence": 0.95,
    "user_responds": "å¥½çš„ï¼Œå³å°†ä¸ºæ‚¨æ‰“å¼€æ‰€æœ‰ç¯å…‰",
    "ai_provider": "gemini",
    "processed_at": "2025-10-25T15:28:02.000Z"
  }
}</div>
                </div>

                <div class="api-endpoint">
                    <div><span class="api-method method-get">GET</span><span class="api-path">/api/intention/intention/history?limit=50</span></div>
                    <p style="margin-top: 0.5rem; color: #6b7280;">è·å–å¤„ç†å†å²è®°å½•</p>
                    <div class="code-block">GET /api/intention/intention/history?limit=50

// Response
{
  "success": true,
  "data": {
    "total": 10,
    "intentions": [...]
  }
}</div>
                </div>

                <div class="api-endpoint">
                    <div><span class="api-method method-get">GET</span><span class="api-path">/api/intention/intention/prompt</span></div>
                    <p style="margin-top: 0.5rem; color: #6b7280;">è·å–å½“å‰ç³»ç»Ÿæç¤ºè¯</p>
                    <div class="code-block">GET /api/intention/intention/prompt

// Response
{
  "success": true,
  "data": {
    "prompt": "...",
    "is_custom": false
  }
}</div>
                </div>

                <div class="api-endpoint">
                    <div><span class="api-method method-put">PUT</span><span class="api-path">/api/intention/intention/prompt</span></div>
                    <p style="margin-top: 0.5rem; color: #6b7280;">ä¿å­˜è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯</p>
                    <div class="code-block">PUT /api/intention/intention/prompt
Content-Type: application/json

{
  "prompt": "Your custom system prompt here..."
}</div>
                </div>

                <div class="api-endpoint">
                    <div><span class="api-method method-delete">DELETE</span><span class="api-path">/api/intention/intention/prompt</span></div>
                    <p style="margin-top: 0.5rem; color: #6b7280;">åˆ é™¤è‡ªå®šä¹‰æç¤ºè¯ï¼Œæ¢å¤é»˜è®¤</p>
                    <div class="code-block">DELETE /api/intention/intention/prompt</div>
                </div>

                <div class="api-endpoint">
                    <div><span class="api-method method-get">GET</span><span class="api-path">/api/intention/intention/ai-provider</span></div>
                    <p style="margin-top: 0.5rem; color: #6b7280;">è·å– AI æä¾›å•†é…ç½®</p>
                    <div class="code-block">GET /api/intention/intention/ai-provider

// Response
{
  "success": true,
  "data": {
    "current": "auto",
    "available": [
      {"name": "claude", "available": false},
      {"name": "openai", "available": true},
      {"name": "gemini", "available": true},
      {"name": "deepseek", "available": true}
    ]
  }
}</div>
                </div>

                <div class="api-endpoint">
                    <div><span class="api-method method-post">POST</span><span class="api-path">/api/intention/intention/ai-provider</span></div>
                    <p style="margin-top: 0.5rem; color: #6b7280;">è®¾ç½® AI æä¾›å•†</p>
                    <div class="code-block">POST /api/intention/intention/ai-provider
Content-Type: application/json

{
  "provider": "auto"  // auto | claude | openai | gemini | deepseek
}</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/intention/intention';

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Show selected tab
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Load data for specific tabs
            if (tabName === 'prompt') {
                loadPrompt();
            } else if (tabName === 'provider') {
                loadProviderConfig();
            } else if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'classify') {
                loadClassificationPrompt();
            }
        }

        // Initialize
        async function init() {
            await loadStats();
        }

        // Load statistics
        async function loadStats() {
            try {
                const [historyRes, providerRes] = await Promise.all([
                    fetch(`${API_BASE}/history?limit=1`),
                    fetch(`${API_BASE}/ai-provider`)
                ]);

                const historyData = await historyRes.json();
                const providerData = await providerRes.json();

                if (historyData.success && historyData.data) {
                    document.getElementById('totalRequests').textContent = historyData.data.total || 0;
                    
                    if (historyData.data.intentions && historyData.data.intentions.length > 0) {
                        const lastIntent = historyData.data.intentions[0];
                        const timestamp = lastIntent.timestamp;
                        if (timestamp) {
                            const date = new Date(timestamp);
                            document.getElementById('lastProcessed').textContent = date.toLocaleString('zh-CN');
                        } else {
                            document.getElementById('lastProcessed').textContent = 'ä»æœª';
                        }
                    } else {
                        document.getElementById('lastProcessed').textContent = 'ä»æœª';
                    }
                }

                if (providerData.success && providerData.data) {
                    const currentProvider = providerData.data.current || 'auto';
                    const providerDisplay = currentProvider === 'auto' ? 'è‡ªåŠ¨é€‰æ‹©' : currentProvider.toUpperCase();
                    document.getElementById('currentProvider').textContent = providerDisplay;
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Process intention
        async function processIntention() {
            const type = document.getElementById('intentType').value;
            const content = document.getElementById('intentContent').value;
            const resultDiv = document.getElementById('processResult');

            if (!content.trim()) {
                resultDiv.innerHTML = `
                    <div class="error-box">
                        <strong>âŒ é”™è¯¯ï¼š</strong> è¯·è¾“å…¥ç”¨æˆ·å†…å®¹
                    </div>
                `;
                return;
            }

            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 3rem 1rem; color: #6b7280;">
                    <div class="loading" style="display: inline-block; margin-bottom: 1rem;"></div>
                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">ğŸ¤– AI æ­£åœ¨æ€è€ƒ...</p>
                    <p style="font-size: 0.875rem;">å¤„ç†æ„å›¾å¹¶ç”Ÿæˆç»“æ„åŒ–æ•°æ®</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/process`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type,
                        content,
                        metadata: {},
                        timestamp: new Date().toISOString()
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const result = data.data;
                    
                    // Build device cards
                    let devicesHtml = '';
                    if (result.devices && result.devices.length > 0) {
                        devicesHtml = result.devices.map((device, index) => `
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem; border-left: 4px solid var(--primary);">
                                <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary);">
                                    ğŸ”§ è®¾å¤‡ ${index + 1}
                                </div>
                                <div style="font-size: 0.875rem; line-height: 1.8;">
                                    ${device.floor_name ? `<div>ğŸ“ <strong>æ¥¼å±‚:</strong> ${device.floor_name}</div>` : ''}
                                    ${device.room_name ? `<div>ğŸ  <strong>æˆ¿é—´:</strong> ${device.room_name}</div>` : ''}
                                    ${device.device_type ? `<div>ğŸ’¡ <strong>è®¾å¤‡ç±»å‹:</strong> ${device.device_type}</div>` : ''}
                                    ${device.device_name ? `<div>ğŸ“± <strong>è®¾å¤‡åç§°:</strong> ${device.device_name}</div>` : ''}
                                    ${device.service ? `<div>âš™ï¸ <strong>æœåŠ¡:</strong> <code style="background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 0.25rem;">${device.service}</code></div>` : ''}
                                </div>
                            </div>
                        `).join('');
                    }

                    resultDiv.innerHTML = `
                        <div style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--success); margin-bottom: 1rem;">
                            <div style="font-weight: 600; color: var(--success); margin-bottom: 0.5rem;">
                                âœ… å¤„ç†æˆåŠŸ
                            </div>
                            <div style="font-size: 0.875rem; color: #166534;">
                                ${result.user_responds || 'å¤„ç†å®Œæˆ'}
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <span class="status-badge status-success">æ„å›¾: ${result.intent}</span>
                                <span class="status-badge" style="background: var(--warning); color: white;">ç½®ä¿¡åº¦: ${(result.confidence * 100).toFixed(0)}%</span>
                                <span class="status-badge" style="background: var(--info); color: white;">AI: ${result.ai_provider || 'unknown'}</span>
                            </div>
                        </div>

                        ${devicesHtml ? `
                            <div style="margin-bottom: 1rem;">
                                <div style="font-weight: 600; margin-bottom: 0.75rem; color: var(--dark);">
                                    ğŸ¯ è¯†åˆ«çš„è®¾å¤‡ (${result.devices.length}ä¸ª)
                                </div>
                                ${devicesHtml}
                            </div>
                        ` : ''}

                        <div style="margin-top: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--dark); display: flex; align-items: center; gap: 0.5rem;">
                                ğŸ“‹ å®Œæ•´ JSON æ•°æ®
                                <button onclick="copyToClipboard(this)" style="padding: 0.25rem 0.75rem; background: var(--secondary); color: white; border: none; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer;">
                                    ğŸ“‹ å¤åˆ¶
                                </button>
                            </div>
                            <div class="code-block" style="max-height: 400px; overflow-y: auto; font-size: 0.8rem; line-height: 1.6;">
<pre style="margin: 0;">${syntaxHighlightJson(result)}</pre>
                            </div>
                        </div>
                    `;
                    
                    await loadStats();
                } else {
                    resultDiv.innerHTML = `
                        <div class="error-box">
                            <strong>âŒ é”™è¯¯ï¼š</strong> ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error-box">
                        <strong>âŒ è¯·æ±‚å¤±è´¥ï¼š</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Classify intention
        async function classifyIntention() {
            const userInput = document.getElementById('classifyInput').value;
            const resultDiv = document.getElementById('classifyResult');

            if (!userInput.trim()) {
                resultDiv.innerHTML = `
                    <div class="error-box">
                        <strong>âŒ é”™è¯¯ï¼š</strong> è¯·è¾“å…¥ç”¨æˆ·å†…å®¹
                    </div>
                `;
                return;
            }

            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 3rem 1rem; color: #6b7280;">
                    <div class="loading" style="display: inline-block; margin-bottom: 1rem;"></div>
                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">ğŸ¯ æ­£åœ¨åˆ†ç±»æ„å›¾...</p>
                    <p style="font-size: 0.875rem;">AI æ­£åœ¨è¯†åˆ«æ„å›¾ç±»å‹</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/classify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_input: userInput })
                });

                const data = await response.json();

                if (data.success) {
                    const result = data.data;
                    
                    // Intent icon mapping
                    const intentIcons = {
                        'Query Device Status': 'â“',
                        'Control Device': 'ğŸ›ï¸',
                        'Control Scene': 'ğŸ¬',
                        'Set Scene': 'ğŸ¨',
                        'Set Automation': 'âš™ï¸',
                        'Other': 'ğŸ“'
                    };

                    // Intent color mapping
                    const intentColors = {
                        'Query Device Status': '#3b82f6',
                        'Control Device': '#10b981',
                        'Control Scene': '#8b5cf6',
                        'Set Scene': '#f59e0b',
                        'Set Automation': '#ef4444',
                        'Other': '#6b7280'
                    };

                    const intentIcon = intentIcons[result.intent] || 'ğŸ“';
                    const intentColor = intentColors[result.intent] || '#6b7280';

                    // Performance metrics
                    const performance = result.performance || {};
                    const totalDuration = performance.total_duration_ms || 0;
                    const aiDuration = performance.ai_call_duration_ms || 0;
                    const tokenUsage = performance.token_usage || {};
                    const totalTokens = tokenUsage.total_tokens || 0;
                    const promptTokens = tokenUsage.prompt_tokens || 0;
                    const completionTokens = tokenUsage.completion_tokens || 0;

                    resultDiv.innerHTML = `
                        <div style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--success); margin-bottom: 1.5rem;">
                            <div style="font-weight: 600; color: var(--success); margin-bottom: 0.5rem;">
                                âœ… åˆ†ç±»æˆåŠŸ
                            </div>
                            <div style="font-size: 0.875rem; color: #166534;">
                                ${result.user_responds || 'åˆ†ç±»å®Œæˆ'}
                            </div>
                        </div>

                        <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${intentColor}; margin-bottom: 1.5rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">
                                    ${intentIcon}
                                </div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${intentColor}; margin-bottom: 0.5rem;">
                                    ${result.intent}
                                </div>
                                <div style="font-size: 2rem; font-weight: 600; color: var(--dark);">
                                    ${(result.confidence * 100).toFixed(0)}%
                                </div>
                                <div style="font-size: 0.875rem; color: #6b7280;">
                                    ç½®ä¿¡åº¦
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center;">
                                <span class="status-badge" style="background: ${intentColor}; color: white;">æ„å›¾: ${result.intent}</span>
                                <span class="status-badge" style="background: var(--warning); color: white;">ç½®ä¿¡åº¦: ${(result.confidence * 100).toFixed(0)}%</span>
                                <span class="status-badge" style="background: var(--info); color: white;">AI: ${result.ai_provider || 'unknown'}</span>
                            </div>
                        </div>

                        <!-- Performance Metrics -->
                        ${totalDuration > 0 ? `
                        <div style="background: #fffbeb; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #fde68a; margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #92400e; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                                âš¡ æ€§èƒ½æŒ‡æ ‡
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.8rem;">
                                <div style="background: white; padding: 0.4rem 0.6rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 0.4rem;">
                                    <span style="color: #6b7280;">â±ï¸</span>
                                    <span style="font-weight: 600; color: var(--primary);">${totalDuration}ms</span>
                                    <span style="color: #9ca3af; font-size: 0.75rem;">æ€»è€—æ—¶</span>
                                </div>
                                <div style="background: white; padding: 0.4rem 0.6rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 0.4rem;">
                                    <span style="color: #6b7280;">ğŸ¤–</span>
                                    <span style="font-weight: 600; color: var(--secondary);">${aiDuration}ms</span>
                                    <span style="color: #9ca3af; font-size: 0.75rem;">AI</span>
                                </div>
                                ${totalTokens > 0 ? `
                                <div style="background: white; padding: 0.4rem 0.6rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 0.4rem;">
                                    <span style="color: #6b7280;">ğŸ«</span>
                                    <span style="font-weight: 600; color: var(--success);">${totalTokens}</span>
                                    <span style="color: #9ca3af; font-size: 0.75rem;">Token</span>
                                </div>
                                ` : ''}
                                ${promptTokens > 0 ? `
                                <div style="background: white; padding: 0.4rem 0.6rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 0.4rem;">
                                    <span style="color: #6b7280;">ğŸ“¥</span>
                                    <span style="font-weight: 600; color: var(--info);">${promptTokens}</span>
                                    <span style="color: #9ca3af; font-size: 0.75rem;">è¾“å…¥</span>
                                </div>
                                ` : ''}
                                ${completionTokens > 0 ? `
                                <div style="background: white; padding: 0.4rem 0.6rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 0.4rem;">
                                    <span style="color: #6b7280;">ğŸ“¤</span>
                                    <span style="font-weight: 600; color: var(--warning);">${completionTokens}</span>
                                    <span style="color: #9ca3af; font-size: 0.75rem;">è¾“å‡º</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}

                        <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--dark);">
                                ğŸ“ ç”¨æˆ·è¾“å…¥
                            </div>
                            <div style="font-size: 0.875rem; color: #374151;">
                                ${result.user_input}
                            </div>
                        </div>

                        <!-- Classification Prompt -->
                        <div style="background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; border: 1px solid #bfdbfe; margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--dark); display: flex; align-items: center; gap: 0.5rem; cursor: pointer;" onclick="toggleClassificationPrompt(this)">
                                <span id="promptToggleIcon">â–¶</span>
                                ğŸ“š åˆ†ç±»æç¤ºè¯
                                <span style="font-size: 0.75rem; color: #6b7280; font-weight: normal;">(ç‚¹å‡»å±•å¼€/æ”¶èµ·)</span>
                            </div>
                            <div id="classificationPromptContent" style="display: none; margin-top: 0.75rem;">
                                <div class="code-block" style="max-height: 400px; overflow-y: auto; font-size: 0.75rem; line-height: 1.6; white-space: pre-wrap;">
${getClassificationPromptText()}
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--dark); display: flex; align-items: center; gap: 0.5rem;">
                                ğŸ“‹ å®Œæ•´ JSON æ•°æ®
                                <button onclick="copyToClipboard(this)" style="padding: 0.25rem 0.75rem; background: var(--secondary); color: white; border: none; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer;">
                                    ğŸ“‹ å¤åˆ¶
                                </button>
                            </div>
                            <div class="code-block" style="max-height: 300px; overflow-y: auto; font-size: 0.8rem; line-height: 1.6;">
<pre style="margin: 0;">${syntaxHighlightJson(result)}</pre>
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error-box">
                            <strong>âŒ é”™è¯¯ï¼š</strong> ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error-box">
                        <strong>âŒ è¯·æ±‚å¤±è´¥ï¼š</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Load prompt
        async function loadPrompt() {
            const textarea = document.getElementById('systemPrompt');
            const statusBadge = document.getElementById('promptStatus');

            try {
                const response = await fetch(`${API_BASE}/prompt`);
                const data = await response.json();

                if (data.success) {
                    textarea.value = data.data.prompt;
                    statusBadge.textContent = data.data.is_custom ? 'è‡ªå®šä¹‰' : 'é»˜è®¤';
                    statusBadge.className = `status-badge ${data.data.is_custom ? 'status-warning' : 'status-success'}`;
                }
            } catch (error) {
                textarea.value = 'åŠ è½½å¤±è´¥: ' + error.message;
            }
        }

        // Save prompt
        async function savePrompt() {
            const prompt = document.getElementById('systemPrompt').value;
            const resultDiv = document.getElementById('promptResult');

            if (!prompt.trim()) {
                resultDiv.className = 'error-box';
                resultDiv.innerHTML = '<strong>âŒ é”™è¯¯ï¼š</strong> æç¤ºè¯ä¸èƒ½ä¸ºç©º';
                resultDiv.classList.remove('hidden');
                return;
            }

            resultDiv.className = 'info-box';
            resultDiv.innerHTML = '<div class="loading"></div> ä¿å­˜ä¸­...';
            resultDiv.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/prompt`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'success-box';
                    resultDiv.innerHTML = '<strong>âœ… ä¿å­˜æˆåŠŸï¼</strong> è‡ªå®šä¹‰æç¤ºè¯å·²ä¿å­˜ã€‚';
                    await loadPrompt();
                } else {
                    resultDiv.className = 'error-box';
                    resultDiv.innerHTML = `<strong>âŒ é”™è¯¯ï¼š</strong> ${data.error}`;
                }
            } catch (error) {
                resultDiv.className = 'error-box';
                resultDiv.innerHTML = `<strong>âŒ è¯·æ±‚å¤±è´¥ï¼š</strong> ${error.message}`;
            }
        }

        // Reset prompt
        async function resetPrompt() {
            if (!confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤æç¤ºè¯å—ï¼Ÿè¿™å°†åˆ é™¤æ‚¨çš„è‡ªå®šä¹‰æç¤ºè¯ã€‚')) {
                return;
            }

            const resultDiv = document.getElementById('promptResult');
            resultDiv.className = 'info-box';
            resultDiv.innerHTML = '<div class="loading"></div> é‡ç½®ä¸­...';
            resultDiv.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/prompt`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'success-box';
                    resultDiv.innerHTML = '<strong>âœ… é‡ç½®æˆåŠŸï¼</strong> å·²æ¢å¤é»˜è®¤æç¤ºè¯ã€‚';
                    await loadPrompt();
                } else {
                    resultDiv.className = 'error-box';
                    resultDiv.innerHTML = `<strong>âŒ é”™è¯¯ï¼š</strong> ${data.error}`;
                }
            } catch (error) {
                resultDiv.className = 'error-box';
                resultDiv.innerHTML = `<strong>âŒ è¯·æ±‚å¤±è´¥ï¼š</strong> ${error.message}`;
            }
        }

        // Load provider configuration
        async function loadProviderConfig() {
            const container = document.getElementById('providerList');
            container.innerHTML = '<div style="text-align: center;"><div class="loading"></div> åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/ai-provider`);
                const data = await response.json();

                if (data.success && data.data) {
                    const { current, available } = data.data;
                    
                    let html = `
                        <div class="provider-card ${current === 'auto' ? 'selected' : 'available'}" onclick="selectProvider('auto')">
                            <div style="font-size: 2rem;">ğŸ¤–</div>
                            <div style="font-weight: 600; margin-top: 0.5rem;">è‡ªåŠ¨é€‰æ‹©</div>
                            ${current === 'auto' ? '<div style="color: var(--primary); font-size: 0.75rem; margin-top: 0.25rem;">âœ“ å½“å‰</div>' : ''}
                        </div>
                    `;

                    const providerIcons = {
                        'claude': 'ğŸ§ ',
                        'openai': 'ğŸ¤–',
                        'gemini': 'âœ¨',
                        'deepseek': 'ğŸ”'
                    };

                    available.forEach(p => {
                        const isSelected = current === p.name;
                        const className = `provider-card ${isSelected ? 'selected' : ''} ${p.available ? 'available' : 'unavailable'}`;
                        html += `
                            <div class="${className}" onclick="selectProvider('${p.name}')">
                                <div style="font-size: 2rem;">${providerIcons[p.name] || 'ğŸ¤–'}</div>
                                <div style="font-weight: 600; margin-top: 0.5rem; text-transform: uppercase;">${p.name}</div>
                                ${isSelected ? '<div style="color: var(--primary); font-size: 0.75rem; margin-top: 0.25rem;">âœ“ å½“å‰</div>' : ''}
                                ${!p.available ? '<div style="color: var(--danger); font-size: 0.75rem; margin-top: 0.25rem;">æœªé…ç½®</div>' : ''}
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="error-box">åŠ è½½å¤±è´¥</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error-box">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // Select provider
        async function selectProvider(provider) {
            const resultDiv = document.getElementById('providerResult');
            resultDiv.className = 'info-box';
            resultDiv.innerHTML = '<div class="loading"></div> è®¾ç½®ä¸­...';
            resultDiv.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/ai-provider`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider })
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'success-box';
                    resultDiv.innerHTML = `<strong>âœ… è®¾ç½®æˆåŠŸï¼</strong> AI æä¾›å•†å·²è®¾ç½®ä¸º: ${provider}`;
                    await loadProviderConfig();
                    await loadStats();
                } else {
                    resultDiv.className = 'error-box';
                    resultDiv.innerHTML = `<strong>âŒ é”™è¯¯ï¼š</strong> ${data.error}`;
                }
            } catch (error) {
                resultDiv.className = 'error-box';
                resultDiv.innerHTML = `<strong>âŒ è¯·æ±‚å¤±è´¥ï¼š</strong> ${error.message}`;
            }
        }

        // Load history
        async function loadHistory() {
            const container = document.getElementById('historyContainer');
            container.innerHTML = '<div style="text-align: center;"><div class="loading"></div> åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/history?limit=20`);
                const data = await response.json();

                if (data.success && data.data) {
                    const { total, intentions } = data.data;

                    if (intentions.length === 0) {
                        container.innerHTML = '<div class="warning-box"><strong>âš ï¸ æš‚æ— å†å²è®°å½•</strong><br>è¯·å…ˆå¤„ç†ä¸€äº›æ„å›¾ã€‚</div>';
                        return;
                    }

                    let html = `
                        <div class="info-box">
                            <strong>ğŸ“Š æ€»è®¡ï¼š</strong> ${total} æ¡è®°å½•
                        </div>
                    `;

                    intentions.forEach(item => {
                        const timestamp = new Date(item.timestamp).toLocaleString('zh-CN');
                        html += `
                            <div class="history-item">
                                <div class="history-header">
                                    <span style="font-weight: 600;">${item.input.content}</span>
                                    <span class="history-time">${timestamp}</span>
                                </div>
                                <div style="margin-top: 0.5rem;">
                                    <span class="status-badge status-success">æ„å›¾: ${item.output.intent}</span>
                                    <span class="status-badge" style="background: var(--info); color: white;">AI: ${item.ai_provider}</span>
                                    <span class="status-badge" style="background: var(--warning); color: white;">ç½®ä¿¡åº¦: ${(item.output.confidence * 100).toFixed(0)}%</span>
                                </div>
                                <div class="code-block" style="margin-top: 0.75rem; max-height: 300px; overflow-y: auto;">
${JSON.stringify(item.output, null, 2)}
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="error-box">åŠ è½½å¤±è´¥</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error-box">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // Syntax highlighting for JSON
        function syntaxHighlightJson(obj) {
            const json = JSON.stringify(obj, null, 2);

            return json
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    let cls = 'json-number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'json-key';
                        } else {
                            cls = 'json-string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'json-boolean';
                    } else if (/null/.test(match)) {
                        cls = 'json-null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
        }

        // Copy to clipboard
        function copyToClipboard(button) {
            const codeBlock = button.parentElement.nextElementSibling;
            const pre = codeBlock.querySelector('pre');
            const text = pre ? pre.textContent : codeBlock.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'âœ… å·²å¤åˆ¶';
                button.style.background = 'var(--success)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = 'var(--secondary)';
                }, 2000);
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥: ' + err);
            });
        }

        // Toggle classification prompt
        function toggleClassificationPrompt(element) {
            const content = document.getElementById('classificationPromptContent');
            const icon = document.getElementById('promptToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                icon.textContent = 'â–¶';
            }
        }

        // Get classification prompt text
        function getClassificationPromptText() {
            return `# Home Assistantæ„å›¾åˆ†ç±»ä¸“å®¶

å°†ç”¨æˆ·çš„æ™ºèƒ½å®¶å±…æŒ‡ä»¤åˆ†ç±»ä¸ºä»¥ä¸‹6ç§æ„å›¾ï¼š

## æ„å›¾åˆ†ç±»

- **Query Device Status**: æŸ¥è¯¢è®¾å¤‡çŠ¶æ€ï¼ˆå¦‚ï¼š"å®¢å…ç¯å¼€ç€å—"ã€"æ¸©åº¦æ˜¯å¤šå°‘"ï¼‰
- **Control Device**: æ§åˆ¶è®¾å¤‡ï¼ˆå¦‚ï¼š"æ‰“å¼€å®¢å…ç¯"ã€"å…³é—­ç©ºè°ƒ"ï¼‰
- **Control Scene**: åœºæ™¯æ§åˆ¶/æ‰§è¡Œåœºæ™¯ï¼ˆå¦‚ï¼š"å¯åŠ¨è§‚å½±æ¨¡å¼"ã€"æ‰§è¡Œç¡çœ åœºæ™¯"ã€"æˆ‘å›å®¶äº†"ã€"ç¦»å®¶æ¨¡å¼"ï¼‰
- **Set Scene**: è®¾å®šåœºæ™¯ï¼ˆå¦‚ï¼š"åˆ›å»ºä¸€ä¸ªè§‚å½±åœºæ™¯"ã€"è®¾ç½®å›å®¶åœºæ™¯"ï¼‰
- **Set Automation**: è®¾å®šè‡ªåŠ¨åŒ–è§„åˆ™ï¼ˆå¦‚ï¼š"æ™šä¸Š7ç‚¹è‡ªåŠ¨å¼€ç¯"ã€"å½“æ¸©åº¦ä½äº20åº¦æ—¶æ‰“å¼€æš–æ°”"ï¼‰
- **Other**: å…¶ä»–

## é‡è¦åŒºåˆ†è§„åˆ™

### Control Scene vs Set Automation
- **Control Scene**: ç”¨æˆ·æƒ³è¦**ç«‹å³æ‰§è¡Œ/è§¦å‘**ä¸€ä¸ªåœºæ™¯æˆ–æ¨¡å¼
  - å…³é”®è¯ï¼šå¯åŠ¨ã€æ‰§è¡Œã€å¼€å¯ã€æ¿€æ´»ã€è§¦å‘ã€è¿›å…¥ã€æˆ‘XXäº†
  - ç¤ºä¾‹ï¼š
    - "å¯åŠ¨è§‚å½±æ¨¡å¼" â†’ Control Scene
    - "æˆ‘å›å®¶äº†" â†’ Control Sceneï¼ˆè§¦å‘å›å®¶åœºæ™¯ï¼‰
    - "ç¦»å®¶æ¨¡å¼" â†’ Control Scene
    - "ç¡çœ æ¨¡å¼" â†’ Control Scene
    - "è¿›å…¥ä¼šå®¢æ¨¡å¼" â†’ Control Scene
    
- **Set Automation**: ç”¨æˆ·æƒ³è¦**è®¾ç½®/åˆ›å»º**ä¸€ä¸ªè‡ªåŠ¨åŒ–è§„åˆ™ï¼ˆé€šå¸¸åŒ…å«æ—¶é—´/æ¡ä»¶ï¼‰
  - å…³é”®è¯ï¼šè‡ªåŠ¨ã€å®šæ—¶ã€å½“...æ—¶ã€æ¯å¤©ã€æ¯å‘¨ã€å¦‚æœ...å°±
  - ç¤ºä¾‹ï¼š
    - "æ™šä¸Š7ç‚¹è‡ªåŠ¨å¼€ç¯" â†’ Set Automation
    - "å½“æ¸©åº¦ä½äº20åº¦æ—¶æ‰“å¼€æš–æ°”" â†’ Set Automation
    - "æ¯å¤©æ—©ä¸Š8ç‚¹æ‰“å¼€çª—å¸˜" â†’ Set Automation
    - "å›å®¶æ—¶è‡ªåŠ¨å¼€ç¯" â†’ Set Automationï¼ˆæ³¨æ„ï¼šè¿™æ˜¯è®¾ç½®è§„åˆ™ï¼Œä¸æ˜¯æ‰§è¡Œï¼‰

### Control Device vs Control Scene
- **Control Device**: æ“ä½œå•ä¸ªæˆ–å¤šä¸ªå…·ä½“è®¾å¤‡
  - ç¤ºä¾‹ï¼š
    - "æ‰“å¼€å®¢å…ç¯" â†’ Control Device
    - "å…³é—­æ‰€æœ‰ç¯" â†’ Control Device
    
- **Control Scene**: æ‰§è¡Œé¢„è®¾çš„åœºæ™¯æ¨¡å¼ï¼ˆé€šå¸¸åŒ…å«å¤šä¸ªè®¾å¤‡çš„ååŒæ“ä½œï¼‰
  - ç¤ºä¾‹ï¼š
    - "è§‚å½±æ¨¡å¼" â†’ Control Scene
    - "æˆ‘å›æ¥äº†" â†’ Control Scene

## è¾“å‡ºæ ¼å¼
\`\`\`json
{
  "user_input": "ç”¨æˆ·åŸå§‹è¾“å…¥",
  "intent": "æ„å›¾ç±»å‹",
  "confidence": 0.0-1.0,
  "user_responds": "ç®€çŸ­å›åº”ï¼Œè¯­è¨€ä¸è¾“å…¥ä¸€è‡´"
}
\`\`\`

## ç¤ºä¾‹

**è¾“å…¥**: "å®¢å…æ¸©åº¦å’Œæ¹¿åº¦æ˜¯å¤šå°‘"
\`\`\`json
{
  "user_input": "å®¢å…æ¸©åº¦å’Œæ¹¿åº¦æ˜¯å¤šå°‘",
  "intent": "Query Device Status",
  "confidence": 0.9,
  "user_responds": "å¥½çš„ï¼Œæˆ‘å¸®æ‚¨æŸ¥çœ‹å®¢å…çš„æ¸©åº¦å’Œæ¹¿åº¦"
}
\`\`\`

**è¾“å…¥**: "æ‰“å¼€å®¢å…ç¯"
\`\`\`json
{
  "user_input": "æ‰“å¼€å®¢å…ç¯",
  "intent": "Control Device",
  "confidence": 0.95,
  "user_responds": "å¥½çš„ï¼Œæ­£åœ¨ä¸ºæ‚¨æ‰“å¼€å®¢å…ç¯"
}
\`\`\`

**è¾“å…¥**: "å¯åŠ¨è§‚å½±æ¨¡å¼"
\`\`\`json
{
  "user_input": "å¯åŠ¨è§‚å½±æ¨¡å¼",
  "intent": "Control Scene",
  "confidence": 0.95,
  "user_responds": "å¥½çš„ï¼Œæ­£åœ¨ä¸ºæ‚¨å¯åŠ¨è§‚å½±æ¨¡å¼"
}
\`\`\`

**è¾“å…¥**: "æˆ‘å›å®¶äº†"
\`\`\`json
{
  "user_input": "æˆ‘å›å®¶äº†",
  "intent": "Control Scene",
  "confidence": 0.9,
  "user_responds": "æ¬¢è¿å›å®¶ï¼Œæ­£åœ¨ä¸ºæ‚¨æ‰§è¡Œå›å®¶åœºæ™¯"
}
\`\`\`

**è¾“å…¥**: "ç¦»å®¶æ¨¡å¼"
\`\`\`json
{
  "user_input": "ç¦»å®¶æ¨¡å¼",
  "intent": "Control Scene",
  "confidence": 0.9,
  "user_responds": "å¥½çš„ï¼Œæ­£åœ¨ä¸ºæ‚¨å¯åŠ¨ç¦»å®¶æ¨¡å¼"
}
\`\`\`

**è¾“å…¥**: "æ™šä¸Š7ç‚¹è‡ªåŠ¨å¼€ç¯"
\`\`\`json
{
  "user_input": "æ™šä¸Š7ç‚¹è‡ªåŠ¨å¼€ç¯",
  "intent": "Set Automation",
  "confidence": 0.95,
  "user_responds": "å¥½çš„ï¼Œæˆ‘å¸®æ‚¨è®¾ç½®æ™šä¸Š7ç‚¹è‡ªåŠ¨å¼€ç¯"
}
\`\`\`

**è¾“å…¥**: "å›å®¶æ—¶è‡ªåŠ¨å¼€ç¯"
\`\`\`json
{
  "user_input": "å›å®¶æ—¶è‡ªåŠ¨å¼€ç¯",
  "intent": "Set Automation",
  "confidence": 0.9,
  "user_responds": "å¥½çš„ï¼Œæˆ‘å¸®æ‚¨è®¾ç½®å›å®¶æ—¶è‡ªåŠ¨å¼€ç¯çš„è§„åˆ™"
}
\`\`\`

**è¾“å…¥**: "åˆ›å»ºä¸€ä¸ªè§‚å½±åœºæ™¯"
\`\`\`json
{
  "user_input": "åˆ›å»ºä¸€ä¸ªè§‚å½±åœºæ™¯",
  "intent": "Set Scene",
  "confidence": 0.95,
  "user_responds": "å¥½çš„ï¼Œæˆ‘å¸®æ‚¨åˆ›å»ºè§‚å½±åœºæ™¯"
}
\`\`\`

è¯·åªè¿”å›JSONæ ¼å¼çš„ç»“æœï¼Œä¸è¦æ·»åŠ å…¶ä»–è¯´æ˜æ–‡å­—ã€‚`;
        }

        // Load classification prompt
        async function loadClassificationPrompt() {
            const textarea = document.getElementById('classificationPromptText');
            const statusBadge = document.getElementById('classifyPromptStatus');

            try {
                const response = await fetch(`${API_BASE}/classification-prompt`);
                const data = await response.json();

                if (data.success) {
                    textarea.value = data.data.prompt;
                    statusBadge.textContent = data.data.is_custom ? 'è‡ªå®šä¹‰' : 'é»˜è®¤';
                    statusBadge.className = `status-badge ${data.data.is_custom ? 'status-warning' : 'status-success'}`;
                }
            } catch (error) {
                textarea.value = 'åŠ è½½å¤±è´¥: ' + error.message;
            }
        }

        // Save classification prompt
        async function saveClassificationPrompt() {
            const prompt = document.getElementById('classificationPromptText').value;
            const resultDiv = document.getElementById('classificationPromptResult');

            if (!prompt.trim()) {
                resultDiv.className = 'error-box';
                resultDiv.innerHTML = '<strong>âŒ é”™è¯¯ï¼š</strong> æç¤ºè¯ä¸èƒ½ä¸ºç©º';
                resultDiv.classList.remove('hidden');
                return;
            }

            resultDiv.className = 'info-box';
            resultDiv.innerHTML = '<div class="loading"></div> ä¿å­˜ä¸­...';
            resultDiv.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/classification-prompt`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'success-box';
                    resultDiv.innerHTML = '<strong>âœ… ä¿å­˜æˆåŠŸï¼</strong> è‡ªå®šä¹‰åˆ†ç±»æç¤ºè¯å·²ä¿å­˜ã€‚';
                    await loadClassificationPrompt();
                } else {
                    resultDiv.className = 'error-box';
                    resultDiv.innerHTML = `<strong>âŒ é”™è¯¯ï¼š</strong> ${data.error}`;
                }
            } catch (error) {
                resultDiv.className = 'error-box';
                resultDiv.innerHTML = `<strong>âŒ è¯·æ±‚å¤±è´¥ï¼š</strong> ${error.message}`;
            }
        }

        // Reset classification prompt
        async function resetClassificationPrompt() {
            if (!confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤åˆ†ç±»æç¤ºè¯å—ï¼Ÿè¿™å°†åˆ é™¤æ‚¨çš„è‡ªå®šä¹‰æç¤ºè¯ã€‚')) {
                return;
            }

            const resultDiv = document.getElementById('classificationPromptResult');
            resultDiv.className = 'info-box';
            resultDiv.innerHTML = '<div class="loading"></div> é‡ç½®ä¸­...';
            resultDiv.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/classification-prompt`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'success-box';
                    resultDiv.innerHTML = '<strong>âœ… é‡ç½®æˆåŠŸï¼</strong> å·²æ¢å¤é»˜è®¤åˆ†ç±»æç¤ºè¯ã€‚';
                    await loadClassificationPrompt();
                } else {
                    resultDiv.className = 'error-box';
                    resultDiv.innerHTML = `<strong>âŒ é”™è¯¯ï¼š</strong> ${data.error}`;
                }
            } catch (error) {
                resultDiv.className = 'error-box';
                resultDiv.innerHTML = `<strong>âŒ è¯·æ±‚å¤±è´¥ï¼š</strong> ${error.message}`;
            }
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>

