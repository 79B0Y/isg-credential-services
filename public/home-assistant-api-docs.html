<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ  Home Assistant API å®Œæ•´æµ‹è¯•æ–‡æ¡£</title>
    <style>
        :root {
            --primary: #41b883;
            --primary-dark: #369970;
            --secondary: #3273dc;
            --success: #48c78e;
            --danger: #f14668;
            --warning: #ffe08a;
            --info: #3e8ed0;
            --light: #f5f5f5;
            --dark: #363636;
            --white: #ffffff;
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #eeeeee;
            --gray-300: #e0e0e0;
            --gray-400: #bdbdbd;
            --gray-500: #9e9e9e;
            --gray-600: #757575;
            --gray-700: #616161;
            --gray-800: #424242;
            --gray-900: #212121;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
            padding: 2rem;
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        /* Credentials Panel */
        .credentials-panel {
            background: var(--white);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .credentials-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .credentials-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-success {
            background: var(--success);
            color: white;
        }

        .status-error {
            background: var(--danger);
            color: white;
        }

        .status-loading {
            background: var(--warning);
            color: var(--dark);
        }

        .credentials-info {
            background: var(--gray-50);
            border: 2px solid var(--success);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .credential-item {
            margin: 0.5rem 0;
            font-size: 0.875rem;
        }

        .credential-label {
            font-weight: 600;
            color: var(--gray-700);
        }

        .credential-value {
            color: var(--gray-600);
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: var(--white);
            border-radius: 1rem 1rem 0 0;
            overflow-x: auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background: var(--gray-100);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--gray-50);
        }

        /* Content Area */
        .content-area {
            background: var(--white);
            border-radius: 0 0 1rem 1rem;
            min-height: 60vh;
        }

        .tab-content {
            display: none;
            padding: 2rem;
        }

        .tab-content.active {
            display: block;
        }

        /* API Section */
        .api-section {
            margin-bottom: 3rem;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--gray-800);
        }

        .section-count {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* API Endpoint Card */
        .endpoint-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: all 0.2s;
        }

        .endpoint-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .endpoint-header {
            background: var(--white);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .endpoint-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .method-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .method-get {
            background: var(--success);
            color: white;
        }

        .method-post {
            background: var(--secondary);
            color: white;
        }

        .method-put {
            background: var(--warning);
            color: var(--dark);
        }

        .method-delete {
            background: var(--danger);
            color: white;
        }

        .endpoint-path {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
            color: var(--gray-700);
            background: var(--gray-100);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .endpoint-description {
            color: var(--gray-600);
            flex: 1;
        }

        .expand-icon {
            transition: transform 0.2s;
        }

        .endpoint-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .endpoint-content {
            display: none;
            padding: 1.5rem;
        }

        .endpoint-card.expanded .endpoint-content {
            display: block;
        }

        .endpoint-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .endpoint-details {
                grid-template-columns: 1fr;
            }
        }

        .detail-section h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--primary);
        }

        .param-list {
            list-style: none;
        }

        .param-item {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .param-name {
            font-family: 'Monaco', 'Menlo', monospace;
            font-weight: 600;
            color: var(--secondary);
        }

        .param-required {
            background: var(--danger);
            color: white;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.625rem;
            margin-left: 0.5rem;
        }

        .param-optional {
            background: var(--gray-400);
            color: white;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.625rem;
            margin-left: 0.5rem;
        }

        .param-type {
            font-style: italic;
            color: var(--gray-600);
        }

        .param-description {
            color: var(--gray-700);
            margin-top: 0.25rem;
        }

        /* Test Panel */
        .test-panel {
            background: var(--white);
            border: 2px solid var(--primary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .test-header {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: 1rem;
        }

        .test-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(65, 184, 131, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
        }

        .input-group .form-input {
            flex: 1;
        }

        /* Response Panel */
        .response-panel {
            background: var(--gray-900);
            color: var(--white);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
        }

        .response-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray-600);
        }

        .response-title {
            font-weight: 600;
            color: var(--primary);
        }

        .response-actions {
            display: flex;
            gap: 0.5rem;
        }

        .response-body {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Quick Actions */
        .quick-actions {
            background: var(--gray-50);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .quick-actions h3 {
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .action-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-card:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .action-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .action-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .action-description {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        /* Log Panel */
        .log-panel {
            background: var(--gray-900);
            color: var(--gray-300);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }

        .log-timestamp {
            color: var(--gray-500);
            margin-right: 0.5rem;
        }

        .log-level-info {
            color: var(--info);
        }

        .log-level-success {
            color: var(--success);
        }

        .log-level-error {
            color: var(--danger);
        }

        .log-level-warn {
            color: var(--warning);
        }

        /* Utilities */
        .text-center {
            text-align: center;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        .mb-2 {
            margin-bottom: 1rem;
        }

        .hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ  Home Assistant API å®Œæ•´æµ‹è¯•æ–‡æ¡£</h1>
            <p>æ¨¡å—åŒ–æ¶æ„ Â· å®æ—¶ç¼“å­˜ Â· å®Œæ•´æµ‹è¯•è¦†ç›–</p>

            <div class="stats">
                <div class="stat-card">
                    <span class="stat-number">21</span>
                    <span class="stat-label">APIç«¯ç‚¹</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">2</span>
                    <span class="stat-label">åŠŸèƒ½æ¨¡å—</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">100%</span>
                    <span class="stat-label">æµ‹è¯•è¦†ç›–</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">1åˆ†é’Ÿ</span>
                    <span class="stat-label">ç¼“å­˜åˆ·æ–°</span>
                </div>
            </div>
        </div>

        <!-- Credentials Panel -->
        <div class="credentials-panel">
            <div class="credentials-header">
                <div class="credentials-title">
                    ğŸ” å‡­æ®ç®¡ç†
                    <span id="credentials-status" class="status-badge status-loading">æ£€æŸ¥ä¸­...</span>
                </div>
            </div>

            <div id="credentials-info" class="credentials-info hidden">
                <div class="credential-item">
                    <span class="credential-label">Base URL:</span>
                    <span class="credential-value" id="stored-base-url">-</span>
                </div>
                <div class="credential-item">
                    <span class="credential-label">Access Token:</span>
                    <span class="credential-value" id="stored-token-preview">-</span>
                </div>
                <div class="credential-item">
                    <span class="credential-label">æœ€åæ›´æ–°:</span>
                    <span class="credential-value" id="stored-config-time">-</span>
                </div>
            </div>

            <div class="controls">
                <button id="refresh-credentials" class="btn btn-primary">ğŸ”„ åˆ·æ–°å‡­æ®</button>
                <button id="test-connection" class="btn btn-info">ğŸ”— æµ‹è¯•è¿æ¥</button>
                <button id="view-logs" class="btn btn-secondary">ğŸ“‹ æŸ¥çœ‹æ—¥å¿—</button>
                <button id="clear-logs" class="btn btn-secondary">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('quick-test')">âš¡ å¿«é€Ÿæµ‹è¯•</button>
            <button class="nav-tab" onclick="showTab('information')">ğŸ“‹ APIæ¥å£</button>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Quick Test Tab -->
            <div id="quick-test" class="tab-content active">
                <div class="quick-actions">
                    <h3>ğŸš€ å¿«é€Ÿæ“ä½œ</h3>
                    <div class="action-grid">
                        <div class="action-card" onclick="quickTest('entity-registry')">
                            <div class="action-icon">ğŸ“‹</div>
                            <div class="action-title">å®ä½“æ³¨å†Œè¡¨</div>
                            <div class="action-description">è·å–å®Œæ•´çš„å®ä½“æ³¨å†Œè¡¨ä¿¡æ¯</div>
                        </div>
                        <div class="action-card" onclick="quickTest('states')">
                            <div class="action-icon">ğŸ </div>
                            <div class="action-title">æ‰€æœ‰å®ä½“çŠ¶æ€</div>
                            <div class="action-description">è·å–æ‰€æœ‰å®ä½“çš„å½“å‰çŠ¶æ€</div>
                        </div>
                        <div class="action-card" onclick="quickTest('spaces')">
                            <div class="action-icon">ğŸ¢</div>
                            <div class="action-title">ç©ºé—´åˆ—è¡¨</div>
                            <div class="action-description">æŸ¥çœ‹æ¥¼å±‚å’Œæˆ¿é—´åˆ—è¡¨</div>
                        </div>
                        <div class="action-card" onclick="quickTest('enhanced-entities')">
                            <div class="action-icon">â­</div>
                            <div class="action-title">å¢å¼ºå®ä½“ä¿¡æ¯</div>
                            <div class="action-description">å®ä½“ä¿¡æ¯+æˆ¿é—´æ¥¼å±‚ä¿¡æ¯</div>
                        </div>
                        <div class="action-card" onclick="quickTest('device-registry')">
                            <div class="action-icon">ğŸ“±</div>
                            <div class="action-title">è®¾å¤‡æ³¨å†Œè¡¨</div>
                            <div class="action-description">è·å–å®Œæ•´çš„è®¾å¤‡æ³¨å†Œè¡¨ä¿¡æ¯</div>
                        </div>
                        <div class="action-card" onclick="quickTest('batch-control')">
                            <div class="action-icon">ğŸ®</div>
                            <div class="action-title">æ‰¹é‡æ§åˆ¶è®¾å¤‡</div>
                            <div class="action-description">æ‰¹é‡æ‰§è¡Œè®¾å¤‡æ§åˆ¶å‘½ä»¤</div>
                        </div>
                        <div class="action-card" onclick="quickTest('scenes')">
                            <div class="action-icon">ğŸ¬</div>
                            <div class="action-title">åœºæ™¯åˆ—è¡¨</div>
                            <div class="action-description">è·å–æ‰€æœ‰åœºæ™¯ä¿¡æ¯</div>
                        </div>
                        <div class="action-card" onclick="quickTest('automations')">
                            <div class="action-icon">âš™ï¸</div>
                            <div class="action-title">è‡ªåŠ¨åŒ–åˆ—è¡¨</div>
                            <div class="action-description">è·å–æ‰€æœ‰è‡ªåŠ¨åŒ–ä¿¡æ¯</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Response Panel -->
                <div id="quick-response" class="response-panel hidden">
                    <div class="response-header">
                        <span class="response-title">âš¡ å¿«é€Ÿæµ‹è¯•ç»“æœ</span>
                        <div class="response-actions">
                            <button class="btn btn-secondary" onclick="copyQuickResponse()">ğŸ“‹ å¤åˆ¶</button>
                            <button class="btn btn-secondary" onclick="closeQuickResponse()">âœ–ï¸ å…³é—­</button>
                        </div>
                    </div>
                    <div id="quick-response-body" class="response-body"></div>
                </div>
            </div>

            <!-- Information Tab -->
            <div id="information" class="tab-content">
                <div class="api-section">
                    <div class="section-header">
                        <h2 class="section-title">ğŸ“‹ Home Assistant APIæ¥å£</h2>
                        <span class="section-count">21ä¸ªæ¥å£</span>
                    </div>
                    <!-- API endpoints will be generated here -->
                </div>
            </div>
        </div>

        <!-- Log Panel -->
        <div id="log-panel" class="log-panel hidden">
            <div class="response-header">
                <span class="response-title">ğŸ“‹ æ“ä½œæ—¥å¿—</span>
                <div class="response-actions">
                    <button class="btn btn-secondary" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…é™¤</button>
                    <button class="btn btn-secondary" onclick="toggleLogPanel()">âœ–ï¸ å…³é—­</button>
                </div>
            </div>
            <div id="log-content"></div>
        </div>
    </div>

    <script>
        // Global variables
        let credentials = {};
        let logs = [];

        // API definitions organized by category
        const API_DEFINITIONS = {
            information: [
                {
                    method: 'GET',
                    path: '/api/home_assistant/home_assistant/entity-registry',
                    title: 'å®ä½“æ³¨å†Œè¡¨',
                    description: 'è·å–å®Œæ•´çš„å®ä½“æ³¨å†Œè¡¨ä¿¡æ¯',
                    parameters: [],
                    testFunction: 'testEntityRegistry'
                },
                {
                    method: 'GET',
                    path: '/api/home_assistant/home_assistant/states',
                    title: 'æ‰€æœ‰å®ä½“çŠ¶æ€',
                    description: 'è·å–æ‰€æœ‰å®ä½“çš„å½“å‰çŠ¶æ€',
                    parameters: [],
                    testFunction: 'testStates'
                },
                {
                    method: 'GET',
                    path: '/api/home_assistant/home_assistant/spaces',
                    title: 'ç©ºé—´åˆ—è¡¨ï¼ˆæ¥¼å±‚+æˆ¿é—´ï¼‰',
                    description: 'å°†æ¥¼å±‚åˆ—è¡¨å’Œæˆ¿é—´åˆ—è¡¨ç»„åˆæˆç©ºé—´åˆ—è¡¨ï¼Œæ”¯æŒé€šè¿‡opæ§åˆ¶è¾“å‡ºæ ¼å¼ï¼ˆå½“å‰æ”¯æŒï¼šfloorsï¼‰',
                    parameters: [
                        { name: 'op', type: 'string', required: false, description: 'è¾“å‡ºæ ¼å¼ï¼Œé»˜è®¤ä¸ºfloorsï¼ˆæŒ‰æ¥¼å±‚åµŒå¥—æˆ¿é—´ï¼‰' }
                    ],
                    testFunction: 'testSpaces'
                },
                {
                    method: 'GET',
                    path: '/api/home_assistant/home_assistant/device-registry',
                    title: 'è®¾å¤‡æ³¨å†Œè¡¨',
                    description: 'è·å–å®Œæ•´çš„è®¾å¤‡æ³¨å†Œè¡¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬è®¾å¤‡IDã€åç§°ã€åŒºåŸŸåˆ†é…ç­‰ä¿¡æ¯',
                    parameters: [],
                    testFunction: 'testDeviceRegistry'
                },
                {
                    method: 'GET',
                    path: '/api/home_assistant/home_assistant/enhanced-entities',
                    title: 'å¢å¼ºå®ä½“ä¿¡æ¯',
                    description: 'è·å–åŒ…å«æˆ¿é—´IDã€æˆ¿é—´åç§°ã€æ¥¼å±‚IDã€æ¥¼å±‚åç§°çš„å®Œæ•´å®ä½“ä¿¡æ¯ã€‚æ•´åˆå®ä½“æ³¨å†Œè¡¨ã€ç©ºé—´åˆ—è¡¨å’Œå®ä½“çŠ¶æ€ä¸‰ä¸ªAPIçš„æ•°æ®',
                    parameters: [],
                    testFunction: 'testEnhancedEntities'
                },
                {
                    method: 'POST',
                    path: '/api/home_assistant/home_assistant/batch-control',
                    title: 'æ‰¹é‡æ§åˆ¶è®¾å¤‡',
                    description: 'æ‰¹é‡æ‰§è¡Œè®¾å¤‡æ§åˆ¶å‘½ä»¤ã€‚æ¥æ”¶åŒ…å«entity_idã€serviceå’Œservice_dataçš„JSONæ•°ç»„ï¼Œæ‰¹é‡æ§åˆ¶å¤šä¸ªè®¾å¤‡',
                    parameters: [
                        { name: 'commands', type: 'json-array', required: true, description: 'æ‰¹é‡æ§åˆ¶å‘½ä»¤JSONæ•°ç»„ï¼Œæ¯ä¸ªå‘½ä»¤åŒ…å«entity_idã€serviceå’Œservice_dataã€‚ä¾‹å¦‚ï¼š[{"entity_id":"light.light_test_001","service":"light.turn_on","service_data":{"color_name":"blue"}}]' }
                    ],
                    testFunction: 'testBatchControl'
                },
                {
                    method: 'POST',
                    path: '/api/home_assistant/home_assistant/batch-states',
                    title: 'æ‰¹é‡è·å–å®ä½“çŠ¶æ€',
                    description: 'æ‰¹é‡è·å–æŒ‡å®šå®ä½“çš„å½“å‰çŠ¶æ€ã€‚è¿”å›æ¸…æ´—åçš„æ•°æ®ï¼ŒåªåŒ…å«æœ‰ç”¨ä¿¡æ¯ï¼ˆç¯å…‰ï¼šäº®åº¦/é¢œè‰²ï¼Œç©ºè°ƒï¼šæ¸©åº¦/æ¨¡å¼ï¼Œä¼ æ„Ÿå™¨ï¼šçŠ¶æ€å€¼ï¼‰',
                    parameters: [
                        { name: 'entities', type: 'json-array', required: true, description: 'å®ä½“IDåˆ—è¡¨JSONæ•°ç»„ã€‚ä¾‹å¦‚ï¼š[{"entity_id":"climate.text_ac_01"},{"entity_id":"light.light_test_001"}]' }
                    ],
                    testFunction: 'testBatchStates'
                },
                {
                    method: 'GET',
                    path: '/api/home_assistant/home_assistant/scenes',
                    title: 'åœºæ™¯åˆ—è¡¨',
                    description: 'è·å–Home Assistantä¸­æ‰€æœ‰å·²é…ç½®çš„åœºæ™¯åˆ—è¡¨ï¼ŒåŒ…æ‹¬åœºæ™¯åç§°ã€IDå’ŒçŠ¶æ€ä¿¡æ¯',
                    parameters: [],
                    testFunction: 'testGetScenes'
                },
                {
                    method: 'POST',
                    path: '/api/home_assistant/home_assistant/scene/activate',
                    title: 'æ‰§è¡Œåœºæ™¯',
                    description: 'æ¿€æ´»å¹¶æ‰§è¡ŒæŒ‡å®šçš„åœºæ™¯ï¼Œä½¿è®¾å¤‡çŠ¶æ€åˆ‡æ¢åˆ°åœºæ™¯å®šä¹‰çš„çŠ¶æ€',
                    parameters: [
                        { name: 'scene_id', type: 'string', required: true, description: 'åœºæ™¯IDï¼Œä¾‹å¦‚ï¼šscene.romantic_lightsã€‚å¦‚æœä¸åŒ…å«scene.å‰ç¼€å°†è‡ªåŠ¨æ·»åŠ ' }
                    ],
                    testFunction: 'testActivateScene'
                },
                {
                    method: 'POST',
                    path: '/api/home_assistant/home_assistant/scene/create',
                    title: 'åˆ›å»ºåœºæ™¯',
                    description: 'åˆ›å»ºæ–°åœºæ™¯ã€‚æ”¯æŒä¸¤ç§æ–¹å¼ï¼š1) ä»å½“å‰è®¾å¤‡çŠ¶æ€åˆ›å»ºå¿«ç…§ï¼ˆsnapshot_entitiesï¼‰ï¼›2) æ‰‹åŠ¨æŒ‡å®šè®¾å¤‡çŠ¶æ€ï¼ˆentitiesï¼‰',
                    parameters: [
                        { name: 'scene_id', type: 'string', required: false, description: 'åœºæ™¯IDï¼ˆå¯é€‰ï¼Œå¦‚ä¸æŒ‡å®šåˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰' },
                        { name: 'snapshot_entities', type: 'json-array', required: false, description: 'è¦å¿«ç…§çš„å®ä½“IDåˆ—è¡¨ï¼Œå°†ä¿å­˜å½“å‰çŠ¶æ€ã€‚ä¾‹å¦‚ï¼š["light.living_room","climate.bedroom"]' },
                        { name: 'entities', type: 'json-object', required: false, description: 'æ‰‹åŠ¨æŒ‡å®šçš„å®ä½“çŠ¶æ€é…ç½®ã€‚ä¾‹å¦‚ï¼š{"light.living_room":{"state":"on","brightness":50}}' }
                    ],
                    testFunction: 'testCreateScene'
                },
                {
                    method: 'POST',
                    path: '/api/home_assistant/home_assistant/scenes/activate',
                    title: 'æ‰¹é‡æ‰§è¡Œåœºæ™¯',
                    description: 'æ‰¹é‡æ¿€æ´»å¤šä¸ªåœºæ™¯ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰æŒ‡å®šçš„åœºæ™¯',
                    parameters: [
                        { name: 'scene_ids', type: 'json-array', required: true, description: 'åœºæ™¯IDåˆ—è¡¨JSONæ•°ç»„ã€‚ä¾‹å¦‚ï¼š["scene.romantic_lights","scene.movie_time"]' }
                    ],
                    testFunction: 'testActivateScenes'
                },
                {
                    method: 'DELETE',
                    path: '/api/home_assistant/home_assistant/scene/:scene_id',
                    title: 'åˆ é™¤åœºæ™¯',
                    description: 'åˆ é™¤æŒ‡å®šçš„åœºæ™¯ã€‚âš ï¸ æ³¨æ„ï¼šåªèƒ½åˆ é™¤é€šè¿‡APIåŠ¨æ€åˆ›å»ºçš„åœºæ™¯ï¼ˆscene.createï¼‰ï¼Œé…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„åœºæ™¯æ— æ³•åˆ é™¤ã€‚åˆ é™¤ååœºæ™¯å°†æ°¸ä¹…ç§»é™¤',
                    parameters: [
                        { name: 'scene_id', type: 'path', required: true, description: 'åœºæ™¯IDï¼ˆè·¯å¾„å‚æ•°ï¼‰ï¼Œä¾‹å¦‚ï¼šscene.my_sceneã€‚å¦‚æœä¸åŒ…å«scene.å‰ç¼€å°†è‡ªåŠ¨æ·»åŠ ã€‚æ”¯æŒåˆ é™¤åŠ¨æ€åˆ›å»ºçš„åœºæ™¯' }
                    ],
                    testFunction: 'testDeleteScene'
                },
                {
                    method: 'POST',
                    path: '/api/home_assistant/home_assistant/scenes/delete',
                    title: 'æ‰¹é‡åˆ é™¤åœºæ™¯',
                    description: 'æ‰¹é‡åˆ é™¤å¤šä¸ªåœºæ™¯ã€‚âš ï¸ æ³¨æ„ï¼šåªèƒ½åˆ é™¤é€šè¿‡APIåŠ¨æ€åˆ›å»ºçš„åœºæ™¯ï¼Œé…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„åœºæ™¯æ— æ³•åˆ é™¤ã€‚æ‰€æœ‰æŒ‡å®šçš„åœºæ™¯å°†è¢«æ°¸ä¹…åˆ é™¤',
                    parameters: [
                        { name: 'scene_ids', type: 'json-array', required: true, description: 'åœºæ™¯IDåˆ—è¡¨JSONæ•°ç»„ã€‚ä¾‹å¦‚ï¼š["scene.my_scene_1","scene.my_scene_2"]ã€‚æ”¯æŒåˆ é™¤åŠ¨æ€åˆ›å»ºçš„åœºæ™¯' }
                    ],
                    testFunction: 'testDeleteScenes'
                },
                {
                    method: 'GET',
                    path: '/api/home_assistant/home_assistant/automations',
                    title: 'è·å–è‡ªåŠ¨åŒ–åˆ—è¡¨',
                    description: 'è·å–Home Assistantä¸­æ‰€æœ‰è‡ªåŠ¨åŒ–çš„åˆ—è¡¨ï¼ŒåŒ…æ‹¬å¯ç”¨çŠ¶æ€ã€æœ€åè§¦å‘æ—¶é—´ç­‰å®Œæ•´ä¿¡æ¯',
                    parameters: [],
                    testFunction: 'testGetAutomations'
                },
                {
                    method: 'GET',
                    path: '/api/home_assistant/home_assistant/automation/:automation_id',
                    title: 'è·å–å•ä¸ªè‡ªåŠ¨åŒ–è¯¦æƒ…',
                    description: 'è·å–æŒ‡å®šè‡ªåŠ¨åŒ–çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬çŠ¶æ€ã€è§¦å‘æ—¶é—´ã€è¿è¡Œæ¨¡å¼ç­‰',
                    parameters: [
                        { name: 'automation_id', type: 'path', required: true, description: 'è‡ªåŠ¨åŒ–IDï¼ˆè·¯å¾„å‚æ•°ï¼‰ï¼Œä¾‹å¦‚ï¼šautomation.morning_lights æˆ–ç®€å†™ä¸º morning_lights' }
                    ],
                    testFunction: 'testGetAutomation'
                },
                {
                    method: 'POST',
                    path: '/api/home_assistant/home_assistant/automation/create',
                    title: 'åˆ›å»ºè‡ªåŠ¨åŒ–',
                    description: 'åˆ›å»ºæ–°çš„è‡ªåŠ¨åŒ–è§„åˆ™ã€‚éœ€è¦æä¾›è§¦å‘å™¨ï¼ˆtriggerï¼‰ã€æ¡ä»¶ï¼ˆconditionï¼Œå¯é€‰ï¼‰å’ŒåŠ¨ä½œï¼ˆactionï¼‰',
                    parameters: [
                        { name: 'automation_config', type: 'json-object', required: true, description: 'è‡ªåŠ¨åŒ–é…ç½®å¯¹è±¡ï¼ŒåŒ…å«idã€aliasã€triggerã€conditionã€actionç­‰å­—æ®µã€‚ä¾‹å¦‚ï¼š{"alias":"æ™šå®‰ç¯å…‰","trigger":[{"platform":"time","at":"22:00:00"}],"action":[{"service":"light.turn_off"}]}' }
                    ],
                    testFunction: 'testCreateAutomation'
                },
                {
                    method: 'DELETE',
                    path: '/api/home_assistant/home_assistant/automation/:automation_id',
                    title: 'åˆ é™¤è‡ªåŠ¨åŒ–',
                    description: 'åˆ é™¤æŒ‡å®šçš„è‡ªåŠ¨åŒ–ã€‚âš ï¸ æ³¨æ„ï¼šåˆ é™¤åè‡ªåŠ¨åŒ–å°†æ°¸ä¹…ç§»é™¤',
                    parameters: [
                        { name: 'automation_id', type: 'path', required: true, description: 'è‡ªåŠ¨åŒ–IDï¼ˆè·¯å¾„å‚æ•°ï¼‰ï¼Œä¾‹å¦‚ï¼šautomation.my_automation æˆ–ç®€å†™ä¸º my_automation' }
                    ],
                    testFunction: 'testDeleteAutomation'
                },
                {
                    method: 'POST',
                    path: '/api/home_assistant/home_assistant/automation/:automation_id/enable',
                    title: 'å¯ç”¨è‡ªåŠ¨åŒ–',
                    description: 'å¯ç”¨ä¸€ä¸ªå·²ç¦ç”¨çš„è‡ªåŠ¨åŒ–ï¼Œä½¿å…¶å¼€å§‹å“åº”è§¦å‘æ¡ä»¶',
                    parameters: [
                        { name: 'automation_id', type: 'path', required: true, description: 'è‡ªåŠ¨åŒ–IDï¼ˆè·¯å¾„å‚æ•°ï¼‰ï¼Œä¾‹å¦‚ï¼šautomation.morning_lights' }
                    ],
                    testFunction: 'testEnableAutomation'
                },
                {
                    method: 'POST',
                    path: '/api/home_assistant/home_assistant/automation/:automation_id/disable',
                    title: 'ç¦ç”¨è‡ªåŠ¨åŒ–',
                    description: 'ç¦ç”¨ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„è‡ªåŠ¨åŒ–ï¼Œä½¿å…¶åœæ­¢å“åº”è§¦å‘æ¡ä»¶',
                    parameters: [
                        { name: 'automation_id', type: 'path', required: true, description: 'è‡ªåŠ¨åŒ–IDï¼ˆè·¯å¾„å‚æ•°ï¼‰ï¼Œä¾‹å¦‚ï¼šautomation.morning_lights' }
                    ],
                    testFunction: 'testDisableAutomation'
                },
                {
                    method: 'POST',
                    path: '/api/home_assistant/home_assistant/automation/:automation_id/trigger',
                    title: 'è§¦å‘è‡ªåŠ¨åŒ–',
                    description: 'æ‰‹åŠ¨è§¦å‘è‡ªåŠ¨åŒ–æ‰§è¡Œï¼Œæ— éœ€ç­‰å¾…è§¦å‘æ¡ä»¶æ»¡è¶³',
                    parameters: [
                        { name: 'automation_id', type: 'path', required: true, description: 'è‡ªåŠ¨åŒ–IDï¼ˆè·¯å¾„å‚æ•°ï¼‰ï¼Œä¾‹å¦‚ï¼šautomation.morning_lights' }
                    ],
                    testFunction: 'testTriggerAutomation'
                },
                {
                    method: 'POST',
                    path: '/api/home_assistant/home_assistant/automations/reload',
                    title: 'é‡æ–°åŠ è½½è‡ªåŠ¨åŒ–é…ç½®',
                    description: 'é‡æ–°åŠ è½½æ‰€æœ‰è‡ªåŠ¨åŒ–çš„é…ç½®ï¼Œç”¨äºåœ¨ä¿®æ”¹é…ç½®æ–‡ä»¶ååˆ·æ–°',
                    parameters: [],
                    testFunction: 'testReloadAutomations'
                }
            ]
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            loadCredentials();
            generateAPIDocumentation();
        });

        // Initialize page components
        function initializePage() {
            // Setup event listeners
            document.getElementById('refresh-credentials').addEventListener('click', loadCredentials);
            document.getElementById('test-connection').addEventListener('click', testCredentials);
            document.getElementById('view-logs').addEventListener('click', toggleLogPanel);
            document.getElementById('clear-logs').addEventListener('click', clearLogs);
        }

        // Load credentials from service
        async function loadCredentials() {
            const statusEl = document.getElementById('credentials-status');
            const infoEl = document.getElementById('credentials-info');

            statusEl.textContent = 'æ£€æŸ¥ä¸­...';
            statusEl.className = 'status-badge status-loading';

            try {
                const response = await fetch('/api/credentials/home_assistant');
                const result = await response.json();

                if (result.success && result.data) {
                    credentials = {
                        access_token: result.data.access_token,
                        base_url: result.data.base_url
                    };

                    document.getElementById('stored-base-url').textContent = credentials.base_url;
                    document.getElementById('stored-token-preview').textContent =
                        credentials.access_token.substring(0, 20) + '...';
                    document.getElementById('stored-config-time').textContent =
                        new Date().toLocaleString();

                    statusEl.textContent = 'å·²è¿æ¥';
                    statusEl.className = 'status-badge status-success';
                    infoEl.classList.remove('hidden');

                    addLog('å‡­æ®åŠ è½½æˆåŠŸ âœ…', 'success');
                } else {
                    statusEl.textContent = 'æœªé…ç½®';
                    statusEl.className = 'status-badge status-error';
                    infoEl.classList.add('hidden');
                    addLog('æœªæ‰¾åˆ°æœ‰æ•ˆå‡­æ®ï¼Œè¯·å…ˆé…ç½®Home Assistantå‡­æ®', 'error');
                }
            } catch (error) {
                statusEl.textContent = 'è¿æ¥å¤±è´¥';
                statusEl.className = 'status-badge status-error';
                infoEl.classList.add('hidden');
                addLog('å‡­æ®æœåŠ¡è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Test credentials
        async function testCredentials() {
            if (!credentials.access_token || !credentials.base_url) {
                addLog('è¯·å…ˆåŠ è½½æœ‰æ•ˆå‡­æ®', 'error');
                return;
            }

            try {
                const response = await makeAPICall('POST', '/api/home_assistant/home_assistant/test-connection');
                if (response.success) {
                    addLog('è¿æ¥æµ‹è¯•æˆåŠŸ âœ…', 'success');
                } else {
                    addLog('è¿æ¥æµ‹è¯•å¤±è´¥: ' + response.error, 'error');
                }
            } catch (error) {
                addLog('è¿æ¥æµ‹è¯•é”™è¯¯: ' + error.message, 'error');
            }
        }

        // Make API call
        async function makeAPICall(method, endpoint, data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (data && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            } else if (data && method === 'GET') {
                // For GET requests, add data as query parameters
                const url = new URL(endpoint, window.location.origin);
                Object.keys(data).forEach(key => {
                    if (data[key] !== null && data[key] !== undefined && data[key] !== '') {
                        if (Array.isArray(data[key])) {
                            // For arrays, pass as JSON string (backend expects JSON format)
                            url.searchParams.append(key, JSON.stringify(data[key]));
                        } else {
                            url.searchParams.append(key, data[key]);
                        }
                    }
                });
                endpoint = url.pathname + url.search;
            }

            const response = await fetch(endpoint, options);
            return await response.json();
        }

        // Quick test functions
        async function quickTest(testType) {
            const responseEl = document.getElementById('quick-response');
            const bodyEl = document.getElementById('quick-response-body');

            responseEl.classList.remove('hidden');
            bodyEl.textContent = 'Loading...';

            try {
                let endpoint;
                switch (testType) {
                    case 'entity-registry':
                        endpoint = '/api/home_assistant/home_assistant/entity-registry';
                        break;
                    case 'states':
                        endpoint = '/api/home_assistant/home_assistant/states';
                        break;
                    case 'spaces':
                        endpoint = '/api/home_assistant/home_assistant/spaces';
                        break;
                    case 'device-registry':
                        endpoint = '/api/home_assistant/home_assistant/device-registry';
                        break;
                    case 'enhanced-entities':
                        endpoint = '/api/home_assistant/home_assistant/enhanced-entities';
                        break;
                    case 'scenes':
                        endpoint = '/api/home_assistant/home_assistant/scenes';
                        break;
                    case 'automations':
                        endpoint = '/api/home_assistant/home_assistant/automations';
                        break;
                    case 'batch-control':
                        endpoint = '/api/home_assistant/home_assistant/batch-control';
                        // ç¤ºä¾‹æ‰¹é‡æ§åˆ¶æ•°æ®
                        const batchData = [
                            {
                                "entity_id": "light.light_test_001",
                                "service": "light.turn_on",
                                "service_data": {
                                    "color_name": "blue",
                                    "brightness": 255
                                }
                            }
                        ];
                        const response = await makeAPICall('POST', endpoint, batchData);
                        bodyEl.textContent = JSON.stringify(response, null, 2);
                        addLog(`å¿«é€Ÿæµ‹è¯• ${testType} ${response.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`,
                              response.success ? 'success' : 'error');
                        return;
                }

                const response = await makeAPICall('GET', endpoint);
                bodyEl.textContent = JSON.stringify(response, null, 2);

                addLog(`å¿«é€Ÿæµ‹è¯• ${testType} ${response.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`,
                      response.success ? 'success' : 'error');
            } catch (error) {
                bodyEl.textContent = JSON.stringify({ error: error.message }, null, 2);
                addLog(`å¿«é€Ÿæµ‹è¯• ${testType} é”™è¯¯: ${error.message}`, 'error');
            }
        }


        // Tab navigation
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Generate API documentation
        function generateAPIDocumentation() {
            Object.keys(API_DEFINITIONS).forEach(category => {
                const container = document.querySelector(`#${category} .api-section`);
                if (container) {
                    API_DEFINITIONS[category].forEach(api => {
                        container.appendChild(createEndpointCard(api));
                    });
                }
            });
        }

        // Create endpoint card
        function createEndpointCard(api) {
            const card = document.createElement('div');
            card.className = 'endpoint-card';
            card.dataset.endpoint = api.testFunction;

            card.innerHTML = `
                <div class="endpoint-header" onclick="toggleEndpoint(this)">
                    <div class="endpoint-info">
                        <span class="method-badge method-${api.method.toLowerCase()}">${api.method}</span>
                        <span class="endpoint-path">${api.path}</span>
                        <span class="endpoint-description">${api.title}</span>
                    </div>
                    <span class="expand-icon">â–¼</span>
                </div>
                <div class="endpoint-content">
                    <div class="endpoint-details">
                        <div class="detail-section">
                            <h4>ğŸ“ æ¥å£è¯´æ˜</h4>
                            <p>${api.description}</p>

                            <h4>ğŸ“‹ è¯·æ±‚å‚æ•°</h4>
                            <ul class="param-list">
                                ${api.parameters.map(param => `
                                    <li class="param-item">
                                        <span class="param-name">${param.name}</span>
                                        <span class="param-${param.required ? 'required' : 'optional'}">
                                            ${param.required ? 'REQUIRED' : 'OPTIONAL'}
                                        </span>
                                        <span class="param-type">${param.type}</span>
                                        <div class="param-description">${param.description}</div>
                                    </li>
                                `).join('')}
                                ${api.parameters.length === 0 ? '<li class="param-item">æ— å‚æ•°</li>' : ''}
                            </ul>
                        </div>
                        <div class="detail-section">
                            <div class="test-panel">
                                <div class="test-header">
                                    <h4 class="test-title">ğŸ§ª æ¥å£æµ‹è¯•</h4>
                                </div>
                                ${generateTestForm(api)}
                                <div class="controls mt-2">
                                    <button class="btn btn-primary" onclick="${api.testFunction}()">
                                        <span class="loading-spinner hidden" id="${api.testFunction}-spinner"></span>
                                        ğŸš€ æ‰§è¡Œæµ‹è¯•
                                    </button>
                                    <button class="btn btn-info" onclick="fillExampleData('${api.testFunction}')">
                                        ğŸ“ å¡«å……ç¤ºä¾‹
                                    </button>
                                    ${api.testFunction === 'testBatchControl' ? `
                                        <button class="btn btn-secondary" onclick="formatBatchControlJSON()">
                                            âœ¨ æ ¼å¼åŒ–JSON
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="${api.testFunction}-response" class="response-panel hidden">
                        <div class="response-header">
                            <span class="response-title">ğŸ“¤ å“åº”ç»“æœ</span>
                            <div class="response-actions">
                                <button class="btn btn-secondary" onclick="copyResponse('${api.testFunction}-body')">ğŸ“‹ å¤åˆ¶</button>
                            </div>
                        </div>
                        <div id="${api.testFunction}-body" class="response-body"></div>
                    </div>
                </div>
            `;

            return card;
        }

        // Generate test form based on parameters
        function generateTestForm(api) {
            if (api.parameters.length === 0) {
                return '<p>æ­¤æ¥å£ä¸éœ€è¦å‚æ•°ï¼Œç›´æ¥æ‰§è¡Œæµ‹è¯•å³å¯ã€‚</p>';
            }

            return api.parameters.map(param => {
                if (param.type === 'array' || param.type === 'json-array') {
                    return `
                        <div class="form-group">
                            <label class="form-label">${param.name} ${param.required ? '(å¿…å¡«)' : '(å¯é€‰)'}</label>
                            <textarea id="${api.testFunction}-${param.name}"
                                     class="form-textarea"
                                     rows="10"
                                     placeholder="è¯·è¾“å…¥JSONæ•°ç»„æ ¼å¼"></textarea>
                            <small>${param.description}</small>
                        </div>
                    `;
                } else if (param.type === 'object') {
                    return `
                        <div class="form-group">
                            <label class="form-label">${param.name} ${param.required ? '(å¿…å¡«)' : '(å¯é€‰)'}</label>
                            <textarea id="${api.testFunction}-${param.name}"
                                     class="form-textarea"
                                     rows="6"
                                     placeholder="è¯·è¾“å…¥JSONå¯¹è±¡æ ¼å¼"></textarea>
                            <small>${param.description}</small>
                        </div>
                    `;
                } else {
                    return `
                        <div class="form-group">
                            <label class="form-label">${param.name} ${param.required ? '(å¿…å¡«)' : '(å¯é€‰)'}</label>
                            <input id="${api.testFunction}-${param.name}"
                                   class="form-input"
                                   type="text"
                                   placeholder="${param.description}">
                        </div>
                    `;
                }
            }).join('');
        }

        // Toggle endpoint card
        function toggleEndpoint(header) {
            const card = header.closest('.endpoint-card');
            card.classList.toggle('expanded');
        }

        // Generic test function
        async function executeAPITest(testFunction, method, endpoint, paramNamesOrData = []) {
            const spinner = document.getElementById(`${testFunction}-spinner`);
            const responseEl = document.getElementById(`${testFunction}-response`);
            const bodyEl = document.getElementById(`${testFunction}-body`);

            if (spinner) spinner.classList.remove('hidden');
            responseEl.classList.remove('hidden');
            bodyEl.textContent = 'Loading...';

            try {
                let data = null;
                let finalEndpoint = endpoint;

                // Check if paramNamesOrData is actual data (array or non-array object) or param names
                if (Array.isArray(paramNamesOrData)) {
                    // If it's an array, check if it contains strings (param names) or objects (actual data)
                    if (paramNamesOrData.length > 0) {
                        if (typeof paramNamesOrData[0] === 'string') {
                            // It's param names array
                            data = {};
                            paramNamesOrData.forEach(param => {
                                const element = document.getElementById(`${testFunction}-${param}`);
                                if (element && element.value) {
                                    try {
                                        if (element.classList.contains('form-textarea')) {
                                            data[param] = JSON.parse(element.value);
                                        } else {
                                            data[param] = element.value;
                                        }
                                    } catch (e) {
                                        data[param] = element.value;
                                    }
                                }
                            });

                            // Handle path parameters
                            if (endpoint.includes('{')) {
                                Object.keys(data).forEach(key => {
                                    if (endpoint.includes(`{${key}}`)) {
                                        finalEndpoint = endpoint.replace(`{${key}}`, data[key]);
                                        delete data[key];
                                    }
                                });
                            }

                            // Special handling for match-devices endpoint
                            if (endpoint.includes('match-devices') && data.device_commands) {
                                data = data.device_commands; // Send array directly
                            }

                            // Clean empty data
                            if (Object.keys(data).length === 0) {
                                data = null;
                            }
                        } else {
                            // It's actual data array (like batch control commands)
                            data = paramNamesOrData;
                            addLog(`å‘é€æ‰¹é‡æ•°æ®: ${data.length} ä¸ªå‘½ä»¤`, 'info');
                        }
                    }
                } else if (paramNamesOrData && typeof paramNamesOrData === 'object') {
                    // It's an object with actual data
                    data = paramNamesOrData;
                }

                const response = await makeAPICall(method, finalEndpoint, data);
                bodyEl.textContent = JSON.stringify(response, null, 2);

                addLog(`APIæµ‹è¯• ${testFunction} ${response.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`,
                      response.success ? 'success' : 'error');
            } catch (error) {
                bodyEl.textContent = JSON.stringify({ error: error.message }, null, 2);
                addLog(`APIæµ‹è¯• ${testFunction} é”™è¯¯: ${error.message}`, 'error');
            } finally {
                if (spinner) spinner.classList.add('hidden');
            }
        }

        // Individual test functions
        function testEntityRegistry() {
            executeAPITest('testEntityRegistry', 'GET', '/api/home_assistant/home_assistant/entity-registry');
        }

        function testStates() {
            executeAPITest('testStates', 'GET', '/api/home_assistant/home_assistant/states');
        }

        function testSpaces() {
            executeAPITest('testSpaces', 'GET', '/api/home_assistant/home_assistant/spaces', ['op']);
        }

        function testDeviceRegistry() {
            executeAPITest('testDeviceRegistry', 'GET', '/api/home_assistant/home_assistant/device-registry');
        }

        function testEnhancedEntities() {
            executeAPITest('testEnhancedEntities', 'GET', '/api/home_assistant/home_assistant/enhanced-entities');
        }

        function testBatchStates() {
            try {
                // ä»textareaè¯»å–JSONæ•°æ®
                const entitiesInput = document.getElementById('testBatchStates-entities');
                if (!entitiesInput || !entitiesInput.value.trim()) {
                    addLog('è¯·è¾“å…¥å®ä½“IDåˆ—è¡¨JSONæ•°æ®', 'error');
                    return;
                }
                
                // è·å–è¾“å…¥å€¼å¹¶æ¸…ç†å¯èƒ½çš„ç‰¹æ®Šå­—ç¬¦
                let inputValue = entitiesInput.value.trim();
                
                // å°è¯•è§£æJSON
                let entitiesData;
                try {
                    entitiesData = JSON.parse(inputValue);
                } catch (parseError) {
                    addLog('JSONæ ¼å¼é”™è¯¯: ' + parseError.message, 'error');
                    addLog('æç¤º: è¯·æ£€æŸ¥JSONæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œå¯ä»¥ä½¿ç”¨"ğŸ“ å¡«å……ç¤ºä¾‹"æŒ‰é’®æŸ¥çœ‹æ­£ç¡®æ ¼å¼', 'info');
                    return;
                }
                
                // éªŒè¯æ˜¯å¦ä¸ºæ•°ç»„
                if (!Array.isArray(entitiesData)) {
                    addLog('å®ä½“åˆ—è¡¨å¿…é¡»æ˜¯JSONæ•°ç»„æ ¼å¼', 'error');
                    return;
                }
                
                // éªŒè¯æ•°ç»„ä¸ä¸ºç©º
                if (entitiesData.length === 0) {
                    addLog('å®ä½“åˆ—è¡¨æ•°ç»„ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }
                
                // éªŒè¯æ¯ä¸ªå¯¹è±¡çš„å¿…å¡«å­—æ®µ
                for (let i = 0; i < entitiesData.length; i++) {
                    const entity = entitiesData[i];
                    if (!entity.entity_id) {
                        addLog(`å®ä½“ ${i + 1} ç¼ºå°‘å¿…å¡«å­—æ®µ entity_id`, 'error');
                        return;
                    }
                }
                
                addLog(`å‡†å¤‡è·å– ${entitiesData.length} ä¸ªå®ä½“çš„çŠ¶æ€`, 'info');
                
                // æ‰§è¡Œæµ‹è¯•
                executeAPITest('testBatchStates', 'POST', '/api/home_assistant/home_assistant/batch-states', entitiesData);
            } catch (error) {
                addLog('æ‰§è¡Œé”™è¯¯: ' + error.message, 'error');
                console.error('Batch states error:', error);
            }
        }

        // Scene test functions
        function testGetScenes() {
            executeAPITest('testGetScenes', 'GET', '/api/home_assistant/home_assistant/scenes');
        }

        function testActivateScene() {
            executeAPITest('testActivateScene', 'POST', '/api/home_assistant/home_assistant/scene/activate', ['scene_id']);
        }

        function testCreateScene() {
            try {
                // ä»è¡¨å•è¯»å–æ•°æ®
                const sceneIdInput = document.getElementById('testCreateScene-scene_id');
                const snapshotInput = document.getElementById('testCreateScene-snapshot_entities');
                const entitiesInput = document.getElementById('testCreateScene-entities');

                const sceneData = {};

                // scene_id
                if (sceneIdInput && sceneIdInput.value.trim()) {
                    sceneData.scene_id = sceneIdInput.value.trim();
                }

                // snapshot_entities (JSON array)
                if (snapshotInput && snapshotInput.value.trim()) {
                    try {
                        sceneData.snapshot_entities = JSON.parse(snapshotInput.value.trim());
                    } catch (e) {
                        addLog('snapshot_entities JSONæ ¼å¼é”™è¯¯: ' + e.message, 'error');
                        return;
                    }
                }

                // entities (JSON object)
                if (entitiesInput && entitiesInput.value.trim()) {
                    try {
                        sceneData.entities = JSON.parse(entitiesInput.value.trim());
                    } catch (e) {
                        addLog('entities JSONæ ¼å¼é”™è¯¯: ' + e.message, 'error');
                        return;
                    }
                }

                // éªŒè¯è‡³å°‘æœ‰ä¸€ä¸ªå¿…å¡«å­—æ®µ
                if (!sceneData.snapshot_entities && !sceneData.entities) {
                    addLog('å¿…é¡»æä¾› snapshot_entities æˆ– entities ä¸­çš„è‡³å°‘ä¸€ä¸ª', 'error');
                    return;
                }

                addLog('å‡†å¤‡åˆ›å»ºåœºæ™¯', 'info');
                executeAPITest('testCreateScene', 'POST', '/api/home_assistant/home_assistant/scene/create', sceneData);
            } catch (error) {
                addLog('æ‰§è¡Œé”™è¯¯: ' + error.message, 'error');
                console.error('Create scene error:', error);
            }
        }

        function testActivateScenes() {
            try {
                // ä»textareaè¯»å–JSONæ•°æ®
                const sceneIdsInput = document.getElementById('testActivateScenes-scene_ids');
                if (!sceneIdsInput || !sceneIdsInput.value.trim()) {
                    addLog('è¯·è¾“å…¥åœºæ™¯IDåˆ—è¡¨JSONæ•°æ®', 'error');
                    return;
                }
                
                // è·å–è¾“å…¥å€¼å¹¶æ¸…ç†å¯èƒ½çš„ç‰¹æ®Šå­—ç¬¦
                let inputValue = sceneIdsInput.value.trim();
                
                // å°è¯•è§£æJSON
                let sceneIdsData;
                try {
                    sceneIdsData = JSON.parse(inputValue);
                } catch (parseError) {
                    addLog('JSONæ ¼å¼é”™è¯¯: ' + parseError.message, 'error');
                    addLog('æç¤º: è¯·æ£€æŸ¥JSONæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œå¯ä»¥ä½¿ç”¨"ğŸ“ å¡«å……ç¤ºä¾‹"æŒ‰é’®æŸ¥çœ‹æ­£ç¡®æ ¼å¼', 'info');
                    return;
                }
                
                // éªŒè¯æ˜¯å¦ä¸ºæ•°ç»„
                if (!Array.isArray(sceneIdsData)) {
                    addLog('åœºæ™¯IDåˆ—è¡¨å¿…é¡»æ˜¯JSONæ•°ç»„æ ¼å¼', 'error');
                    return;
                }
                
                // éªŒè¯æ•°ç»„ä¸ä¸ºç©º
                if (sceneIdsData.length === 0) {
                    addLog('åœºæ™¯IDåˆ—è¡¨æ•°ç»„ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }
                
                addLog(`å‡†å¤‡æ¿€æ´» ${sceneIdsData.length} ä¸ªåœºæ™¯`, 'info');
                
                // æ‰§è¡Œæµ‹è¯•
                executeAPITest('testActivateScenes', 'POST', '/api/home_assistant/home_assistant/scenes/activate', sceneIdsData);
            } catch (error) {
                addLog('æ‰§è¡Œé”™è¯¯: ' + error.message, 'error');
                console.error('Activate scenes error:', error);
            }
        }

        function testDeleteScene() {
            executeAPITest('testDeleteScene', 'DELETE', '/api/home_assistant/home_assistant/scene/{scene_id}', ['scene_id']);
        }

        function testDeleteScenes() {
            try {
                // ä»textareaè¯»å–JSONæ•°æ®
                const sceneIdsInput = document.getElementById('testDeleteScenes-scene_ids');
                if (!sceneIdsInput || !sceneIdsInput.value.trim()) {
                    addLog('è¯·è¾“å…¥åœºæ™¯IDåˆ—è¡¨JSONæ•°æ®', 'error');
                    return;
                }
                
                // è·å–è¾“å…¥å€¼å¹¶æ¸…ç†å¯èƒ½çš„ç‰¹æ®Šå­—ç¬¦
                let inputValue = sceneIdsInput.value.trim();
                
                // å°è¯•è§£æJSON
                let sceneIdsData;
                try {
                    sceneIdsData = JSON.parse(inputValue);
                } catch (parseError) {
                    addLog('JSONæ ¼å¼é”™è¯¯: ' + parseError.message, 'error');
                    addLog('æç¤º: è¯·æ£€æŸ¥JSONæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œå¯ä»¥ä½¿ç”¨"ğŸ“ å¡«å……ç¤ºä¾‹"æŒ‰é’®æŸ¥çœ‹æ­£ç¡®æ ¼å¼', 'info');
                    return;
                }
                
                // éªŒè¯æ˜¯å¦ä¸ºæ•°ç»„
                if (!Array.isArray(sceneIdsData)) {
                    addLog('åœºæ™¯IDåˆ—è¡¨å¿…é¡»æ˜¯JSONæ•°ç»„æ ¼å¼', 'error');
                    return;
                }
                
                // éªŒè¯æ•°ç»„ä¸ä¸ºç©º
                if (sceneIdsData.length === 0) {
                    addLog('åœºæ™¯IDåˆ—è¡¨æ•°ç»„ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }
                
                addLog(`å‡†å¤‡åˆ é™¤ ${sceneIdsData.length} ä¸ªåœºæ™¯`, 'info');
                
                // æ‰§è¡Œæµ‹è¯•
                executeAPITest('testDeleteScenes', 'POST', '/api/home_assistant/home_assistant/scenes/delete', sceneIdsData);
            } catch (error) {
                addLog('æ‰§è¡Œé”™è¯¯: ' + error.message, 'error');
                console.error('Delete scenes error:', error);
            }
        }

        function testBatchControl() {
            try {
                // ä»textareaè¯»å–JSONæ•°æ®
                const commandsInput = document.getElementById('testBatchControl-commands');
                if (!commandsInput || !commandsInput.value.trim()) {
                    addLog('è¯·è¾“å…¥æ‰¹é‡æ§åˆ¶å‘½ä»¤JSONæ•°æ®', 'error');
                    return;
                }
                
                // è·å–è¾“å…¥å€¼å¹¶æ¸…ç†å¯èƒ½çš„ç‰¹æ®Šå­—ç¬¦
                let inputValue = commandsInput.value.trim();
                
                // å°è¯•è§£æJSON
                let batchData;
                try {
                    batchData = JSON.parse(inputValue);
                } catch (parseError) {
                    // JSONè§£æå¤±è´¥ï¼Œæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                    const errorPos = parseError.message.match(/position (\d+)/);
                    if (errorPos) {
                        const pos = parseInt(errorPos[1]);
                        const context = inputValue.substring(Math.max(0, pos - 20), Math.min(inputValue.length, pos + 20));
                        addLog(`JSONè§£æé”™è¯¯åœ¨ä½ç½® ${pos}: "${context}"`, 'error');
                    }
                    addLog('JSONæ ¼å¼é”™è¯¯: ' + parseError.message, 'error');
                    addLog('æç¤º: è¯·æ£€æŸ¥JSONæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œå¯ä»¥ä½¿ç”¨"ğŸ“ å¡«å……ç¤ºä¾‹"æŒ‰é’®æŸ¥çœ‹æ­£ç¡®æ ¼å¼', 'info');
                    return;
                }
                
                // éªŒè¯æ˜¯å¦ä¸ºæ•°ç»„
                if (!Array.isArray(batchData)) {
                    addLog('æ‰¹é‡æ§åˆ¶å‘½ä»¤å¿…é¡»æ˜¯JSONæ•°ç»„æ ¼å¼', 'error');
                    return;
                }
                
                // éªŒè¯æ•°ç»„ä¸ä¸ºç©º
                if (batchData.length === 0) {
                    addLog('æ‰¹é‡æ§åˆ¶å‘½ä»¤æ•°ç»„ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }
                
                // éªŒè¯æ¯ä¸ªå‘½ä»¤çš„å¿…å¡«å­—æ®µ
                for (let i = 0; i < batchData.length; i++) {
                    const cmd = batchData[i];
                    if (!cmd.entity_id) {
                        addLog(`å‘½ä»¤ ${i + 1} ç¼ºå°‘å¿…å¡«å­—æ®µ entity_id`, 'error');
                        return;
                    }
                    if (!cmd.service) {
                        addLog(`å‘½ä»¤ ${i + 1} ç¼ºå°‘å¿…å¡«å­—æ®µ service`, 'error');
                        return;
                    }
                }
                
                addLog(`å‡†å¤‡æ‰§è¡Œ ${batchData.length} ä¸ªæ‰¹é‡æ§åˆ¶å‘½ä»¤`, 'info');
                
                // æ‰§è¡Œæµ‹è¯•
                executeAPITest('testBatchControl', 'POST', '/api/home_assistant/home_assistant/batch-control', batchData);
            } catch (error) {
                addLog('æ‰§è¡Œé”™è¯¯: ' + error.message, 'error');
                console.error('Batch control error:', error);
            }
        }

        // Format batch control JSON
        function formatBatchControlJSON() {
            try {
                const commandsInput = document.getElementById('testBatchControl-commands');
                if (!commandsInput || !commandsInput.value.trim()) {
                    addLog('è¯·å…ˆè¾“å…¥JSONæ•°æ®', 'error');
                    return;
                }
                
                // è§£æå¹¶æ ¼å¼åŒ–JSON
                const parsed = JSON.parse(commandsInput.value.trim());
                const formatted = JSON.stringify(parsed, null, 2);
                commandsInput.value = formatted;
                addLog('JSONæ ¼å¼åŒ–æˆåŠŸ', 'success');
            } catch (error) {
                addLog('JSONæ ¼å¼åŒ–å¤±è´¥: ' + error.message, 'error');
                addLog('æç¤º: è¯·å…ˆç¡®ä¿è¾“å…¥çš„æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼', 'info');
            }
        }

        // Fill example data
        function fillExampleData(testFunction) {
            const examples = {
                testSpaces: {
                    op: "floors"
                },
                testBatchControl: {
                    commands: JSON.stringify([
                        {
                            "entity_id": "climate.text_ac_01",
                            "service": "climate.set_temperature",
                            "service_data": {
                                "temperature": 20
                            }
                        },
                        {
                            "entity_id": "climate.ac_01",
                            "service": "climate.set_temperature",
                            "service_data": {
                                "temperature": 20
                            }
                        },
                        {
                            "entity_id": "light.light_test_001",
                            "service": "light.turn_on",
                            "service_data": {
                                "color_name": "blue",
                                "brightness": 255
                            }
                        }
                    ], null, 2)
                },
                testBatchStates: {
                    entities: JSON.stringify([
                        {
                            "entity_id": "climate.text_ac_01"
                        },
                        {
                            "entity_id": "light.light_test_001"
                        },
                        {
                            "entity_id": "sensor.temp_01"
                        }
                    ], null, 2)
                },
                testActivateScene: {
                    scene_id: "scene.romantic_lights"
                },
                testCreateScene: {
                    scene_id: "scene.my_custom_scene",
                    snapshot_entities: JSON.stringify([
                        "light.living_room",
                        "light.bedroom",
                        "climate.living_room"
                    ], null, 2),
                    entities: JSON.stringify({
                        "light.living_room": {
                            "state": "on",
                            "brightness": 50,
                            "rgb_color": [255, 0, 0]
                        },
                        "light.bedroom": {
                            "state": "off"
                        }
                    }, null, 2)
                },
                testActivateScenes: {
                    scene_ids: JSON.stringify([
                        "scene.romantic_lights",
                        "scene.movie_time",
                        "scene.good_morning"
                    ], null, 2)
                },
                testDeleteScene: {
                    scene_id: "scene.test_scene"
                },
                testDeleteScenes: {
                    scene_ids: JSON.stringify([
                        "scene.test_scene_1",
                        "scene.test_scene_2"
                    ], null, 2)
                },
                testGetAutomation: {
                    automation_id: "automation.morning_lights"
                },
                testCreateAutomation: {
                    automation_config: JSON.stringify({
                        "id": "test_automation_" + Date.now(),
                        "alias": "æµ‹è¯•è‡ªåŠ¨åŒ– - æ™šä¸Š10ç‚¹å…³ç¯",
                        "description": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è‡ªåŠ¨åŒ–",
                        "trigger": [
                            {
                                "platform": "time",
                                "at": "22:00:00"
                            }
                        ],
                        "condition": [],
                        "action": [
                            {
                                "service": "light.turn_off",
                                "target": {
                                    "entity_id": "light.living_room"
                                }
                            }
                        ],
                        "mode": "single"
                    }, null, 2)
                },
                testDeleteAutomation: {
                    automation_id: "automation.test_automation"
                },
                testEnableAutomation: {
                    automation_id: "automation.morning_lights"
                },
                testDisableAutomation: {
                    automation_id: "automation.morning_lights"
                },
                testTriggerAutomation: {
                    automation_id: "automation.morning_lights"
                }
            };

            const example = examples[testFunction];
            if (example) {
                Object.keys(example).forEach(key => {
                    const element = document.getElementById(`${testFunction}-${key}`);
                    if (element) {
                        element.value = example[key];
                    }
                });
                addLog(`å·²å¡«å…… ${testFunction} çš„ç¤ºä¾‹æ•°æ®`, 'info');
            }
        }

        // Copy response
        function copyResponse(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                navigator.clipboard.writeText(element.textContent);
                addLog('å“åº”å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'info');
            }
        }

        function copyQuickResponse() {
            copyResponse('quick-response-body');
        }

        function closeQuickResponse() {
            document.getElementById('quick-response').classList.add('hidden');
        }

        // Automation test functions
        function testGetAutomations() {
            executeAPITest('testGetAutomations', 'GET', '/api/home_assistant/home_assistant/automations');
        }

        function testGetAutomation() {
            executeAPITest('testGetAutomation', 'GET', '/api/home_assistant/home_assistant/automation/{automation_id}', ['automation_id']);
        }

        function testCreateAutomation() {
            try {
                // ä»textareaè¯»å–JSONæ•°æ®
                const configInput = document.getElementById('testCreateAutomation-automation_config');
                if (!configInput || !configInput.value.trim()) {
                    addLog('è¯·è¾“å…¥è‡ªåŠ¨åŒ–é…ç½®JSONæ•°æ®', 'error');
                    return;
                }
                
                // è·å–è¾“å…¥å€¼å¹¶æ¸…ç†å¯èƒ½çš„ç‰¹æ®Šå­—ç¬¦
                let inputValue = configInput.value.trim();
                
                // å°è¯•è§£æJSON
                let automationConfig;
                try {
                    automationConfig = JSON.parse(inputValue);
                } catch (parseError) {
                    addLog('JSONæ ¼å¼é”™è¯¯: ' + parseError.message, 'error');
                    addLog('æç¤º: è¯·æ£€æŸ¥JSONæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œå¯ä»¥ä½¿ç”¨"ğŸ“ å¡«å……ç¤ºä¾‹"æŒ‰é’®æŸ¥çœ‹æ­£ç¡®æ ¼å¼', 'info');
                    return;
                }
                
                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!automationConfig.alias) {
                    addLog('è‡ªåŠ¨åŒ–é…ç½®å¿…é¡»åŒ…å« alias å­—æ®µï¼ˆåç§°ï¼‰', 'error');
                    return;
                }
                
                if (!automationConfig.trigger || !Array.isArray(automationConfig.trigger) || automationConfig.trigger.length === 0) {
                    addLog('è‡ªåŠ¨åŒ–é…ç½®å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ª triggerï¼ˆè§¦å‘å™¨ï¼‰', 'error');
                    return;
                }
                
                if (!automationConfig.action || !Array.isArray(automationConfig.action) || automationConfig.action.length === 0) {
                    addLog('è‡ªåŠ¨åŒ–é…ç½®å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ª actionï¼ˆåŠ¨ä½œï¼‰', 'error');
                    return;
                }
                
                addLog('å‡†å¤‡åˆ›å»ºè‡ªåŠ¨åŒ–: ' + automationConfig.alias, 'info');
                
                // æ‰§è¡Œæµ‹è¯•
                executeAPITest('testCreateAutomation', 'POST', '/api/home_assistant/home_assistant/automation/create', automationConfig);
            } catch (error) {
                addLog('æ‰§è¡Œé”™è¯¯: ' + error.message, 'error');
                console.error('Create automation error:', error);
            }
        }

        function testDeleteAutomation() {
            executeAPITest('testDeleteAutomation', 'DELETE', '/api/home_assistant/home_assistant/automation/{automation_id}', ['automation_id']);
        }

        function testEnableAutomation() {
            executeAPITest('testEnableAutomation', 'POST', '/api/home_assistant/home_assistant/automation/{automation_id}/enable', ['automation_id']);
        }

        function testDisableAutomation() {
            executeAPITest('testDisableAutomation', 'POST', '/api/home_assistant/home_assistant/automation/{automation_id}/disable', ['automation_id']);
        }

        function testTriggerAutomation() {
            executeAPITest('testTriggerAutomation', 'POST', '/api/home_assistant/home_assistant/automation/{automation_id}/trigger', ['automation_id']);
        }

        function testReloadAutomations() {
            executeAPITest('testReloadAutomations', 'POST', '/api/home_assistant/home_assistant/automations/reload');
        }

        // Log management
        function addLog(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.unshift({ timestamp, message, level });

            // Keep only last 100 logs
            if (logs.length > 100) {
                logs = logs.slice(0, 100);
            }

            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContent = document.getElementById('log-content');
            logContent.innerHTML = logs.map(log => `
                <div class="log-entry">
                    <span class="log-timestamp">${log.timestamp}</span>
                    <span class="log-level-${log.level}">${log.message}</span>
                </div>
            `).join('');
        }

        function clearLogs() {
            logs = [];
            updateLogDisplay();
        }

        function toggleLogPanel() {
            const panel = document.getElementById('log-panel');
            panel.classList.toggle('hidden');
        }

        // Initialize with first log
        addLog('Home Assistant API æ–‡æ¡£å·²åŠ è½½å®Œæˆ', 'success');
    </script>
</body>
</html>
