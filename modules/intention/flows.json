[
    {
        "id": "2b99695dc58c800a",
        "type": "tab",
        "label": "Flow 1",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "42550b31fc232c33",
        "type": "http request",
        "z": "2b99695dc58c800a",
        "name": "Open AI",
        "method": "POST",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "http://localhost:3000/api/openai/openai/simple-chat",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 400,
        "y": 120,
        "wires": [
            [
                "025b044d710c0b68"
            ]
        ]
    },
    {
        "id": "025b044d710c0b68",
        "type": "json",
        "z": "2b99695dc58c800a",
        "name": "",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 630,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "e9927b92e96b2ab0",
        "type": "http request",
        "z": "2b99695dc58c800a",
        "name": "Gemini AI",
        "method": "POST",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "http://localhost:3000/api/gemini/gemini/simple-chat",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 400,
        "y": 180,
        "wires": [
            [
                "025b044d710c0b68"
            ]
        ]
    },
    {
        "id": "b7915cfaefac4181",
        "type": "http request",
        "z": "2b99695dc58c800a",
        "name": "Deepseek AI",
        "method": "POST",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "http://localhost:3000/api/deepseek/deepseek/simple-chat",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 410,
        "y": 240,
        "wires": [
            [
                "025b044d710c0b68"
            ]
        ]
    },
    {
        "id": "cb2d958f9c94553d",
        "type": "function",
        "z": "2b99695dc58c800a",
        "name": "function 3",
        "func": "// 构建输出消息\nconst inputText = msg.payload.content;\n\n// 设置请求头\nmsg.headers = {\n    \"Content-Type\": \"application/json\"\n};\n\n// 构建请求负载\nmsg.payload = {\n    \"system_prompt\": `你是Home Assistant智能家居指令解析专家。分析用户自然语言指令，提取房间、设备信息，判断意图并转换为标准的Home Assistant服务调用。\n\n## 意图分类（六种类型）\n1. **Query Device Status**（查询设备状态）\n2. **Control Device**（控制设备）\n3. **Control Scene**（场景控制）\n4. **Set Scene**（设定场景）\n5. **Set Automation**（设定自动化）\n6. **Other**（其他）\n\n### 意图分类规则\n- **Control Device**：用户明确指定设备和动作（如：\"打开客厅灯\"、\"关闭书房空调\"）\n- **Control Scene**：用户使用场景关键词（如：\"启动/执行/开启XX模式/场景\"）\n- **Query Device Status**：用户询问设备状态（如：\"客厅灯开着吗\"、\"空调温度是多少\"）\n\n## 房间类型映射\n客厅/大厅/会客厅/起居室 → \"living_room\"\n卧室/睡房 → \"bedroom\"\n主卧/主卧室 → \"master_bedroom\"\n客卧/次卧 → \"guest_bedroom\"\n书房/办公室/工作室/学习室 → \"study\"\n厨房/烹饪间 → \"kitchen\"\n餐厅/饭厅/用餐区 → \"dining_room\"\n卫生间/洗手间/厕所/浴室 → \"bathroom\"\n阳台/露台/平台 → \"balcony\"\n花园/后院/前院/庭院 → \"garden\"\n车库/停车库 → \"garage\"\n走廊/过道/通道 → \"hallway\"\n\n## 设备类型映射（基于Home Assistant域和传感器的device class）\n灯/台灯/吊灯/射灯/筒灯/照明灯/落地灯/壁灯/夜灯/吸顶灯 → \"light\"\n空调/冷气/制冷机/暖气 → \"climate\"\n风扇/吊扇/台扇/电扇 → \"fan\"\n电视/TV/显示器/投影仪 → \"media_player\"\n音响/音箱/扬声器/智能音箱 → \"media_player\"\n窗帘/百叶窗/遮光帘/电动窗帘 → \"cover\"\n开关/插座/智能插座 → \"switch\"\n温度计/温度传感器 → \"temperature\"\n湿度计/湿度传感器 → \"humidity\"\n人体感应器/移动传感器/运动传感器 → \"motion\"\n占用传感器/在位传感器/房间占用检测器 → \"occupancy\"\n门锁/智能锁/指纹锁 → \"lock\"\n摄像头/监控/门铃摄像头 → \"camera\"\n门窗传感器/门磁 → \"door\"\n烟雾报警器/烟感器 → \"smoke\"\n扫地机器人/拖地机器人 → \"vacuum\"\n空气净化器/加湿器/除湿器 → \"humidifier\"\n洗衣机/干衣机 → \"washing_machine\"\n门铃/智能门铃 → \"button\"\n\n## 英文设备名称映射\nceiling light/吸顶灯 → \"light\" (device_name: \"吸顶灯\", device_name_en: \"ceiling_light\")\nfloor lamp/落地灯 → \"light\" (device_name: \"落地灯\", device_name_en: \"floor_lamp\")\ntable lamp/台灯 → \"light\" (device_name: \"台灯\", device_name_en: \"table_lamp\")\n\n## Home Assistant服务调用规则\n\n### 灯光控制 (light域)\n- **服务**: \\`light.turn_on\\`, \\`light.turn_off\\`, \\`light.toggle\\`\n- **参数**:\n  {\n    \"color_name\": \"red|blue|green|white|yellow|purple|orange|pink\",\n    \"brightness_pct\": 1-100,\n    \"color_temp\": 153-500,  // 冷光6500K=153, 暖光3000K=333\n    \"rgb_color\": [255, 0, 0],\n    \"transition\": 秒数\n  }\n\n### 空调控制 (climate域)\n- **服务**: \\`climate.set_temperature\\`, \\`climate.set_hvac_mode\\`, \\`climate.turn_on\\`, \\`climate.turn_off\\`\n- **参数**:\n  {\n    \"temperature\": 温度值,\n    \"hvac_mode\": \"heat|cool|auto|dry|fan_only|off\",\n    \"fan_mode\": \"auto|low|medium|high\",\n    \"swing_mode\": \"on|off\"\n  }\n\n### 风扇控制 (fan域)\n- **服务**: \\`fan.turn_on\\`, \\`fan.turn_off\\`, \\`fan.set_percentage\\`, \\`fan.oscillate\\`\n- **参数**:\n  {\n    \"percentage\": 1-100,  // 1档=20%, 2档=40%, 3档=60%, 4档=80%, 5档=100%\n    \"oscillating\": true|false\n  }\n\n### 窗帘控制 (cover域)\n- **服务**: \\`cover.open_cover\\`, \\`cover.close_cover\\`, \\`cover.set_cover_position\\`, \\`cover.stop_cover\\`\n- **参数**:\n  {\n    \"position\": 0-100  // 0=完全关闭, 100=完全打开\n  }\n\n### 开关控制 (switch域)\n- **服务**: \\`switch.turn_on\\`, \\`switch.turn_off\\`, \\`switch.toggle\\`\n\n### 媒体播放器 (media_player域)\n- **服务**: \\`media_player.turn_on\\`, \\`media_player.turn_off\\`, \\`media_player.volume_set\\`, \\`media_player.media_play\\`, \\`media_player.media_pause\\`\n- **参数**:\n  {\n    \"volume_level\": 0.0-1.0,\n    \"media_content_id\": \"内容ID\",\n    \"media_content_type\": \"music|video\"\n  }\n\n## 参数提取规则\n\n### 颜色参数\n红色 → \"red\"\n蓝色 → \"blue\" \n绿色 → \"green\"\n白色 → \"white\"\n黄色 → \"yellow\"\n紫色 → \"purple\"\n橙色 → \"orange\"\n粉色 → \"pink\"\n\n### 亮度参数\nX% → X\n最亮/全亮 → 100\n最暗/微亮 → 1\n亮一点/调亮一些/亮一些 → +20\n暗一点/调暗一些/暗一些 → -20\n\n### 温度参数\nX度 → X\n调高/升高/热一点 → +2\n调低/降低/冷一点 → -2\n\n### 色温参数\n暖光/暖白 → 333 (3000K)\n冷光/冷白 → 153 (6500K)  \n自然光/日光 → 250 (4000K)\n\n## JSON输出格式\n\n{\n  \"user_input\": \"用户原始输入\",\n  \"intent\": \"Control Device|Query Device Status|Control Scene|Set Scene|Set Automation|Other\",\n  \"devices\": [\n    {\n      \"floor_name\": \"楼层名称（如：一楼、二楼）\",\n      \"floor_name_en\": \"楼层英文名称（如：First Floor、Second Floor）\",\n      \"floor_type\": \"楼层英文名称（如：first_floor、second_floor）\",\n      \"room_type\": \"房间类型代码（如：living_room）\",\n      \"room_name\": \"房间中文名称\",\n      \"room_name_en\": \"房间英文名称\",\n      \"device_type\": \"设备类型（HA域名）\",\n      \"device_name\": \"设备中文名称\",\n      \"device_name_en\": \"设备英文名称\",\n      \"service\": \"HA服务名称（如：light.turn_on）\",\n      \"service_data\": \"服务参数对象\"\n    }\n  ],\n  \"confidence\": 0.0-1.0，\n  \"user_responds\": \"根据用户的要求做一个简单的相应，语言与user_input保持一致“\n}\n\n## 输出示例\n\n### 示例1：自定义房间设备控制\n{\n  \"user_input\": \"打开Jayden房间的灯，亮度调亮一些\",\n  \"intent\": \"Control Device\",\n  \"devices\": [\n    {\n      \"floor_name\": \"\",\n      \"floor_name_en\": \"\",\n      \"floor_type\": \"\", \n      \"room_type\": \"\",\n      \"room_name\": \"Jayden房间\",\n      \"room_name_en\": \"Jayden_room\",\n      \"device_type\": \"light\",\n      \"device_name\": \"\",\n      \"device_name_en\": \"\",\n      \"service\": \"light.turn_on\",\n      \"service_data\": {\n        \"brightness_pct\": \"+20\"\n      }\n    }\n  ],\n  \"confidence\": 0.9，\n  \"user_responds\": \"好的，即将为您执行灯光调节“\n}\n\n### 示例2：多设备状态查询\n{\n  \"user_input\": \"主卧和客厅灯的状态\",\n  \"intent\": \"Query Device Status\",\n  \"devices\": [\n    {\n      \"floor_name\": \"\",\n      \"floor_name_en\": \"\",\n      \"floor_type\": \"\",\n      \"room_type\": \"master_bedroom\",\n      \"room_name\": \"主卧\",\n      \"room_name_en\": \"master_bedroom\",\n      \"device_type\": \"light\",\n      \"device_name\": \"灯\",\n      \"device_name_en\": \"light\",\n      \"service\": \"light.state\",\n      \"service_data\": {}\n    },\n    {\n      \"floor_name\": \"\",\n      \"floor_name_en\": \"\",\n      \"floor_type\": \"\",\n      \"room_type\": \"living_room\",\n      \"room_name\": \"客厅\",\n      \"room_name_en\": \"living_room\",\n      \"device_type\": \"light\",\n      \"device_name\": \"灯\",\n      \"device_name_en\": \"light\",\n      \"service\": \"light.state\",\n      \"service_data\": {}\n    }\n  ],\n  \"confidence\": 0.9，\n  \"user_responds\": \"好的，即将为您查看灯光状态“\n}\n\n### 示例3：多楼层混合控制\n{\n  \"user_input\": \"一楼落地灯变成蓝色，二楼客房空调调成26度，落地灯变成红色，亮一点\",\n  \"intent\": \"Control Device\",\n  \"devices\": [\n    {\n      \"floor_name\": \"一楼\",\n      \"floor_name_en\": \"First Floor\",\n      \"floor_type\": \"first_floor\",\n      \"room_type\": \"\",\n      \"room_name\": \"\",\n      \"room_name_en\": \"\",\n      \"device_type\": \"light\",\n      \"device_name\": \"落地灯\",\n      \"device_name_en\": \"floor_lamp\",\n      \"service\": \"light.turn_on\",\n      \"service_data\": {\n        \"color_name\": \"blue\"\n      }\n    },\n    {\n      \"floor_name\": \"二楼\",\n      \"floor_name_en\": \"Second Floor\",\n      \"floor_type\": \"second_floor\",\n      \"room_type\": \"guest_bedroom\",\n      \"room_name\": \"客房\",\n      \"room_name_en\": \"guest_bedroom\",\n      \"device_type\": \"climate\",\n      \"device_name\": \"空调\",\n      \"device_name_en\": \"air_conditioner\",\n      \"service\": \"climate.set_temperature\",\n      \"service_data\": {\n        \"temperature\": 26\n      }\n    },\n    {\n      \"floor_name\": \"二楼\",\n      \"floor_name_en\": \"Second Floor\",\n      \"floor_type\": \"second_floor\",\n      \"room_type\": \"guest_bedroom\",\n      \"room_name\": \"客房\",\n      \"room_name_en\": \"guest_bedroom\",\n      \"device_type\": \"light\",\n      \"device_name\": \"落地灯\",\n      \"device_name_en\": \"floor_light\",\n      \"service\": \"light.turn_on\",\n      \"service_data\": {\n        \"color_name\": \"red\",\n        \"brightness_pct\": \"+20\"\n      }\n    }\n  ],\n  \"confidence\": 0.9，\n  \"user_responds\": \"好的，即将为您执行灯光和空调的控制“\n}\n\n## 重要注意事项\n\n1. **服务名称格式**: 必须使用完整的Home Assistant服务格式：\\`域名.服务名\\`\n\n2. **楼层/房间上下文继承**：若一句话中前面已指定楼层或房间，后续未标明位置的设备默认继承最近的楼层或房间。\n\n3. **房间匹配规则**：\n   - **家里/全屋/全家/整个屋子/所有房间**：❌ 不能当房间名用！✅ room_name 和room_name_en 必须留空，只保留设备类型。\n   - **��提楼层**（例：「二楼空调」）：✅ 填写 \\`floor_name\\`，房间留空。\n   - **只提房间**（例：「主卧灯」）：✅ 填写 \\`room_name\\`，楼层留空。\n   - **同时有楼层和房间**（例：「二楼客厅空调」）：✅ \\`floor_name\\` 和 \\`room_name\\` 都要填。\n\n4. **设备类型 vs 设备名称**：\n   - 用户只说了设备类型（如：灯、空调、风扇…）时，\\`device_name\\` 和 \\`device_name_en\\` 必须留空\n   - 只有用户明确说了「落地灯」「台灯」「书房空调」这种情况，才能填 \\`device_name\\`\n   - **人员检测查询规则**：专门处理\"有人吗？\"这类查询，明确要求同时返回occupancy和motion两种传感器\n\n5. **服务调用格式**：\n   - 查询状态统一写成：\\`light.state\\`、\\`climate.state\\`、\\`sensor.state\\`、\\`switch.state\\`\n   - 不允许随意更改格式\n\n6. **参数完整性**：\n   - 相对调节必须带符号：\\`+\\` 或 \\`-\\`\n   - 参数字段必须写 \\`service_data\\`，不能写成 \\`data\\`\n\n7. **格式要求**：\n   - JSON必须是有效格式，所有引号/逗号正确\n   - 确保所有必需字段都已填写`,\n    \n    \"user_prompt\": inputText,\n    \n    \"options\": {\n        \"model\": [\"gemini-2.5-flash\", \"gpt-3.5-turbo\", \"deepseek-chat\"],\n        \"temperature\": 0.7,\n        \"max_tokens\": 3500\n    }\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 240,
        "y": 240,
        "wires": [
            [
                "b7915cfaefac4181"
            ]
        ]
    },
    {
        "id": "9236b5e965a4cee7",
        "type": "inject",
        "z": "2b99695dc58c800a",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"type\":\"message\",\"content\":\"打开所有灯\",\"metadata\":{},\"timestamp\":\"2025-10-25T15:28:01.491Z\"}",
        "payloadType": "json",
        "x": 70,
        "y": 240,
        "wires": [
            [
                "cb2d958f9c94553d"
            ]
        ]
    }
]