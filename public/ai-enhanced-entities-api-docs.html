<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤– AI Enhanced Entities API æµ‹è¯•æ–‡æ¡£</title>
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --secondary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --light: #f5f5f5;
            --dark: #1f2937;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.6;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
            padding: 2rem;
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .panel {
            background: var(--white);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light);
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-success {
            background: var(--success);
            color: white;
        }

        .status-error {
            background: var(--danger);
            color: white;
        }

        .status-warning {
            background: var(--warning);
            color: white;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #2563eb;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--light);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea.form-control {
            min-height: 300px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        select.form-control {
            cursor: pointer;
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid var(--info);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .success-box {
            background: #f0fdf4;
            border-left: 4px solid var(--success);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .warning-box {
            background: #fffbeb;
            border-left: 4px solid var(--warning);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .error-box {
            background: #fef2f2;
            border-left: 4px solid var(--danger);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .code-block {
            background: #1f2937;
            color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            margin: 1rem 0;
            line-height: 1.6;
        }

        .json-key {
            color: #60a5fa;
        }

        .json-string {
            color: #34d399;
        }

        .json-number {
            color: #fbbf24;
        }

        .json-boolean {
            color: #f472b6;
        }

        .json-null {
            color: #9ca3af;
        }

        .entity-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: box-shadow 0.3s;
        }

        .entity-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .entity-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .entity-id {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        .entity-badges {
            display: flex;
            gap: 0.5rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .api-endpoint {
            background: var(--light);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .api-method {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-weight: bold;
            font-size: 0.875rem;
            margin-right: 0.5rem;
        }

        .method-get {
            background: #3b82f6;
            color: white;
        }

        .method-post {
            background: #10b981;
            color: white;
        }

        .method-put {
            background: #f59e0b;
            color: white;
        }

        .method-delete {
            background: #ef4444;
            color: white;
        }

        .api-path {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: var(--dark);
        }

        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--light);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #6b7280;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ¤– AI Enhanced Entities API</h1>
            <p>æ™ºèƒ½å¢å¼ºå®ä½“å·¥ä½œæµç®¡ç†ä¸æµ‹è¯•å¹³å°</p>
            <div class="stats">
                <div class="stat-card">
                    <span class="stat-number" id="workflowCount">-</span>
                    <span class="stat-label">å·¥ä½œæµæ‰§è¡Œæ¬¡æ•°</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="entityCount">-</span>
                    <span class="stat-label">å¢å¼ºå®ä½“æ•°é‡</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="aiProvider">-</span>
                    <span class="stat-label">AI æä¾›å•†</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="triggerSource">-</span>
                    <span class="stat-label">è§¦å‘æ¥æº</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="lastRun">-</span>
                    <span class="stat-label">æœ€åè¿è¡Œæ—¶é—´</span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="panel">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('workflow')">ğŸš€ å·¥ä½œæµç®¡ç†</button>
                <button class="tab" onclick="switchTab('prompt')">ğŸ“ ç³»ç»Ÿæç¤ºè¯</button>
                <button class="tab" onclick="switchTab('results')">ğŸ“Š æŸ¥çœ‹ç»“æœ</button>
                <button class="tab" onclick="switchTab('docs')">ğŸ“š API æ–‡æ¡£</button>
            </div>

            <!-- Workflow Tab -->
            <div id="tab-workflow" class="tab-content active">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸš€ è¿è¡Œ AI å¢å¼ºå·¥ä½œæµ</h2>
                </div>

                <div class="info-box">
                    <strong>â„¹ï¸ å·¥ä½œæµè¯´æ˜ï¼š</strong>
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li>è‡ªåŠ¨è·å– Home Assistant çš„æ¥¼å±‚å’Œæˆ¿é—´ä¿¡æ¯</li>
                        <li>ä½¿ç”¨ AI ç¿»è¯‘å¹¶æ ‡å‡†åŒ–æ¥¼å±‚å’Œæˆ¿é—´åç§°</li>
                        <li>ä¸ºæ‰€æœ‰å®ä½“æ·»åŠ å¢å¼ºå­—æ®µï¼ˆå¦‚ room_name_en, floor_type ç­‰ï¼‰</li>
                        <li>ç»“æœä¿å­˜åˆ°æœ¬åœ°ï¼Œå¯é€šè¿‡ API è·å–</li>
                    </ul>
                </div>

                <div class="form-group">
                    <label class="form-label">AI æä¾›å•†</label>
                    <select id="providerSelect" class="form-control">
                        <option value="auto">è‡ªåŠ¨é€‰æ‹©ï¼ˆæ¨èï¼‰</option>
                        <option value="gemini">Gemini</option>
                        <option value="openai">OpenAI</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="claude">Claude</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="runWorkflow()">
                    â–¶ï¸ è¿è¡Œå·¥ä½œæµ
                </button>

                <div id="workflowResult" class="hidden" style="margin-top: 1.5rem;"></div>
            </div>

            <!-- Prompt Tab -->
            <div id="tab-prompt" class="tab-content">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸ“ ç³»ç»Ÿæç¤ºè¯ç®¡ç†</h2>
                    <span id="promptStatus" class="status-badge"></span>
                </div>

                <div class="warning-box">
                    <strong>âš ï¸ æ³¨æ„ï¼š</strong> ä¿®æ”¹ç³»ç»Ÿæç¤ºè¯å°†å½±å“ AI å¯¹æ¥¼å±‚å’Œæˆ¿é—´çš„ç†è§£å’Œç¿»è¯‘ã€‚è¯·ç¡®ä¿æç¤ºè¯å‡†ç¡®æè¿°äº†éœ€æ±‚ã€‚
                </div>

                <div class="form-group">
                    <label class="form-label">ç³»ç»Ÿæç¤ºè¯</label>
                    <textarea id="systemPrompt" class="form-control" placeholder="åŠ è½½ä¸­..."></textarea>
                </div>

                <div class="grid-2">
                    <button class="btn btn-success" onclick="savePrompt()">
                        ğŸ’¾ ä¿å­˜è‡ªå®šä¹‰æç¤ºè¯
                    </button>
                    <button class="btn btn-danger" onclick="resetPrompt()">
                        ğŸ”„ æ¢å¤é»˜è®¤æç¤ºè¯
                    </button>
                </div>

                <div id="promptResult" class="hidden" style="margin-top: 1.5rem;"></div>
            </div>

            <!-- Results Tab -->
            <div id="tab-results" class="tab-content">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸ“Š å¢å¼ºå®ä½“ç»“æœ</h2>
                    <button class="btn btn-secondary" onclick="loadResults()">
                        ğŸ”„ åˆ·æ–°
                    </button>
                </div>

                <div class="form-group">
                    <label class="form-label">ç­›é€‰é€‰é¡¹</label>
                    <div class="grid-2">
                        <input type="text" id="filterEntityId" class="form-control" placeholder="æŒ‰ entity_id ç­›é€‰...">
                        <select id="filterRoomName" class="form-control">
                            <option value="">æ‰€æœ‰æˆ¿é—´</option>
                        </select>
                    </div>
                </div>

                <div id="resultsContainer">
                    <p style="text-align: center; color: #6b7280;">ç‚¹å‡»"åˆ·æ–°"åŠ è½½æœ€æ–°ç»“æœ</p>
                </div>

                <div id="paginationContainer" class="hidden" style="margin-top: 1.5rem; text-align: center;">
                    <button class="btn btn-secondary" onclick="previousPage()" id="prevBtn">â¬…ï¸ ä¸Šä¸€é¡µ</button>
                    <span id="pageInfo" style="margin: 0 1rem; font-weight: 600;">ç¬¬ 1 é¡µ</span>
                    <button class="btn btn-secondary" onclick="nextPage()" id="nextBtn">ä¸‹ä¸€é¡µ â¡ï¸</button>
                </div>
            </div>

            <!-- Docs Tab -->
            <div id="tab-docs" class="tab-content">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸ“š API æ–‡æ¡£</h2>
                </div>

                <h3 style="margin-bottom: 1rem;">å¯ç”¨çš„ API ç«¯ç‚¹</h3>

                <div class="api-endpoint">
                    <div><span class="api-method method-post">POST</span><span class="api-path">/api/ai_enhanced_entities/ai_enhanced_entities/run</span></div>
                    <p style="margin-top: 0.5rem; color: #6b7280;">è¿è¡Œ AI å¢å¼ºå·¥ä½œæµ</p>
                    <div class="code-block">POST /api/ai_enhanced_entities/ai_enhanced_entities/run
Content-Type: application/json

{
  "provider": "auto",  // auto | gemini | openai | deepseek | claude
  "trigger_source": "manual"  // optional: manual | space_change | entity_change
}

// Response
{
  "success": true,
  "data": {
    "triggered_at": "2025-10-25T12:00:00.000Z",
    "count": 56
  }
}</div>
                </div>

                <div class="api-endpoint">
                    <div><span class="api-method method-get">GET</span><span class="api-path">/api/ai_enhanced_entities/ai_enhanced_entities/saved</span></div>
                    <p style="margin-top: 0.5rem; color: #6b7280;">è·å–ä¿å­˜çš„ AI å¢å¼ºå®ä½“æ•°æ®</p>
                    <div class="code-block">GET /api/ai_enhanced_entities/ai_enhanced_entities/saved

// Response
{
  "success": true,
  "data": {
    "triggered_at": "2025-10-25T12:00:00.000Z",
    "trigger_source": "manual",
    "provider": "deepseek",
    "count": 56,
    "floors": ["first floor", "äºŒæ¥¼"],
    "rooms": ["å®¢å…", "å¨æˆ¿", "ä¹¦æˆ¿"],
    "entities": [...]
  }
}</div>
                </div>

                <div class="api-endpoint">
                    <div><span class="api-method method-get">GET</span><span class="api-path">/api/ai_enhanced_entities/ai_enhanced_entities/prompt</span></div>
                    <p style="margin-top: 0.5rem; color: #6b7280;">è·å–å½“å‰ç³»ç»Ÿæç¤ºè¯</p>
                    <div class="code-block">GET /api/ai_enhanced_entities/ai_enhanced_entities/prompt

// Response
{
  "success": true,
  "data": {
    "prompt": "...",
    "is_custom": false
  }
}</div>
                </div>

                <div class="api-endpoint">
                    <div><span class="api-method method-put">PUT</span><span class="api-path">/api/ai_enhanced_entities/ai_enhanced_entities/prompt</span></div>
                    <p style="margin-top: 0.5rem; color: #6b7280;">ä¿å­˜è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯</p>
                    <div class="code-block">PUT /api/ai_enhanced_entities/ai_enhanced_entities/prompt
Content-Type: application/json

{
  "prompt": "Your custom system prompt here..."
}</div>
                </div>

                <div class="api-endpoint">
                    <div><span class="api-method method-delete">DELETE</span><span class="api-path">/api/ai_enhanced_entities/ai_enhanced_entities/prompt</span></div>
                    <p style="margin-top: 0.5rem; color: #6b7280;">åˆ é™¤è‡ªå®šä¹‰æç¤ºè¯ï¼Œæ¢å¤é»˜è®¤</p>
                    <div class="code-block">DELETE /api/ai_enhanced_entities/ai_enhanced_entities/prompt</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/ai_enhanced_entities/ai_enhanced_entities';

        // Pagination state
        let allEntities = [];
        let filteredEntities = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Show selected tab
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Load data for specific tabs
            if (tabName === 'prompt') {
                loadPrompt();
            } else if (tabName === 'results') {
                loadResults();
            }
        }

        // Initialize
        async function init() {
            await loadStats();
        }

        // Helper function to translate trigger source
        function getTriggerSourceText(source) {
            const translations = {
                'manual': 'æ‰‹åŠ¨è§¦å‘',
                'space_change': 'ç©ºé—´å˜åŒ–',
                'entity_change': 'å®ä½“å˜åŒ–',
                'initial': 'åˆå§‹åŠ è½½'
            };
            return translations[source] || source || '-';
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/saved`);
                const data = await response.json();

                if (data.success && data.data) {
                    document.getElementById('entityCount').textContent = data.data.count || 0;
                    document.getElementById('aiProvider').textContent = data.data.provider || '-';
                    document.getElementById('triggerSource').textContent = getTriggerSourceText(data.data.trigger_source);

                    const triggeredAt = data.data.triggered_at;
                    if (triggeredAt) {
                        const date = new Date(triggeredAt);
                        document.getElementById('lastRun').textContent = date.toLocaleString('zh-CN');
                    } else {
                        document.getElementById('lastRun').textContent = 'æœªè¿è¡Œ';
                    }
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Run workflow
        async function runWorkflow() {
            const provider = document.getElementById('providerSelect').value;
            const resultDiv = document.getElementById('workflowResult');
            resultDiv.className = 'info-box';
            resultDiv.innerHTML = '<div class="loading"></div> æ­£åœ¨è¿è¡Œå·¥ä½œæµï¼Œè¯·ç¨å€™...';
            resultDiv.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider,
                        trigger_source: 'manual'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'success-box';
                    resultDiv.innerHTML = `
                        <strong>âœ… å·¥ä½œæµè¿è¡ŒæˆåŠŸï¼</strong>
                        <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                            <li>è§¦å‘æ—¶é—´: ${new Date(data.data.triggered_at).toLocaleString('zh-CN')}</li>
                            <li>å¤„ç†å®ä½“æ•°: ${data.data.count}</li>
                        </ul>
                    `;
                    await loadStats();
                } else {
                    resultDiv.className = 'error-box';
                    resultDiv.innerHTML = `<strong>âŒ é”™è¯¯ï¼š</strong> ${data.error}`;
                }
            } catch (error) {
                resultDiv.className = 'error-box';
                resultDiv.innerHTML = `<strong>âŒ è¯·æ±‚å¤±è´¥ï¼š</strong> ${error.message}`;
            }
        }

        // Load prompt
        async function loadPrompt() {
            const textarea = document.getElementById('systemPrompt');
            const statusBadge = document.getElementById('promptStatus');

            try {
                const response = await fetch(`${API_BASE}/prompt`);
                const data = await response.json();

                if (data.success) {
                    textarea.value = data.data.prompt;
                    statusBadge.textContent = data.data.is_custom ? 'è‡ªå®šä¹‰' : 'é»˜è®¤';
                    statusBadge.className = `status-badge ${data.data.is_custom ? 'status-warning' : 'status-success'}`;
                }
            } catch (error) {
                textarea.value = 'åŠ è½½å¤±è´¥: ' + error.message;
            }
        }

        // Save prompt
        async function savePrompt() {
            const prompt = document.getElementById('systemPrompt').value;
            const resultDiv = document.getElementById('promptResult');

            if (!prompt.trim()) {
                resultDiv.className = 'error-box';
                resultDiv.innerHTML = '<strong>âŒ é”™è¯¯ï¼š</strong> æç¤ºè¯ä¸èƒ½ä¸ºç©º';
                resultDiv.classList.remove('hidden');
                return;
            }

            resultDiv.className = 'info-box';
            resultDiv.innerHTML = '<div class="loading"></div> ä¿å­˜ä¸­...';
            resultDiv.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/prompt`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'success-box';
                    resultDiv.innerHTML = '<strong>âœ… ä¿å­˜æˆåŠŸï¼</strong> è‡ªå®šä¹‰æç¤ºè¯å·²ä¿å­˜ã€‚';
                    await loadPrompt();
                } else {
                    resultDiv.className = 'error-box';
                    resultDiv.innerHTML = `<strong>âŒ é”™è¯¯ï¼š</strong> ${data.error}`;
                }
            } catch (error) {
                resultDiv.className = 'error-box';
                resultDiv.innerHTML = `<strong>âŒ è¯·æ±‚å¤±è´¥ï¼š</strong> ${error.message}`;
            }
        }

        // Reset prompt
        async function resetPrompt() {
            if (!confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤æç¤ºè¯å—ï¼Ÿè¿™å°†åˆ é™¤æ‚¨çš„è‡ªå®šä¹‰æç¤ºè¯ã€‚')) {
                return;
            }

            const resultDiv = document.getElementById('promptResult');
            resultDiv.className = 'info-box';
            resultDiv.innerHTML = '<div class="loading"></div> é‡ç½®ä¸­...';
            resultDiv.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/prompt`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'success-box';
                    resultDiv.innerHTML = '<strong>âœ… é‡ç½®æˆåŠŸï¼</strong> å·²æ¢å¤é»˜è®¤æç¤ºè¯ã€‚';
                    await loadPrompt();
                } else {
                    resultDiv.className = 'error-box';
                    resultDiv.innerHTML = `<strong>âŒ é”™è¯¯ï¼š</strong> ${data.error}`;
                }
            } catch (error) {
                resultDiv.className = 'error-box';
                resultDiv.innerHTML = `<strong>âŒ è¯·æ±‚å¤±è´¥ï¼š</strong> ${error.message}`;
            }
        }

        // Load results
        async function loadResults() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '<div style="text-align: center;"><div class="loading"></div> åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/saved`);
                const data = await response.json();

                if (data.success && data.data) {
                    const d = data.data;
                    allEntities = d.entities || [];

                    // Populate room filter
                    const roomFilter = document.getElementById('filterRoomName');
                    const rooms = [...new Set(allEntities.map(e => e.room_name).filter(r => r))];
                    roomFilter.innerHTML = '<option value="">æ‰€æœ‰æˆ¿é—´</option>' +
                        rooms.map(room => `<option value="${room}">${room}</option>`).join('');

                    // Summary
                    let html = `
                        <div class="info-box">
                            <h3>ğŸ“Š æ•°æ®æ‘˜è¦</h3>
                            <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                <li><strong>è§¦å‘æ—¶é—´:</strong> ${d.triggered_at ? new Date(d.triggered_at).toLocaleString('zh-CN') : 'æœªè¿è¡Œ'}</li>
                                <li><strong>è§¦å‘æ¥æº:</strong> ${getTriggerSourceText(d.trigger_source)}</li>
                                <li><strong>AI æä¾›å•†:</strong> ${d.provider || '-'}</li>
                                <li><strong>å®ä½“æ€»æ•°:</strong> ${d.count || 0}</li>
                                <li><strong>æ¥¼å±‚:</strong> ${d.floors ? d.floors.join(', ') : '-'}</li>
                                <li><strong>æˆ¿é—´:</strong> ${d.rooms ? d.rooms.join(', ') : '-'}</li>
                            </ul>
                        </div>
                    `;

                    container.innerHTML = html;

                    // Apply initial filter and show first page
                    applyFilters();

                } else {
                    container.innerHTML = '<div class="warning-box"><strong>âš ï¸ æš‚æ— æ•°æ®</strong><br>è¯·å…ˆè¿è¡Œå·¥ä½œæµç”Ÿæˆæ•°æ®ã€‚</div>';
                    document.getElementById('paginationContainer').classList.add('hidden');
                }
            } catch (error) {
                container.innerHTML = `<div class="error-box"><strong>âŒ åŠ è½½å¤±è´¥ï¼š</strong> ${error.message}</div>`;
                document.getElementById('paginationContainer').classList.add('hidden');
            }
        }

        // Apply filters
        function applyFilters() {
            const entityIdFilter = document.getElementById('filterEntityId').value.toLowerCase();
            const roomFilter = document.getElementById('filterRoomName').value;

            filteredEntities = allEntities.filter(entity => {
                const matchEntityId = !entityIdFilter || entity.entity_id.toLowerCase().includes(entityIdFilter);
                const matchRoom = !roomFilter || entity.room_name === roomFilter;
                return matchEntityId && matchRoom;
            });

            currentPage = 1;
            displayEntities();
        }

        // Display entities for current page
        function displayEntities() {
            const container = document.getElementById('resultsContainer');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageEntities = filteredEntities.slice(start, end);

            if (filteredEntities.length === 0) {
                const summaryDiv = container.querySelector('.info-box');
                container.innerHTML = summaryDiv ? summaryDiv.outerHTML : '';
                container.innerHTML += '<div class="warning-box"><strong>âš ï¸ æ²¡æœ‰åŒ¹é…çš„å®ä½“</strong></div>';
                document.getElementById('paginationContainer').classList.add('hidden');
                return;
            }

            // Keep summary
            const summaryDiv = container.querySelector('.info-box');
            let html = summaryDiv ? summaryDiv.outerHTML : '';

            html += `
                <h3 style="margin-top: 1.5rem;">
                    ğŸ  å¢å¼ºå®ä½“åˆ—è¡¨ (æ˜¾ç¤º ${start + 1}-${Math.min(end, filteredEntities.length)} / å…± ${filteredEntities.length} ä¸ª)
                </h3>
            `;

            pageEntities.forEach(entity => {
                const jsonHtml = syntaxHighlightJson(entity);

                html += `
                    <div class="entity-card">
                        <div class="entity-header">
                            <div class="entity-id">${entity.entity_id}</div>
                            <div class="entity-badges">
                                ${entity.state ? `<span class="status-badge status-success">çŠ¶æ€: ${entity.state}</span>` : ''}
                                ${entity.domain ? `<span class="status-badge" style="background: var(--info); color: white;">${entity.domain}</span>` : ''}
                            </div>
                        </div>
                        <div class="code-block" style="max-height: 500px; overflow-y: auto; white-space: pre;">
${jsonHtml}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Update pagination
            const totalPages = Math.ceil(filteredEntities.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
            document.getElementById('paginationContainer').classList.remove('hidden');
        }

        // Pagination controls
        function nextPage() {
            const totalPages = Math.ceil(filteredEntities.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayEntities();
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayEntities();
            }
        }

        // Syntax highlighting for JSON
        function syntaxHighlightJson(obj) {
            const json = JSON.stringify(obj, null, 2);

            return json
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    let cls = 'json-number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'json-key';
                        } else {
                            cls = 'json-string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'json-boolean';
                    } else if (/null/.test(match)) {
                        cls = 'json-null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
        }

        // Add event listeners for filters
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('filterEntityId').addEventListener('input', applyFilters);
            document.getElementById('filterRoomName').addEventListener('change', applyFilters);
        });

        // Initialize on page load
        init();
    </script>
</body>
</html>
